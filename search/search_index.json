{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Sommelier DB Open source DB with public-key searchable encryption: discerning encrypted data without knowing the contents, just like a sommelier! Overview of Sommelier DB Sommelier DB is an open source DB library combining SQLite and public-key searchable encryption (PKSE) . In addition to existing SQLite features, it provides functions for PKSE as below. A new SQL function to test a keyword encryption of the PKSE scheme. C and Rust functions to generate a keyword encryption and a trapdoor of the PKSE scheme. The above functions allow users to have the database (DB) server search for appropriate records in the DB without revealing their search criteria . For more detail about Sommelier DB, see here . Overview of Sommelier Drive Sommelier Drive is a remote file system developed as the first application of Sommelier DB. Its stored files and their file paths are encrypted with the public key of the legitimate user who has read permission to the file. Therefore, other users who do not have the read permission or the administrator of the server hosting the file system cannot know what files exist and where they are located . Furthermore, the legitimate users can generate trapdoors using the user's private key, allowing the server to search for the appropriate file without revealing the search criteria. This is a demo movie of the glibc client for Sommelier Drive! Its detailed specifications are available here . Disclaimer DO NOT USE THIS LIBRARY IN PRODUCTION . At this point, this is under development. It has known and unknown bugs and security flaws. Quick Links Sommelier DB implementation Server implementation of Sommelier Drive Client implementation of Sommelier Drive Glibc client implementation of Sommelier Drive PKSE implementation written in Rust Acknowledgments The logo illustration for Sommelier DB was provided by Kirari Suegami in 2022.","title":"Home"},{"location":"#sommelier-db","text":"Open source DB with public-key searchable encryption: discerning encrypted data without knowing the contents, just like a sommelier!","title":"Sommelier DB"},{"location":"#overview-of-sommelier-db","text":"Sommelier DB is an open source DB library combining SQLite and public-key searchable encryption (PKSE) . In addition to existing SQLite features, it provides functions for PKSE as below. A new SQL function to test a keyword encryption of the PKSE scheme. C and Rust functions to generate a keyword encryption and a trapdoor of the PKSE scheme. The above functions allow users to have the database (DB) server search for appropriate records in the DB without revealing their search criteria . For more detail about Sommelier DB, see here .","title":"Overview of Sommelier DB"},{"location":"#overview-of-sommelier-drive","text":"Sommelier Drive is a remote file system developed as the first application of Sommelier DB. Its stored files and their file paths are encrypted with the public key of the legitimate user who has read permission to the file. Therefore, other users who do not have the read permission or the administrator of the server hosting the file system cannot know what files exist and where they are located . Furthermore, the legitimate users can generate trapdoors using the user's private key, allowing the server to search for the appropriate file without revealing the search criteria. This is a demo movie of the glibc client for Sommelier Drive! Its detailed specifications are available here .","title":"Overview of Sommelier Drive"},{"location":"#disclaimer","text":"DO NOT USE THIS LIBRARY IN PRODUCTION . At this point, this is under development. It has known and unknown bugs and security flaws.","title":"Disclaimer"},{"location":"#quick-links","text":"Sommelier DB implementation Server implementation of Sommelier Drive Client implementation of Sommelier Drive Glibc client implementation of Sommelier Drive PKSE implementation written in Rust","title":"Quick Links"},{"location":"#acknowledgments","text":"The logo illustration for Sommelier DB was provided by Kirari Suegami in 2022.","title":"Acknowledgments"},{"location":"blog/db_speed_up/","text":"Author: Takaki Hamada Speed Up SQL Processing in Sommelier Drive Server. In Sommelier Drive Server , the data processed by Drive are including huge encrypted contents, such as PKSE cipher text. Therefore, when executing multiple INSERT query, the Sommelier DB processing became very slow and Drive command processing took more than a minute. To resolve this problem, I customized the issuing of transactions in SQL query. Management Transaction in Sommelier Drive Server. In Sommelier DB (and SQLite3 it is copied from) INSERT query, transaction management execute internaly per query. So, when adding multiple rows into table at once, programer should manage the DB transaction manually and execute several INSERT query in one transaction to speed up DB processing. At the implementation of Sommelier Drive Server , speed up processing by managing the TRANSACTION to be COMMIT and BEGIN again every 10 INSERT queries issued. An example of controlling TRANSACTION in C API is implemented at sommelier-drive-server/src/dbms.c .","title":"Speed up multiple INSERT queries in Sommelier Drive Server, using TRANSACTION"},{"location":"blog/db_speed_up/#author-takaki-hamada","text":"","title":"Author: Takaki Hamada"},{"location":"blog/db_speed_up/#speed-up-sql-processing-in-sommelier-drive-server","text":"In Sommelier Drive Server , the data processed by Drive are including huge encrypted contents, such as PKSE cipher text. Therefore, when executing multiple INSERT query, the Sommelier DB processing became very slow and Drive command processing took more than a minute. To resolve this problem, I customized the issuing of transactions in SQL query.","title":"Speed Up SQL Processing in Sommelier Drive Server."},{"location":"blog/db_speed_up/#management-transaction-in-sommelier-drive-server","text":"In Sommelier DB (and SQLite3 it is copied from) INSERT query, transaction management execute internaly per query. So, when adding multiple rows into table at once, programer should manage the DB transaction manually and execute several INSERT query in one transaction to speed up DB processing. At the implementation of Sommelier Drive Server , speed up processing by managing the TRANSACTION to be COMMIT and BEGIN again every 10 INSERT queries issued. An example of controlling TRANSACTION in C API is implemented at sommelier-drive-server/src/dbms.c .","title":"Management Transaction in Sommelier Drive Server."},{"location":"blog/pkse/","text":"Author: Sora Suegami In this post, I describe how we implemented our new PKSE library . As described in its README.md, our library provides Public-key encryption with conjunctive and disjunctive keyword search (PECDK) [1] as an underlying scheme. The PECDK supports conjunction and disjunction of multiple keywords as search criteria, which is rather expressive in the research field of public-key searchable encryption (PKSE). However, to provide the same level of functionality as SQL, more complex search criteria need to be addressed. We filled this gap without implementing new PKSE schemes by devising how to construct the keywords to be encrypted in the PECDK scheme. Specifically, our library supports prefix and range search. The former encrypts a string and retrieves the encryption whose string has the specified prefix, and the latter encrypts an unsigned integer and retrieves the encryption whose integer is within the specified range. In the following, I explain those background designs and implementations. Prefix search In the prefix search, a string is decomposed into bytes, and a pair of each byte and its index forms a single keyword. For example, a string \"abcde\" will be keywords [(0,\"a\"), (1, \"b\"), (2,\"c\"), (3,\"d\"), (4, \"e\")] . In our library, this keyword construction is implemented in Rust as below. 1 2 3 4 5 6 7 8 9 10 11 let mut keywords = bytes .into_iter() .enumerate() .map(|(idx, byte)| { concat_multi_bytes(vec![ region_name.as_bytes(), &idx.to_be_bytes(), &vec![1u8, *byte], ]) }) .collect::<Vec<Vec<u8>>>(); The variable idx and byte represent the index and the byte, respectively. The region_name is a fixed, application-specific string used to distinguish the same string encrypted for different applications. The byte 1 is also necessary to distinguish an empty keyword, namely all-zero bytes. The function concat_multi_bytes concats all of the given bytes. In this way, with minor exceptions, our implementation is consistent with the above description. The trapdoor for the prefix search is for a conjunction of keywords derived from a prefix string. For instance, the trapdoor for the prefix \"abc\" corresponds to the conjunction of keywords [(0,\"a\"), (1, \"b\"), (2,\"c\")] . Since the keywords of string with that prefix should include the same keywords, the trapdoor can match the appropriate string encryptions with the PECDK scheme. Range search The range search is more complex than the prefix search, but more interesting! Our first idea for the range search is to divide the entire range of integers into certain smaller ranges and encrypt the range containing the\u3000target integer as keyword. As an example, consider an integer \\(x\\) within the range \\([0, 50)\\) . We first divide that entire range into ranges of size 10, i.e., \\([0,10), [10,20), [20,30), [30,40), [40,50)\\) . The encryption of \\(x=15\\) will be the encryption of the keyword \\([10,20)\\) as \\(x \\in [10, 20)\\) holds. The trapdoor for the itenger within the range \\([10,30)\\) will correspond to a disjunction of keywords \\([10,20), [20,30)\\) . Although the above approach is easy to implement, it has two downsides. It cannot cover an exponentially-large range. It cannot generate a trapdoor for a range whose size is not a multiple of the size of the divided range (e.g., 10 in the above example). To overcome them, we adopt an approach proposed in [2]. In a nutshell, it constructs a binary tree corresponding to the entire range and encrypts a node of each height as a keyword. For example, for an 4-bit integer \\(x\\) , the following binary tree is considered. The encryption of \\(9=1001_2\\) will be for the keywords \\(((1, 1_2), (2, 10_2), (3, 100_2), (4, 1001_1))\\) . Notably, the number of keywords to be encrypted is only \\(t\\) for the exponentially-large range \\([0,2^t)\\) in this scheme! The trapdoor is generated for the disjunction of the nodes that cover all leafs within the specified range. In the above example, nodes \\((0101_2, 011_2, 10_2, 110_2)\\) covers all leafs within the range \\([0101_2, 1101_2]\\) , i.e., \\([5, 13]\\) . It implies that the integer within that range should have at least one of the nodes \\((0101_2, 011_2, 10_2, 110_2)\\) . Therefore, the disjunction of these nodes matches the appropriate integer encryption. Furthermore, there are no restrictions as in our initial idea regarding the position and size of the range to be specified. However, the minimum set of cover nodes is not sufficient to protect the privacy of search criteria because its size is not consistent for two different ranges with the same size. (E.g., the range \\([0,8]\\) has the same size with \\([5, 13]\\) , but its minimum set of cover nodes is just two nodes, namely \\((0_2, 1000_2)\\) !) The author of [2] solves this problem by considering a \"minimal universal cover [2]\", which is \"a cover with a number of nodes and depths that is the same for any two ranges of the same size [2]\". Such cover nodes leaks only the size of the specified range. Our implementation produces it following the procedures in Appendix A of [2], as below. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 fn get_canonical_cover_nodes(min: u64, max: u64, bit_size: usize) -> HashSet<Vec<bool>> { let n1 = max - min + 1; let l = (n1 as f64 + 1.0).log2().floor() as usize; let n2 = n1 + 1 - (1 << l); let mut nodes = HashSet::new(); let mut allowed_lens = HashMultiSet::new(); for i in 0..l { allowed_lens.insert(bit_size - i); } let n2_bits = uint2bits(n2, bit_size); for (i, bit) in n2_bits.into_iter().rev().enumerate() { if bit { allowed_lens.insert(bit_size - i); } } let mut min = min; while !allowed_lens.is_empty() { let next_node = get_canonical_next_max(min, max, bit_size, &allowed_lens); min = compute_max_uint(&next_node, bit_size) + 1; allowed_lens.remove(&next_node.len()); nodes.insert(next_node); } nodes } fn get_canonical_next_max( min: u64, max: u64, bit_size: usize, allowed_lens: &HashMultiSet<usize>, ) -> Vec<bool> { let mut bits_pattern = uint2bits(min, bit_size); let min_size_in_set = *allowed_lens.iter().min().unwrap(); while bits_pattern.len() >= 2 && (compute_min_uint(&bits_pattern[0..bits_pattern.len() - 1], bit_size) >= min) && (compute_max_uint(&bits_pattern[0..bits_pattern.len() - 1], bit_size) <= max) && (allowed_lens.contains(&(bits_pattern.len() - 1)) || bits_pattern.len() - 1 >= min_size_in_set) { bits_pattern.pop(); } bits_pattern } fn compute_min_uint(bits: &[bool], bit_size: usize) -> u64 { let mut min_bits = bits.to_vec(); min_bits.append(&mut vec![false; bit_size - bits.len()]); bits2uint(&min_bits) } In this way, we can effectively perform the range search without revealing information about the range other than its size. Reference Zhang, Y., Li, Y., & Wang, Y. (2019). Secure and efficient searchable public key encryption for resource constrained environment based on pairings under prime order group. Security and Communication Networks, 2019. Faber, S., Jarecki, S., Krawczyk, H., Nguyen, Q., Rosu, M., & Steiner, M. (2015, September). Rich queries on encrypted data: Beyond exact matches. In European symposium on research in computer security (pp. 123-145). Springer, Cham.","title":"How we implemented expressive search criteria with minimum effort."},{"location":"blog/pkse/#author-sora-suegami","text":"In this post, I describe how we implemented our new PKSE library . As described in its README.md, our library provides Public-key encryption with conjunctive and disjunctive keyword search (PECDK) [1] as an underlying scheme. The PECDK supports conjunction and disjunction of multiple keywords as search criteria, which is rather expressive in the research field of public-key searchable encryption (PKSE). However, to provide the same level of functionality as SQL, more complex search criteria need to be addressed. We filled this gap without implementing new PKSE schemes by devising how to construct the keywords to be encrypted in the PECDK scheme. Specifically, our library supports prefix and range search. The former encrypts a string and retrieves the encryption whose string has the specified prefix, and the latter encrypts an unsigned integer and retrieves the encryption whose integer is within the specified range. In the following, I explain those background designs and implementations.","title":"Author: Sora Suegami"},{"location":"blog/pkse/#prefix-search","text":"In the prefix search, a string is decomposed into bytes, and a pair of each byte and its index forms a single keyword. For example, a string \"abcde\" will be keywords [(0,\"a\"), (1, \"b\"), (2,\"c\"), (3,\"d\"), (4, \"e\")] . In our library, this keyword construction is implemented in Rust as below. 1 2 3 4 5 6 7 8 9 10 11 let mut keywords = bytes .into_iter() .enumerate() .map(|(idx, byte)| { concat_multi_bytes(vec![ region_name.as_bytes(), &idx.to_be_bytes(), &vec![1u8, *byte], ]) }) .collect::<Vec<Vec<u8>>>(); The variable idx and byte represent the index and the byte, respectively. The region_name is a fixed, application-specific string used to distinguish the same string encrypted for different applications. The byte 1 is also necessary to distinguish an empty keyword, namely all-zero bytes. The function concat_multi_bytes concats all of the given bytes. In this way, with minor exceptions, our implementation is consistent with the above description. The trapdoor for the prefix search is for a conjunction of keywords derived from a prefix string. For instance, the trapdoor for the prefix \"abc\" corresponds to the conjunction of keywords [(0,\"a\"), (1, \"b\"), (2,\"c\")] . Since the keywords of string with that prefix should include the same keywords, the trapdoor can match the appropriate string encryptions with the PECDK scheme.","title":"Prefix search"},{"location":"blog/pkse/#range-search","text":"The range search is more complex than the prefix search, but more interesting! Our first idea for the range search is to divide the entire range of integers into certain smaller ranges and encrypt the range containing the\u3000target integer as keyword. As an example, consider an integer \\(x\\) within the range \\([0, 50)\\) . We first divide that entire range into ranges of size 10, i.e., \\([0,10), [10,20), [20,30), [30,40), [40,50)\\) . The encryption of \\(x=15\\) will be the encryption of the keyword \\([10,20)\\) as \\(x \\in [10, 20)\\) holds. The trapdoor for the itenger within the range \\([10,30)\\) will correspond to a disjunction of keywords \\([10,20), [20,30)\\) . Although the above approach is easy to implement, it has two downsides. It cannot cover an exponentially-large range. It cannot generate a trapdoor for a range whose size is not a multiple of the size of the divided range (e.g., 10 in the above example). To overcome them, we adopt an approach proposed in [2]. In a nutshell, it constructs a binary tree corresponding to the entire range and encrypts a node of each height as a keyword. For example, for an 4-bit integer \\(x\\) , the following binary tree is considered. The encryption of \\(9=1001_2\\) will be for the keywords \\(((1, 1_2), (2, 10_2), (3, 100_2), (4, 1001_1))\\) . Notably, the number of keywords to be encrypted is only \\(t\\) for the exponentially-large range \\([0,2^t)\\) in this scheme! The trapdoor is generated for the disjunction of the nodes that cover all leafs within the specified range. In the above example, nodes \\((0101_2, 011_2, 10_2, 110_2)\\) covers all leafs within the range \\([0101_2, 1101_2]\\) , i.e., \\([5, 13]\\) . It implies that the integer within that range should have at least one of the nodes \\((0101_2, 011_2, 10_2, 110_2)\\) . Therefore, the disjunction of these nodes matches the appropriate integer encryption. Furthermore, there are no restrictions as in our initial idea regarding the position and size of the range to be specified. However, the minimum set of cover nodes is not sufficient to protect the privacy of search criteria because its size is not consistent for two different ranges with the same size. (E.g., the range \\([0,8]\\) has the same size with \\([5, 13]\\) , but its minimum set of cover nodes is just two nodes, namely \\((0_2, 1000_2)\\) !) The author of [2] solves this problem by considering a \"minimal universal cover [2]\", which is \"a cover with a number of nodes and depths that is the same for any two ranges of the same size [2]\". Such cover nodes leaks only the size of the specified range. Our implementation produces it following the procedures in Appendix A of [2], as below. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 fn get_canonical_cover_nodes(min: u64, max: u64, bit_size: usize) -> HashSet<Vec<bool>> { let n1 = max - min + 1; let l = (n1 as f64 + 1.0).log2().floor() as usize; let n2 = n1 + 1 - (1 << l); let mut nodes = HashSet::new(); let mut allowed_lens = HashMultiSet::new(); for i in 0..l { allowed_lens.insert(bit_size - i); } let n2_bits = uint2bits(n2, bit_size); for (i, bit) in n2_bits.into_iter().rev().enumerate() { if bit { allowed_lens.insert(bit_size - i); } } let mut min = min; while !allowed_lens.is_empty() { let next_node = get_canonical_next_max(min, max, bit_size, &allowed_lens); min = compute_max_uint(&next_node, bit_size) + 1; allowed_lens.remove(&next_node.len()); nodes.insert(next_node); } nodes } fn get_canonical_next_max( min: u64, max: u64, bit_size: usize, allowed_lens: &HashMultiSet<usize>, ) -> Vec<bool> { let mut bits_pattern = uint2bits(min, bit_size); let min_size_in_set = *allowed_lens.iter().min().unwrap(); while bits_pattern.len() >= 2 && (compute_min_uint(&bits_pattern[0..bits_pattern.len() - 1], bit_size) >= min) && (compute_max_uint(&bits_pattern[0..bits_pattern.len() - 1], bit_size) <= max) && (allowed_lens.contains(&(bits_pattern.len() - 1)) || bits_pattern.len() - 1 >= min_size_in_set) { bits_pattern.pop(); } bits_pattern } fn compute_min_uint(bits: &[bool], bit_size: usize) -> u64 { let mut min_bits = bits.to_vec(); min_bits.append(&mut vec![false; bit_size - bits.len()]); bits2uint(&min_bits) } In this way, we can effectively perform the range search without revealing information about the range other than its size.","title":"Range search"},{"location":"blog/pkse/#reference","text":"Zhang, Y., Li, Y., & Wang, Y. (2019). Secure and efficient searchable public key encryption for resource constrained environment based on pairings under prime order group. Security and Communication Networks, 2019. Faber, S., Jarecki, S., Krawczyk, H., Nguyen, Q., Rosu, M., & Steiner, M. (2015, September). Rich queries on encrypted data: Beyond exact matches. In European symposium on research in computer security (pp. 123-145). Springer, Cham.","title":"Reference"},{"location":"db/apis/","text":"Author: Takaki Hamada APIs detail. Sommelier DB APIs are constructed from, APIs derived from SQLite3. Sommelier DB Specific SQL function: test_cipher These are described at following sections. APIs derived from SQLite3 The SQLite3's API manual is here . When you want to process basic SQL queries, you should call the fucntions included this API. such as sqlite3_exec . At next section, it is explaining the APIs used in Sommelier Drive Server Database Subroutine . Commonly used API of SQLite3: sqlite3_exec If you execute SQL queries in C source code, you can use sqlite3_exec function . This function recieves not only char pointer stored a SQL query, but also a callback function, which is processing a SQL result line by line, and a void pointer, which can be accessed from callback function. So, we can define arbitary processing routine for SQL execution result row. Sommelier DB Specific SQL function: test_cipher When you search specific token with PKSE for the ciphertexts of SQL result, you call test_cipher SQL function in the SQL query. This SQL function recieves a ciphertext by PKSE and a trapdoor words, and it returns the integer 1 (This means searching result is True) or 0 (Result is False). For example as following SQL code block, you can call this function with SELECT statement, and you can get PKSE search results. 1 2 3 -- `Table` is defined as `Table (id INT, name TEXT, cipher TEXT)` SELECT id , name from Table where test_cipher ( cipher , trapdoor ) == 1 ;","title":"APIs"},{"location":"db/apis/#author-takaki-hamada","text":"","title":"Author: Takaki Hamada"},{"location":"db/apis/#apis-detail","text":"Sommelier DB APIs are constructed from, APIs derived from SQLite3. Sommelier DB Specific SQL function: test_cipher These are described at following sections.","title":"APIs detail."},{"location":"db/apis/#apis-derived-from-sqlite3","text":"The SQLite3's API manual is here . When you want to process basic SQL queries, you should call the fucntions included this API. such as sqlite3_exec . At next section, it is explaining the APIs used in Sommelier Drive Server Database Subroutine .","title":"APIs derived from SQLite3"},{"location":"db/apis/#commonly-used-api-of-sqlite3-sqlite3_exec","text":"If you execute SQL queries in C source code, you can use sqlite3_exec function . This function recieves not only char pointer stored a SQL query, but also a callback function, which is processing a SQL result line by line, and a void pointer, which can be accessed from callback function. So, we can define arbitary processing routine for SQL execution result row.","title":"Commonly used API of SQLite3: sqlite3_exec"},{"location":"db/apis/#sommelier-db-specific-sql-function-test_cipher","text":"When you search specific token with PKSE for the ciphertexts of SQL result, you call test_cipher SQL function in the SQL query. This SQL function recieves a ciphertext by PKSE and a trapdoor words, and it returns the integer 1 (This means searching result is True) or 0 (Result is False). For example as following SQL code block, you can call this function with SELECT statement, and you can get PKSE search results. 1 2 3 -- `Table` is defined as `Table (id INT, name TEXT, cipher TEXT)` SELECT id , name from Table where test_cipher ( cipher , trapdoor ) == 1 ;","title":"Sommelier DB Specific SQL function: test_cipher"},{"location":"db/get_started/","text":"Author: Takaki Hamada Install Sommelier DB The installing scripts of Sommelier DB is constructed by configure and make . Detail installing method is described at README of Sommelier DB . Use Sommelier DB CUI client When you execute your installed binary path, you can access the CLI SQLite Interface. In this interface, you can use SQLite's DBMS functions and Sommelier DB's original SQL function test_cipher . The test_cipher function's specification is described in APIs page. Use Sommelier DB C API Sommelier DB is based on SQLite3 C API source code . If you want to control Sommelier DB by source code of C, you can access Sommelier DB C API in the same way as SQLite3 C API. In particular, you should do the following tasks. Install Sommelier DB in the way descirbed above. Add #include \"#sommelier-db.h\" in your header file. (you will be able to use sqlite* interface and SQL function test_cipher , that is used searching data by PKSE) Add compile options: -I</path/to/sommelier-db/include> -L</path/to/sommelier-db/lib> -lsommelier-db . Sommelier Drive Server implementation is one of examples to use \"Sommelier DB C API\" and to add \"C compile options\".","title":"Get Started"},{"location":"db/get_started/#author-takaki-hamada","text":"","title":"Author: Takaki Hamada"},{"location":"db/get_started/#install-sommelier-db","text":"The installing scripts of Sommelier DB is constructed by configure and make . Detail installing method is described at README of Sommelier DB .","title":"Install Sommelier DB"},{"location":"db/get_started/#use-sommelier-db-cui-client","text":"When you execute your installed binary path, you can access the CLI SQLite Interface. In this interface, you can use SQLite's DBMS functions and Sommelier DB's original SQL function test_cipher . The test_cipher function's specification is described in APIs page.","title":"Use Sommelier DB CUI client"},{"location":"db/get_started/#use-sommelier-db-c-api","text":"Sommelier DB is based on SQLite3 C API source code . If you want to control Sommelier DB by source code of C, you can access Sommelier DB C API in the same way as SQLite3 C API. In particular, you should do the following tasks. Install Sommelier DB in the way descirbed above. Add #include \"#sommelier-db.h\" in your header file. (you will be able to use sqlite* interface and SQL function test_cipher , that is used searching data by PKSE) Add compile options: -I</path/to/sommelier-db/include> -L</path/to/sommelier-db/lib> -lsommelier-db . Sommelier Drive Server implementation is one of examples to use \"Sommelier DB C API\" and to add \"C compile options\".","title":"Use Sommelier DB C API"},{"location":"db/how_it_works/","text":"Author: Takaki Hamada how to add original function like test_cipher In the SQLite3 implementations, it converts input SQL query into bytecode. And, SQLite3 executes compiled byteode on VDBE (Vertual DataBase Engine) , that is vertual machine manipulates table row data on B-Tree. By this vertual machine, the function calling query is processed as Function Opecode . There are a function sqlite3RegisterBuiltinFunction and a macro TEST_FUNC , which are used to define the Function Opecode (e.g. length, max, min...). To realize PKSE searching function, we defined the operation of test_cipher and called TEST_FUNC in sqlite3RegisterBuiltinFunction . Our test_cipher implementation is here .","title":"How it works"},{"location":"db/how_it_works/#author-takaki-hamada","text":"","title":"Author: Takaki Hamada"},{"location":"db/how_it_works/#how-to-add-original-function-like-test_cipher","text":"In the SQLite3 implementations, it converts input SQL query into bytecode. And, SQLite3 executes compiled byteode on VDBE (Vertual DataBase Engine) , that is vertual machine manipulates table row data on B-Tree. By this vertual machine, the function calling query is processed as Function Opecode . There are a function sqlite3RegisterBuiltinFunction and a macro TEST_FUNC , which are used to define the Function Opecode (e.g. length, max, min...). To realize PKSE searching function, we defined the operation of test_cipher and called TEST_FUNC in sqlite3RegisterBuiltinFunction . Our test_cipher implementation is here .","title":"how to add original function like test_cipher"},{"location":"db/intro/","text":"Author: Sora Suegami Today's databases lack security. Databases (DBs) play a significant role in today's Internet-based services. For example, online search services manage the data to be searched in a DB, which can be retrieved efficiently according to the user's request. However, the more data stored in a DB, the more serious the damage of data leakage if that DB is attacked. Notably, this is not a theoretical concern, but a real issue. In fact, it is estimated that popular Internet-based services, e.g., Yahoo, Facebook, and LinkedIn, have leaked over 100 million records [1]. From these cases, we believe that we need a solution that can protect the data confidentiality even if data is leaked from the DB . How public-key searchable encryption establishes both the convenience and security of databases. A primitive solution to the above problem is to encrypt all data in the DB so that its contents cannot be known by an adversary who attacks the DB. However, it would compromise the convenience of the DB because the server hosting the DB cannot search for the requested data. We establish both the convenience and security by encrypting the data by public-key searchable encryption (PKSE) . PKSE has the same features as standard public-key encryption schemes, e.g., RSA encryption scheme, except that the private key holder can allow a third party to test whether the encrypted data satisfies some search criteria, without revealing the data and the search criteria [2]. In more detail, a user who wishes to search for data first generates a pair of private and public keys. The public key is made available to a data provider who provides some data. The data provider encrypts the data with the user's public key and stores only the encryption on the DB server. The user then generates data corresponding to the user's search criteria, called trapdoor , and sends it to the DB server; the DB server can learn little information from the trapdoor. Since the DB server only receives the encryption and the trapdoor, it can protect the data confidentiality from an adversary who have access to all data in the DB, as well as from a malicious administrator of that server. Furthermore, the server can retrieve the encryption of the requested data using a test algorithm of the PKSE scheme. Formally, that algorithm takes as input encrypted data and a trapdoor and outputs 1 if the data satisfies the search criteria for the provided trapdoor and 0 otherwise . The server applies it to all candidate ciphertexts with the provided trapdoor and returns to the user only those for which it returns 1. In this way, the user can have the DB server search for apposite data as before. Sommelier DB: the world's first open source database based on public-key searchable encryption. Following the approach described above, we propose a new PKSE-based DB library, Sommelier DB. While the PKSE-based DB has been considered in various studies [2-5], as far as our knowledge there are no open source implementations other than ours. Sommelier DB is a fork of SQLite: it adds the following two functions: A new SQL function for the test algorithm of the PKSE scheme. C and Rust functions to generate a keyword encryption and a trapdoor of the PKSE scheme. These functions allow you to enjoy the benefits of PKSE without understanding how it works! Reference Todd, D. (2022, September). Top 10 Data Breaches of All Time, SecureWorld. https://www.secureworld.io/industry-news/top-10-data-breaches-of-all-time, (Accessed on 10/27/2022). Boneh, D., Crescenzo, G. D., Ostrovsky, R., & Persiano, G. (2004, May). Public key encryption with keyword search. In International conference on the theory and applications of cryptographic techniques (pp. 506-522). Springer, Berlin, Heidelberg. Matsuda, N., Hirano, T., Kawai, Y., Ito, T., Hattori, M., Yamanaka, T., & Nishigaki, M. (2020). Public-key Searchable Encryption with Index Generation for Shared Database. Journal of Information Processing, 28, 520-536. Wang, Z., Chen, B., Xiang, T., Zhou, L., Yan, H., & Li, J. (2021, November). Public Key Based Searchable Encryption with Fine-Grained Sender Permission Control. In International Conference on Provable Security (pp. 3-18). Springer, Cham. Prasanna, B. T., & Akki, C. B. (2015). A comparative study of homomorphic and searchable encryption schemes for cloud computing. arXiv preprint arXiv:1505.03263.","title":"Introduction"},{"location":"db/intro/#author-sora-suegami","text":"","title":"Author: Sora Suegami"},{"location":"db/intro/#todays-databases-lack-security","text":"Databases (DBs) play a significant role in today's Internet-based services. For example, online search services manage the data to be searched in a DB, which can be retrieved efficiently according to the user's request. However, the more data stored in a DB, the more serious the damage of data leakage if that DB is attacked. Notably, this is not a theoretical concern, but a real issue. In fact, it is estimated that popular Internet-based services, e.g., Yahoo, Facebook, and LinkedIn, have leaked over 100 million records [1]. From these cases, we believe that we need a solution that can protect the data confidentiality even if data is leaked from the DB .","title":"Today's databases lack security."},{"location":"db/intro/#how-public-key-searchable-encryption-establishes-both-the-convenience-and-security-of-databases","text":"A primitive solution to the above problem is to encrypt all data in the DB so that its contents cannot be known by an adversary who attacks the DB. However, it would compromise the convenience of the DB because the server hosting the DB cannot search for the requested data. We establish both the convenience and security by encrypting the data by public-key searchable encryption (PKSE) . PKSE has the same features as standard public-key encryption schemes, e.g., RSA encryption scheme, except that the private key holder can allow a third party to test whether the encrypted data satisfies some search criteria, without revealing the data and the search criteria [2]. In more detail, a user who wishes to search for data first generates a pair of private and public keys. The public key is made available to a data provider who provides some data. The data provider encrypts the data with the user's public key and stores only the encryption on the DB server. The user then generates data corresponding to the user's search criteria, called trapdoor , and sends it to the DB server; the DB server can learn little information from the trapdoor. Since the DB server only receives the encryption and the trapdoor, it can protect the data confidentiality from an adversary who have access to all data in the DB, as well as from a malicious administrator of that server. Furthermore, the server can retrieve the encryption of the requested data using a test algorithm of the PKSE scheme. Formally, that algorithm takes as input encrypted data and a trapdoor and outputs 1 if the data satisfies the search criteria for the provided trapdoor and 0 otherwise . The server applies it to all candidate ciphertexts with the provided trapdoor and returns to the user only those for which it returns 1. In this way, the user can have the DB server search for apposite data as before.","title":"How public-key searchable encryption establishes both the convenience and security of databases."},{"location":"db/intro/#sommelier-db-the-worlds-first-open-source-database-based-on-public-key-searchable-encryption","text":"Following the approach described above, we propose a new PKSE-based DB library, Sommelier DB. While the PKSE-based DB has been considered in various studies [2-5], as far as our knowledge there are no open source implementations other than ours. Sommelier DB is a fork of SQLite: it adds the following two functions: A new SQL function for the test algorithm of the PKSE scheme. C and Rust functions to generate a keyword encryption and a trapdoor of the PKSE scheme. These functions allow you to enjoy the benefits of PKSE without understanding how it works!","title":"Sommelier DB: the world's first open source database based on public-key searchable encryption."},{"location":"db/intro/#reference","text":"Todd, D. (2022, September). Top 10 Data Breaches of All Time, SecureWorld. https://www.secureworld.io/industry-news/top-10-data-breaches-of-all-time, (Accessed on 10/27/2022). Boneh, D., Crescenzo, G. D., Ostrovsky, R., & Persiano, G. (2004, May). Public key encryption with keyword search. In International conference on the theory and applications of cryptographic techniques (pp. 506-522). Springer, Berlin, Heidelberg. Matsuda, N., Hirano, T., Kawai, Y., Ito, T., Hattori, M., Yamanaka, T., & Nishigaki, M. (2020). Public-key Searchable Encryption with Index Generation for Shared Database. Journal of Information Processing, 28, 520-536. Wang, Z., Chen, B., Xiang, T., Zhou, L., Yan, H., & Li, J. (2021, November). Public Key Based Searchable Encryption with Fine-Grained Sender Permission Control. In International Conference on Provable Security (pp. 3-18). Springer, Cham. Prasanna, B. T., & Akki, C. B. (2015). A comparative study of homomorphic and searchable encryption schemes for cloud computing. arXiv preprint arXiv:1505.03263.","title":"Reference"},{"location":"drive/get_started/","text":"Author: Sora Suegami Requirements To run the server, the following tools are required: Sommelier-DB jasson (json library) To run the client, the following tools are required: rustc 1.65.0-nightly cargo 1.65.0-nightly cbindgen 0.24.3 Setup We open the first terminal for running the server and clone the server repository. 1 2 3 git clone https://github.com/Sommelier-db/sommelier-drive-server cd sommelier-drive-server git submodule update --init --recursive The sommelier-drive-server is built as below: 1 2 make init make We then open the second terminal for running the client CLI and clone the client repository. 1 2 3 git clone https://github.com/Sommelier-db/sommelier-drive-client cd sommelier-drive-client git submodule update --init --recursive The sommelier-drive-client is built by simply executing the build.sh . 1 ./build.sh Operate files with Sommelier Drive! Now, let's operate files with Sommelier Drive! You will notice that the UX of Sommelier Drive is almost the same as existing Unix file systems, which you probably use every day. On the first terminal, we run the server. 1 build/main If there is no issue, the server will stand at the URL http://localhost:8000/api . On the second terminal, we manage the files on that server. While performing the following operations, also look at the first terminal running the server. You can find that no file path or contents appear on the server side! We first create a new user account and creates an initial directory /data1 under the root directory. 1 >> register /data1 We then create a file and a directory under the /data1 . 1 2 >> touch /data1/hello.txt >> mkdir /data1/subdata1 Say hello to Sommelier Drive in the /data1/hello.txt ! 1 2 3 >> cat /data1/hello.txt >> modify /data1/hello.txt Hello,SommelierDrive! >> cat /data1/hello.txt We can check the children files or directories under the /data1 . 1 >> ls /data1 We finally create a file in a deeper location and find them. 1 2 >> touch /data1/subdata1/goodbye.c >> find /data1","title":"Get Started"},{"location":"drive/get_started/#author-sora-suegami","text":"","title":"Author: Sora Suegami"},{"location":"drive/get_started/#requirements","text":"To run the server, the following tools are required: Sommelier-DB jasson (json library) To run the client, the following tools are required: rustc 1.65.0-nightly cargo 1.65.0-nightly cbindgen 0.24.3","title":"Requirements"},{"location":"drive/get_started/#setup","text":"We open the first terminal for running the server and clone the server repository. 1 2 3 git clone https://github.com/Sommelier-db/sommelier-drive-server cd sommelier-drive-server git submodule update --init --recursive The sommelier-drive-server is built as below: 1 2 make init make We then open the second terminal for running the client CLI and clone the client repository. 1 2 3 git clone https://github.com/Sommelier-db/sommelier-drive-client cd sommelier-drive-client git submodule update --init --recursive The sommelier-drive-client is built by simply executing the build.sh . 1 ./build.sh","title":"Setup"},{"location":"drive/get_started/#operate-files-with-sommelier-drive","text":"Now, let's operate files with Sommelier Drive! You will notice that the UX of Sommelier Drive is almost the same as existing Unix file systems, which you probably use every day. On the first terminal, we run the server. 1 build/main If there is no issue, the server will stand at the URL http://localhost:8000/api . On the second terminal, we manage the files on that server. While performing the following operations, also look at the first terminal running the server. You can find that no file path or contents appear on the server side! We first create a new user account and creates an initial directory /data1 under the root directory. 1 >> register /data1 We then create a file and a directory under the /data1 . 1 2 >> touch /data1/hello.txt >> mkdir /data1/subdata1 Say hello to Sommelier Drive in the /data1/hello.txt ! 1 2 3 >> cat /data1/hello.txt >> modify /data1/hello.txt Hello,SommelierDrive! >> cat /data1/hello.txt We can check the children files or directories under the /data1 . 1 >> ls /data1 We finally create a file in a deeper location and find them. 1 2 >> touch /data1/subdata1/goodbye.c >> find /data1","title":"Operate files with Sommelier Drive!"},{"location":"drive/intro/","text":"Author: Sora Suegami Storing files on a remote server without revealing what files exist and where they are located. As the first application of Sommelier DB, we developed a new remote file system, Sommelier Drive. Like existing services, such as Dropbox, Google Drive, and One Drive, files can be stored on a remote server, but the file contents and their file paths are all encrypted. Therefore, even a malicious administrator of that server cannot know what files exist and where they are located . In a nutshell, a data provider who creates a new file, a user who has read permission to that file, and the remote server work as below. The data provider encrypts the file contents and paths with the user's public key and stores their encryptions on the remote server. The user generates a trapdoor of the PKSE scheme with the user's private key and provides it for the remote server. The remote server returns the file contents encryption of which the corresponding file path encryption matches the provided trapdoor. The user decrypts the returned encryption with the user's private key, which results in the file contents. The above scheme may seem almost the same as the Sommelier DB. The difference is that the user's private and public keys consist of those of PKSE and public-key encryption (PKE). The PKSE scheme is used to allow the server to search for files in the requested file path without revealing them. In addition, the PKE scheme is necessary to obtain the file contents because only with the PKSE scheme the user cannot obtain the unknown message from the ciphertext, even if the PKSE private key is available. In other words, Sommelier Drive requires the PKSE and PKE scheme to test and recover the file path and contents, respectively.","title":"Introduction"},{"location":"drive/intro/#author-sora-suegami","text":"","title":"Author: Sora Suegami"},{"location":"drive/intro/#storing-files-on-a-remote-server-without-revealing-what-files-exist-and-where-they-are-located","text":"As the first application of Sommelier DB, we developed a new remote file system, Sommelier Drive. Like existing services, such as Dropbox, Google Drive, and One Drive, files can be stored on a remote server, but the file contents and their file paths are all encrypted. Therefore, even a malicious administrator of that server cannot know what files exist and where they are located . In a nutshell, a data provider who creates a new file, a user who has read permission to that file, and the remote server work as below. The data provider encrypts the file contents and paths with the user's public key and stores their encryptions on the remote server. The user generates a trapdoor of the PKSE scheme with the user's private key and provides it for the remote server. The remote server returns the file contents encryption of which the corresponding file path encryption matches the provided trapdoor. The user decrypts the returned encryption with the user's private key, which results in the file contents. The above scheme may seem almost the same as the Sommelier DB. The difference is that the user's private and public keys consist of those of PKSE and public-key encryption (PKE). The PKSE scheme is used to allow the server to search for files in the requested file path without revealing them. In addition, the PKE scheme is necessary to obtain the file contents because only with the PKSE scheme the user cannot obtain the unknown message from the ciphertext, even if the PKSE private key is available. In other words, Sommelier Drive requires the PKSE and PKE scheme to test and recover the file path and contents, respectively.","title":"Storing files on a remote server without revealing what files exist and where they are located."},{"location":"drive/apis/client_apis/","text":"Author: Sora Suegami Our client implementation currently provides the following CLI commands. CLI Commands register initDirPath Create a new user account and the user's initial directory under the root directory. Inputs: initDirPath : A file path of the initial directory. Example: register /data1 Note: Before running the following commands, you must create a user account with this command! touch filePath Create a new file with an empty contents. Inputs: filePath : A file path. Example: touch /data1/test.txt mkdir dirPath Create a new directory. Inputs: dirPath : A directory path. Example: mkdir /data1/subdata cat filePath Retrieve a text in the file located in the given file path. Inputs: filePath : A file path. Example: cat /data1/test.txt modify filePath text Modify the file contents located in the given file path with the given text. Inputs: filePath : A file path of the file to be modified. text : A text written in the file. Example: modify /data1/test.txt Hello! ls dirPath Retrieve a childlen file paths under the given file path. Inputs: dirPath : A directory path. Example: ls /data1 find dirPath Retrieve a descendent file paths under the given file path. Inputs: dirPath : A directory path. Example: find /data1 exit Exit the CLI.","title":"Client APIs"},{"location":"drive/apis/client_apis/#author-sora-suegami","text":"Our client implementation currently provides the following CLI commands.","title":"Author: Sora Suegami"},{"location":"drive/apis/client_apis/#cli-commands","text":"","title":"CLI Commands"},{"location":"drive/apis/client_apis/#register-initdirpath","text":"Create a new user account and the user's initial directory under the root directory. Inputs: initDirPath : A file path of the initial directory. Example: register /data1 Note: Before running the following commands, you must create a user account with this command!","title":"register initDirPath"},{"location":"drive/apis/client_apis/#touch-filepath","text":"Create a new file with an empty contents. Inputs: filePath : A file path. Example: touch /data1/test.txt","title":"touch filePath"},{"location":"drive/apis/client_apis/#mkdir-dirpath","text":"Create a new directory. Inputs: dirPath : A directory path. Example: mkdir /data1/subdata","title":"mkdir dirPath"},{"location":"drive/apis/client_apis/#cat-filepath","text":"Retrieve a text in the file located in the given file path. Inputs: filePath : A file path. Example: cat /data1/test.txt","title":"cat filePath"},{"location":"drive/apis/client_apis/#modify-filepath-text","text":"Modify the file contents located in the given file path with the given text. Inputs: filePath : A file path of the file to be modified. text : A text written in the file. Example: modify /data1/test.txt Hello!","title":"modify filePath text"},{"location":"drive/apis/client_apis/#ls-dirpath","text":"Retrieve a childlen file paths under the given file path. Inputs: dirPath : A directory path. Example: ls /data1","title":"ls dirPath"},{"location":"drive/apis/client_apis/#find-dirpath","text":"Retrieve a descendent file paths under the given file path. Inputs: dirPath : A directory path. Example: find /data1","title":"find dirPath"},{"location":"drive/apis/client_apis/#exit","text":"Exit the CLI.","title":"exit"},{"location":"drive/apis/server_apis/","text":"Author: Sora Suegami A server of the Sommelier Drive provides the following REST APIs. REST APIs GET /user Returns a record in the User table where a value of the UserID column is userId . Request: 1 2 3 { \"userId\": Int } Response: 1 2 3 4 5 6 { \"userId\": Int, \"dataPK\": String, \"keywordPK\": String, \"nonce\": Int } POST /user Takes as input public keys and file path encryptions of the PKE and PKSE schemes, inserts them in the User table and Path table, and returns a new userId . Request: 1 2 3 4 5 6 { \"dataPK\": String, \"keywordPK\": String, \"dataCT\": String, \"keywordCT\": String, } Response: Int GET /file-path Returns a record in the Path table where a value of the PathID column is pathId . Request: 1 2 3 { \"pathId\": Int } Response: 1 2 3 4 5 6 7 { \"pathId\": Int, \"userId\": Int, \"permissionHash\": String, \"dataCT\": String, \"keywordCT\": String } GET /file-path/children Returns a list of records in the Path table where a value of the PermissionHash column is equal to the permissionHash . Request: 1 2 3 { \"permissionHash\": String } Response: 1 2 3 4 5 6 7 8 9 10 [ { \"pathId\": Int, \"userId\": Int, \"permissionHash\": String, \"dataCT\": String, \"keywordCT\": String }, ... ] GET /file-path/search Takes as input a userId and a trapdoor td and returns records in the Path table where a value of the UserID column is userId and a ciphertext ct of the KeywordCT column satisfies test_cipher(ct,td)==1 . Request: 1 2 3 4 { \"userId\": Int, \"trapdoor\": String } Response: 1 2 3 4 5 6 7 8 9 10 [ { \"pathId\": Int, \"userId\": Int, \"permissionHash\": String, \"dataCT\": String, \"keywordCT\": String }, ... ] POST /file-path Takes as input readUserId , premissionHash , dataCT , and keywordCT , inserts them into the Path table, and returns a new pathId . Request: 1 2 3 4 5 6 { \"readUserId\": Int, \"premissionHash\": String, \"dataCT\": String, \"keywordCT\": String, } Response: Int GET /shared-key Returns a record in the Shared Key table where a value of the PathID column is pathId . Request: 1 2 3 { \"pathId\": Int } Response: 1 2 3 4 5 { \"sharedKeyId\": Int, \"pathId\": Int, \"ct\": String } POST /shared-key Takes as input pathId and ct , inserts them into the Shared key table, and returns a new sharedKeyId . Request: 1 2 3 4 { \"pathId\": Int, \"ct\": String } Response: Int GET /contents Returns a record in the Contents table where a value of the SharedKeyHash column is equal to the sharedKeyHash . Request: 1 2 3 { \"sharedKeyHash\": String } Response: 1 2 3 4 5 6 7 { \"contentsId\": Int, \"sharedKeyHash\": String, //\u201dauthorizationPK\u201d: String, \"nonce\": Int \"ct\": String } POST /contents Takes as input sharedKeyHash and ct , inserts them into the Contents table, and returns a new contentsId . Request: 1 2 3 4 { \"sharedKeyHash\": String, \"ct\": String } Response: Int PUT /contents Takes as input sharedKeyHash and ct , modifies a value of the ContentsCT column in the record where a value of the SharedKeyHash column is equal to the sharedKeyHash . Request: 1 2 3 4 { \"sharedKeyHash\": String, \"ct\": String } Response: Int","title":"Server REST APIs"},{"location":"drive/apis/server_apis/#author-sora-suegami","text":"A server of the Sommelier Drive provides the following REST APIs.","title":"Author: Sora Suegami"},{"location":"drive/apis/server_apis/#rest-apis","text":"GET /user Returns a record in the User table where a value of the UserID column is userId . Request: 1 2 3 { \"userId\": Int } Response: 1 2 3 4 5 6 { \"userId\": Int, \"dataPK\": String, \"keywordPK\": String, \"nonce\": Int } POST /user Takes as input public keys and file path encryptions of the PKE and PKSE schemes, inserts them in the User table and Path table, and returns a new userId . Request: 1 2 3 4 5 6 { \"dataPK\": String, \"keywordPK\": String, \"dataCT\": String, \"keywordCT\": String, } Response: Int GET /file-path Returns a record in the Path table where a value of the PathID column is pathId . Request: 1 2 3 { \"pathId\": Int } Response: 1 2 3 4 5 6 7 { \"pathId\": Int, \"userId\": Int, \"permissionHash\": String, \"dataCT\": String, \"keywordCT\": String } GET /file-path/children Returns a list of records in the Path table where a value of the PermissionHash column is equal to the permissionHash . Request: 1 2 3 { \"permissionHash\": String } Response: 1 2 3 4 5 6 7 8 9 10 [ { \"pathId\": Int, \"userId\": Int, \"permissionHash\": String, \"dataCT\": String, \"keywordCT\": String }, ... ] GET /file-path/search Takes as input a userId and a trapdoor td and returns records in the Path table where a value of the UserID column is userId and a ciphertext ct of the KeywordCT column satisfies test_cipher(ct,td)==1 . Request: 1 2 3 4 { \"userId\": Int, \"trapdoor\": String } Response: 1 2 3 4 5 6 7 8 9 10 [ { \"pathId\": Int, \"userId\": Int, \"permissionHash\": String, \"dataCT\": String, \"keywordCT\": String }, ... ] POST /file-path Takes as input readUserId , premissionHash , dataCT , and keywordCT , inserts them into the Path table, and returns a new pathId . Request: 1 2 3 4 5 6 { \"readUserId\": Int, \"premissionHash\": String, \"dataCT\": String, \"keywordCT\": String, } Response: Int GET /shared-key Returns a record in the Shared Key table where a value of the PathID column is pathId . Request: 1 2 3 { \"pathId\": Int } Response: 1 2 3 4 5 { \"sharedKeyId\": Int, \"pathId\": Int, \"ct\": String } POST /shared-key Takes as input pathId and ct , inserts them into the Shared key table, and returns a new sharedKeyId . Request: 1 2 3 4 { \"pathId\": Int, \"ct\": String } Response: Int GET /contents Returns a record in the Contents table where a value of the SharedKeyHash column is equal to the sharedKeyHash . Request: 1 2 3 { \"sharedKeyHash\": String } Response: 1 2 3 4 5 6 7 { \"contentsId\": Int, \"sharedKeyHash\": String, //\u201dauthorizationPK\u201d: String, \"nonce\": Int \"ct\": String } POST /contents Takes as input sharedKeyHash and ct , inserts them into the Contents table, and returns a new contentsId . Request: 1 2 3 4 { \"sharedKeyHash\": String, \"ct\": String } Response: Int PUT /contents Takes as input sharedKeyHash and ct , modifies a value of the ContentsCT column in the record where a value of the SharedKeyHash column is equal to the sharedKeyHash . Request: 1 2 3 4 { \"sharedKeyHash\": String, \"ct\": String } Response: Int","title":"REST APIs"},{"location":"drive/how_it_works/client_spec/","text":"Author: Sora Suegami A client of Sommelier Drive can manage files on the remote server in a similar manner to Unix file systems. It performs each operation in the background as below. User registration A client generates new pairs of private and public keys of the PKE and PKSE schemes, dataPK and keywordPK . The client decides a name of the initial directory initDir and encrypts its file path /'initDir' with the dataPK and keywordPK , which results in the PKE and PKSE ciphertexts dataCT and keywordCT . The client posts the dataPK , keywordPK , dataCT , and keywordCT to a remote server. The remote server inserts the provided data into the User table and makes a new userId . The remote server also inserts the provided ciphertexts and userId into the Path table, where a permissionHash is derived from userId and a root file path / by the remote server. The remote server returns userId to the client. The client derives permissionHash from the returned userId and / and requests the records in the Path table where a value of PermissionHash column is equal to permissionHash . The remote server returns the requested record in the Path table, which includes the id of the file path pathId . The client generates a fresh shared key sharedKey and encrypts it with dataPK , which results in the shared key encryption sharedKeyCT . The client posts the pathId and sharedKeyCT to the remote server. The remote server inserts the provided pathId and sharedKeyCT into the Shared key table. The client constructs a bit string called contentsData as the following table: The client encrypts the contentsData with the sharedKey , which results in contentsCT . The client computes the hash value sharedKeyHash and posts contentsCT and sharedKeyHash to the remote server. The remote server inserts the provided contentsCT and sharedKeyHash into the Contents table. Field Name Bit Size Description isFile 1 1 for a file, 0 for a directory. numReadableUsers 64 A big-endian integer of the number of users with read permission. readableUserPathIds 64 * numReadableUsers A vector of pathId s corresponding to this contents. fileBytes variable A byte string of the contents of the file for a file, an empty byte string for a directory. File retrieve (cat) A client with the userId will retrieve the contents of the file located in the filePath as below. The client derives a permissionHash from the userId and the parent directory file path Parent(filePath) and requests the records in the Path table where a value of PermissionHash column is equal to permissionHash . The remote server returns the requested records in the Path table. For each returned record, the client decrypts its dataCT and find the pathId whose corresponding file path is equal to the filePath . The client requests the record in the Shared key table where a value of the PathID column is equal to pathId . The remote server returns the requested record in the Shared key table. The client recovers the sharedKey from the sharedKeyCT in the returned record. The client requests the record in the Contents table where a value of the SharedKeyHash column is equal to sharedKeyHash derived from sharedKey . The remote server returns the requested record in the Contents table. The client decrypts the contentsCT in the returned record with the sharedKey , which results in the desired contentsData . Children file paths retrieve (ls) A client with the userId will retrieve the children file paths under the filePath as below. The client derives a permissionHash from the userId and the filePath and requests the records in the Path table where a value of PermissionHash column is equal to permissionHash . The remote server returns the requested records in the Path table. For each returned record, the client decrypts its dataCT . These recovered file paths are the children file paths under the filePath . Descendant file paths retrieve (find) A client with the userId will retrieve the descendant file paths under the filePath as below. The client generates a trapdoor with the PKSE private key for strings with filePath as prefix and requests the records in the Path table where a value of KeywordCT column matches the trapdoor. The remote server returns the requested records in the Path table. For each returned record, the client decrypts its dataCT . These recovered file paths are the descendant file paths under the filePath . File creation (touch) A client with the userId will locate a new file whose contents bytes are bytes in the filePath . The client retrieves the contentsData located in Parent(filePath) in the same way as the file/directory retrieve process . The client parse the contentsData as (isFile, numReadableUsers, readableUserPathIds, fileBytes) . The client generates a fresh shared key sharedKey and derives its hash sharedKeyHash . For each pathId in the readableUserPathIds , the client and the remote server performs the following process: The client requests the records in the Path table where a value of PathID column is equal to the pathId . The remote server returns the requested record in the Path table. The client retrieves the usedId from the returned record and requests the records in the User table where a value of UserID column is equal to the userId . The remote server returns the requested record in the User table. The client retrieves the dataPK and keywordPK from the returned record and encrypts the filePath with these keys, which results in the dataCT and keywordCT , respectively. The client also derives the permissionHash from the userId and the Parent(filePath) and posts the userId , permissionHash , dataCT , and keywordCT to the remote server. The remote server inserts the provided data into the Path table and returns a new pathId . The client encrypts the sharedKey with the dataPK , which results in the sharedKeyCT . The client posts the pathId and sharedKeyCT to the remote server. The remote server inserts the provided data into the Shared key table. The client constructs a new contentsData as the following table and encrypts it with the sharedKey , which results in the contentsCT . The client posts the sharedKeyHash and contentsCT to the remote server. The remote server inserts the provided data into the Contents table. Field Name Bit Size Value isFile 1 1 numReadableUsers 64 numReadableUsers in Step 2. readableUserPathIds 64 * numReadableUsers readableUserPathIds in Step 2. fileBytes variable bytes Directory creation (mkdir) A client with the userId will locate a new directory in the filePath . The client retrieves the contentsData located in Parent(filePath) in the same way as the file/directory retrieve process . The client parse the contentsData as (isFile, numReadableUsers, readableUserPathIds, fileBytes) . The client generates a fresh shared key sharedKey and derives its hash sharedKeyHash . For each pathId in the readableUserPathIds , the client and the remote server performs the following process: The client requests the records in the Path table where a value of PathID column is equal to the pathId . The remote server returns the requested record in the Path table. The client retrieves the usedId from the returned record and requests the records in the User table where a value of UserID column is equal to the userId . The remote server returns the requested record in the User table. The client retrieves the dataPK and keywordPK from the returned record and encrypts the filePath with these keys, which results in the dataCT and keywordCT , respectively. The client also derives the permissionHash from the userId and the Parent(filePath) and posts the userId , permissionHash , dataCT , and keywordCT to the remote server. The remote server inserts the provided data into the Path table and returns a new pathId . The client encrypts the sharedKey with the dataPK , which results in the sharedKeyCT . The client posts the pathId and sharedKeyCT to the remote server. The remote server inserts the provided data into the Shared key table. The client constructs a new contentsData as the following table and encrypts it with the sharedKey , which results in the contentsCT . The client posts the sharedKeyHash and contentsCT to the remote server. The remote server inserts the provided data into the Contents table. Field Name Bit Size Value isFile 1 0 numReadableUsers 64 numReadableUsers in Step 2. readableUserPathIds 64 * numReadableUsers readableUserPathIds in Step 2. fileBytes variable Empty bytes File Modification A client with the userId will modify a file located in the filePath with the bytes newBytes . The client retrieves the contentsData and sharedKey of the file located in filePath in the same way as the file/directory retrieve process . The client parse the contentsData as (isFile, numReadableUsers, readableUserPathIds, fileBytes) . The client constructs a new contentsData as the following table and encrypts it with the sharedKey , which results in the contentsCT . The client posts the sharedKeyHash and contentsCT to the remote server. The remote server inserts the provided data into the Contents table. Field Name Bit Size Value isFile 1 1 numReadableUsers 64 numReadableUsers in Step 2. readableUserPathIds 64 * numReadableUsers readableUserPathIds in Step 2. fileBytes variable newBytes Note that the other operations, e.g., file deletion, are not supported in the current implementation .","title":"Client Specification"},{"location":"drive/how_it_works/client_spec/#author-sora-suegami","text":"A client of Sommelier Drive can manage files on the remote server in a similar manner to Unix file systems. It performs each operation in the background as below.","title":"Author: Sora Suegami"},{"location":"drive/how_it_works/client_spec/#user-registration","text":"A client generates new pairs of private and public keys of the PKE and PKSE schemes, dataPK and keywordPK . The client decides a name of the initial directory initDir and encrypts its file path /'initDir' with the dataPK and keywordPK , which results in the PKE and PKSE ciphertexts dataCT and keywordCT . The client posts the dataPK , keywordPK , dataCT , and keywordCT to a remote server. The remote server inserts the provided data into the User table and makes a new userId . The remote server also inserts the provided ciphertexts and userId into the Path table, where a permissionHash is derived from userId and a root file path / by the remote server. The remote server returns userId to the client. The client derives permissionHash from the returned userId and / and requests the records in the Path table where a value of PermissionHash column is equal to permissionHash . The remote server returns the requested record in the Path table, which includes the id of the file path pathId . The client generates a fresh shared key sharedKey and encrypts it with dataPK , which results in the shared key encryption sharedKeyCT . The client posts the pathId and sharedKeyCT to the remote server. The remote server inserts the provided pathId and sharedKeyCT into the Shared key table. The client constructs a bit string called contentsData as the following table: The client encrypts the contentsData with the sharedKey , which results in contentsCT . The client computes the hash value sharedKeyHash and posts contentsCT and sharedKeyHash to the remote server. The remote server inserts the provided contentsCT and sharedKeyHash into the Contents table. Field Name Bit Size Description isFile 1 1 for a file, 0 for a directory. numReadableUsers 64 A big-endian integer of the number of users with read permission. readableUserPathIds 64 * numReadableUsers A vector of pathId s corresponding to this contents. fileBytes variable A byte string of the contents of the file for a file, an empty byte string for a directory.","title":"User registration"},{"location":"drive/how_it_works/client_spec/#file-retrieve-cat","text":"A client with the userId will retrieve the contents of the file located in the filePath as below. The client derives a permissionHash from the userId and the parent directory file path Parent(filePath) and requests the records in the Path table where a value of PermissionHash column is equal to permissionHash . The remote server returns the requested records in the Path table. For each returned record, the client decrypts its dataCT and find the pathId whose corresponding file path is equal to the filePath . The client requests the record in the Shared key table where a value of the PathID column is equal to pathId . The remote server returns the requested record in the Shared key table. The client recovers the sharedKey from the sharedKeyCT in the returned record. The client requests the record in the Contents table where a value of the SharedKeyHash column is equal to sharedKeyHash derived from sharedKey . The remote server returns the requested record in the Contents table. The client decrypts the contentsCT in the returned record with the sharedKey , which results in the desired contentsData .","title":"File retrieve (cat)"},{"location":"drive/how_it_works/client_spec/#children-file-paths-retrieve-ls","text":"A client with the userId will retrieve the children file paths under the filePath as below. The client derives a permissionHash from the userId and the filePath and requests the records in the Path table where a value of PermissionHash column is equal to permissionHash . The remote server returns the requested records in the Path table. For each returned record, the client decrypts its dataCT . These recovered file paths are the children file paths under the filePath .","title":"Children file paths retrieve (ls)"},{"location":"drive/how_it_works/client_spec/#descendant-file-paths-retrieve-find","text":"A client with the userId will retrieve the descendant file paths under the filePath as below. The client generates a trapdoor with the PKSE private key for strings with filePath as prefix and requests the records in the Path table where a value of KeywordCT column matches the trapdoor. The remote server returns the requested records in the Path table. For each returned record, the client decrypts its dataCT . These recovered file paths are the descendant file paths under the filePath .","title":"Descendant file paths retrieve (find)"},{"location":"drive/how_it_works/client_spec/#file-creation-touch","text":"A client with the userId will locate a new file whose contents bytes are bytes in the filePath . The client retrieves the contentsData located in Parent(filePath) in the same way as the file/directory retrieve process . The client parse the contentsData as (isFile, numReadableUsers, readableUserPathIds, fileBytes) . The client generates a fresh shared key sharedKey and derives its hash sharedKeyHash . For each pathId in the readableUserPathIds , the client and the remote server performs the following process: The client requests the records in the Path table where a value of PathID column is equal to the pathId . The remote server returns the requested record in the Path table. The client retrieves the usedId from the returned record and requests the records in the User table where a value of UserID column is equal to the userId . The remote server returns the requested record in the User table. The client retrieves the dataPK and keywordPK from the returned record and encrypts the filePath with these keys, which results in the dataCT and keywordCT , respectively. The client also derives the permissionHash from the userId and the Parent(filePath) and posts the userId , permissionHash , dataCT , and keywordCT to the remote server. The remote server inserts the provided data into the Path table and returns a new pathId . The client encrypts the sharedKey with the dataPK , which results in the sharedKeyCT . The client posts the pathId and sharedKeyCT to the remote server. The remote server inserts the provided data into the Shared key table. The client constructs a new contentsData as the following table and encrypts it with the sharedKey , which results in the contentsCT . The client posts the sharedKeyHash and contentsCT to the remote server. The remote server inserts the provided data into the Contents table. Field Name Bit Size Value isFile 1 1 numReadableUsers 64 numReadableUsers in Step 2. readableUserPathIds 64 * numReadableUsers readableUserPathIds in Step 2. fileBytes variable bytes","title":"File creation (touch)"},{"location":"drive/how_it_works/client_spec/#directory-creation-mkdir","text":"A client with the userId will locate a new directory in the filePath . The client retrieves the contentsData located in Parent(filePath) in the same way as the file/directory retrieve process . The client parse the contentsData as (isFile, numReadableUsers, readableUserPathIds, fileBytes) . The client generates a fresh shared key sharedKey and derives its hash sharedKeyHash . For each pathId in the readableUserPathIds , the client and the remote server performs the following process: The client requests the records in the Path table where a value of PathID column is equal to the pathId . The remote server returns the requested record in the Path table. The client retrieves the usedId from the returned record and requests the records in the User table where a value of UserID column is equal to the userId . The remote server returns the requested record in the User table. The client retrieves the dataPK and keywordPK from the returned record and encrypts the filePath with these keys, which results in the dataCT and keywordCT , respectively. The client also derives the permissionHash from the userId and the Parent(filePath) and posts the userId , permissionHash , dataCT , and keywordCT to the remote server. The remote server inserts the provided data into the Path table and returns a new pathId . The client encrypts the sharedKey with the dataPK , which results in the sharedKeyCT . The client posts the pathId and sharedKeyCT to the remote server. The remote server inserts the provided data into the Shared key table. The client constructs a new contentsData as the following table and encrypts it with the sharedKey , which results in the contentsCT . The client posts the sharedKeyHash and contentsCT to the remote server. The remote server inserts the provided data into the Contents table. Field Name Bit Size Value isFile 1 0 numReadableUsers 64 numReadableUsers in Step 2. readableUserPathIds 64 * numReadableUsers readableUserPathIds in Step 2. fileBytes variable Empty bytes","title":"Directory creation (mkdir)"},{"location":"drive/how_it_works/client_spec/#file-modification","text":"A client with the userId will modify a file located in the filePath with the bytes newBytes . The client retrieves the contentsData and sharedKey of the file located in filePath in the same way as the file/directory retrieve process . The client parse the contentsData as (isFile, numReadableUsers, readableUserPathIds, fileBytes) . The client constructs a new contentsData as the following table and encrypts it with the sharedKey , which results in the contentsCT . The client posts the sharedKeyHash and contentsCT to the remote server. The remote server inserts the provided data into the Contents table. Field Name Bit Size Value isFile 1 1 numReadableUsers 64 numReadableUsers in Step 2. readableUserPathIds 64 * numReadableUsers readableUserPathIds in Step 2. fileBytes variable newBytes Note that the other operations, e.g., file deletion, are not supported in the current implementation .","title":"File Modification"},{"location":"drive/how_it_works/concepts/","text":"Author: Sora Suegami Here, we describe new concepts of Sommelier Drive and how they optimize the processes of the data provider and the remote server. Permission hash for the optimization of the ls operation. First, we introduce a permission hash. This is a hash value calculated from the ID of a legitimate user having read permission and the file path of the parent directory. The data provider, in addition to the file path encryption, stores the permission hash on the remote server. When the user wishes to perform the ls operation, that is to say, retrieve the children file paths of a directory, the user provides the remote server with the permission hash corresponding to that directory file path instead of the trapdoor. The remote server returns the file path encryptions whose corresponding permission hash is equal to the provided one. In this way, the permission hash can optimize the ls operation on the remote server. The attentive reader may think that the permission hash helps the malicious server administrator learn information about the file path. In fact, it reveals only information about sibling files and directories, i.e., those contained in the same parent directory . This is because the administrator cannot learn the actual file paths from their permission hash or encryptions but can specify the siblings by comparing the permission hashes. Shared key for the optimization of encrypting a file for multiple users. A shared key is just a secret key of symmetric key encryption (SKE), e.g., AES. It improves the efficiency when multiple users have read permission for the same file. In more detail, the file contents are encrypted with a fresh shared key, and the shared key is encrypted with each user's PKE public key. The legitimate user can obtain the file contents by (1) recovering the shared key with the PKE private key and (2) decrypting the SKE ciphertexts with the shared key. To analyze the efficiency, we compare the ciphertext size in the above scheme with that of the case where the file contents are directly encrypted with each user's PKE public key. Let \\(N, d, k\\) be the number of the legitimate users, the file contents size, and the shared key size. In the former case, the ciphertext size grows in the order \\(\\mathcal{O}(kN)\\) , whereas the order of the latter case is \\(\\mathcal{O}(dN)\\) . Therefore, our scheme is more efficient when \\(d\\) is sufficiently large.","title":"New Concepts"},{"location":"drive/how_it_works/concepts/#author-sora-suegami","text":"Here, we describe new concepts of Sommelier Drive and how they optimize the processes of the data provider and the remote server.","title":"Author: Sora Suegami"},{"location":"drive/how_it_works/concepts/#permission-hash-for-the-optimization-of-the-ls-operation","text":"First, we introduce a permission hash. This is a hash value calculated from the ID of a legitimate user having read permission and the file path of the parent directory. The data provider, in addition to the file path encryption, stores the permission hash on the remote server. When the user wishes to perform the ls operation, that is to say, retrieve the children file paths of a directory, the user provides the remote server with the permission hash corresponding to that directory file path instead of the trapdoor. The remote server returns the file path encryptions whose corresponding permission hash is equal to the provided one. In this way, the permission hash can optimize the ls operation on the remote server. The attentive reader may think that the permission hash helps the malicious server administrator learn information about the file path. In fact, it reveals only information about sibling files and directories, i.e., those contained in the same parent directory . This is because the administrator cannot learn the actual file paths from their permission hash or encryptions but can specify the siblings by comparing the permission hashes.","title":"Permission hash for the optimization of the ls operation."},{"location":"drive/how_it_works/concepts/#shared-key-for-the-optimization-of-encrypting-a-file-for-multiple-users","text":"A shared key is just a secret key of symmetric key encryption (SKE), e.g., AES. It improves the efficiency when multiple users have read permission for the same file. In more detail, the file contents are encrypted with a fresh shared key, and the shared key is encrypted with each user's PKE public key. The legitimate user can obtain the file contents by (1) recovering the shared key with the PKE private key and (2) decrypting the SKE ciphertexts with the shared key. To analyze the efficiency, we compare the ciphertext size in the above scheme with that of the case where the file contents are directly encrypted with each user's PKE public key. Let \\(N, d, k\\) be the number of the legitimate users, the file contents size, and the shared key size. In the former case, the ciphertext size grows in the order \\(\\mathcal{O}(kN)\\) , whereas the order of the latter case is \\(\\mathcal{O}(dN)\\) . Therefore, our scheme is more efficient when \\(d\\) is sufficiently large.","title":"Shared key for the optimization of encrypting a file for multiple users."},{"location":"drive/how_it_works/server_spec/","text":"Author: Sora Suegami A remote server in Sommelier Drive stores file information in Sommelier DB. That is, it creates DB tables as below. User table User table stores the id of a user and the user's PKE and PKSE public keys. They are denoted by userId , dataPK , and keywordPK , respectively, in the following description. UserID DataPK KeywordPK Int Text Text Path table Path table stores information about the file path. Each record in this table corresponds to a pair of the userId and the file path, filePath . Its columns describe the property of the file or directory located in the filePath as below. PathID UserID PermissionHash DataCT KeywordCT Int Int Text Text Text UserID: A userId of the user who has read permission to the file or directory located in the filePath . PermissionHash: A permissionHash derived from the userId and Parent(filePath) , which represents a parent directory path of the filePath . DataCT: A ciphertext of the filePath encrypted with the dataPK corresponding to the userId . KeywordCT: A ciphertext of the filePath encrypted with the keywordPK corresponding to the userId . Shared key table Shared Key table stores a pathId and a shared key encryption, sharedKeyCT . The sharedKeyCT is required to recover the file contents located in the filePath of the pathId . SharedKeyID PathID SharedKeyCT Int Int Text Contents table Contents table stores a file contents encryption, contentsCT . Each record corresponds to a sharedKeyHash , which is a hash value of the shared key. Therefore, users who hold the same shared key can access the same record. ContentsID SharedKeyHash ContentsCT Int Text Text","title":"Server Specification"},{"location":"drive/how_it_works/server_spec/#author-sora-suegami","text":"A remote server in Sommelier Drive stores file information in Sommelier DB. That is, it creates DB tables as below.","title":"Author: Sora Suegami"},{"location":"drive/how_it_works/server_spec/#user-table","text":"User table stores the id of a user and the user's PKE and PKSE public keys. They are denoted by userId , dataPK , and keywordPK , respectively, in the following description. UserID DataPK KeywordPK Int Text Text","title":"User table"},{"location":"drive/how_it_works/server_spec/#path-table","text":"Path table stores information about the file path. Each record in this table corresponds to a pair of the userId and the file path, filePath . Its columns describe the property of the file or directory located in the filePath as below. PathID UserID PermissionHash DataCT KeywordCT Int Int Text Text Text UserID: A userId of the user who has read permission to the file or directory located in the filePath . PermissionHash: A permissionHash derived from the userId and Parent(filePath) , which represents a parent directory path of the filePath . DataCT: A ciphertext of the filePath encrypted with the dataPK corresponding to the userId . KeywordCT: A ciphertext of the filePath encrypted with the keywordPK corresponding to the userId .","title":"Path table"},{"location":"drive/how_it_works/server_spec/#shared-key-table","text":"Shared Key table stores a pathId and a shared key encryption, sharedKeyCT . The sharedKeyCT is required to recover the file contents located in the filePath of the pathId . SharedKeyID PathID SharedKeyCT Int Int Text","title":"Shared key table"},{"location":"drive/how_it_works/server_spec/#contents-table","text":"Contents table stores a file contents encryption, contentsCT . Each record corresponds to a sharedKeyHash , which is a hash value of the shared key. Therefore, users who hold the same shared key can access the same record. ContentsID SharedKeyHash ContentsCT Int Text Text","title":"Contents table"},{"location":"glibc/blog-ja/","text":"glibc\u306e\u66f8\u304d\u63db\u3048\u306b\u3088\u308b\u30c9\u30e9\u30a4\u30d6\u4e0a\u306e\u30d5\u30a1\u30a4\u30eb\u3078\u306e\u30a2\u30af\u30bb\u30b9 Author: \u897f\u4e95\u9065\u7d00 \u306f\u3058\u3081\u306b \u3053\u3053\u3067\u306fSommelier Drive\u304c\u63d0\u4f9b\u3059\u308b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306eAPI\u3092\u5229\u7528\u3057\u3066\u3001Linux\u30de\u30b7\u30f3\u4e0a\u3067\u65e2\u5b58\u306e\u30b3\u30de\u30f3\u30c9\u3092\u7f6e\u304d\u63db\u3048\u308b\u3053\u3068\u306a\u304f\u901a\u5e38\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3068\u540c\u69d8\u306b\u30c9\u30e9\u30a4\u30d6\u4e0a\u306e\u30d5\u30a1\u30a4\u30eb\u3084\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6271\u3046\u3068\u3044\u3046\u8a66\u307f\u306b\u3064\u3044\u3066\u8ff0\u3079\u308b\u3002 Sommelier Drive\u304c\u63d0\u4f9b\u3059\u308b\u30c9\u30e9\u30a4\u30d6\u3092\u64cd\u4f5c\u3059\u308bAPI\u3092\u5229\u7528\u3059\u308b\u5b9f\u88c5\u306a\u306e\u3067\u3001\u53b3\u5bc6\u306b\u306fSommelier Drive\u3068\u306f\u5225\u7269\u3060\u304c\u5b9f\u88c5\u306e\u4e00\u8cab\u3068\u3057\u3066\u4f5c\u6210\u3057\u305f\u306e\u3067\u3001\u3053\u3053\u306b\u8a18\u8f09\u3055\u305b\u3066\u3044\u305f\u3060\u304f\u3002 \u76ee\u7684 \u30ea\u30e2\u30fc\u30c8\u306b\u3042\u308b\u30c9\u30e9\u30a4\u30d6\u3092\u901a\u5e38\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u540c\u69d8\u306b\u6271\u3046\u3068\u3044\u3046\u4e3b\u65e8\u3067\u3001\u4eca\u56de\u306f\u30b7\u30f3\u30d7\u30eb\u306b\u30bf\u30fc\u30df\u30ca\u30eb\u4e0a\u3067\u6271\u3046ls\u3084cat\u3084touch\u3068\u3044\u3063\u305f\u30b3\u30de\u30f3\u30c9\u3092\u30ea\u30e2\u30fc\u30c8\u306e\u30d5\u30a1\u30a4\u30eb\u3084\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u5bfe\u3057\u3066\u3082\u884c\u3048\u308b\u3088\u3046\u306b\u3059\u308b\u3053\u3068\u3092\u76ee\u6307\u3057\u305f\u3002NFS\u306e\u3088\u3046\u306a\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u8d8a\u3057\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3092\u4e00\u3064\u4e00\u3064\u5b9a\u7fa9\u3059\u308b\u3053\u3068\u3067\u65b0\u3057\u3044\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u4f5c\u3063\u3066\u3001\u30ed\u30fc\u30ab\u30eb\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306b\u30de\u30a6\u30f3\u30c8\u3057\u3066\u4f7f\u3048\u308b\u3088\u3046\u306b\u3059\u308b\u306e\u304c\u901a\u5e38\u3060\u304c\u3001\u5b9f\u9a13\u306e\u6642\u9593\u306e\u90fd\u5408\u4e0a\u3001\u30ab\u30fc\u30cd\u30eb\u30ec\u30d9\u30eb\u3067\u306e\u5b9f\u88c5\u306f\u304b\u306a\u308a\u53b3\u3057\u3044\u3002\u305d\u3053\u3067\u3001\u6bd4\u8f03\u7684\u7740\u624b\u3057\u3084\u3059\u3044glibc\u306e\u66f8\u304d\u63db\u3048\u306b\u3088\u308b\u30e6\u30fc\u30b6\u30fc\u30ec\u30d9\u30eb\u3067\u306e\u7591\u4f3c\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u5b9f\u73fe\u3092\u8a66\u307f\u305f\u3002 \u306a\u305cglibc\u304b\u3068\u3044\u3046\u3068\u3001glibc\u306e\u6a19\u6e96\u30e9\u30a4\u30d6\u30e9\u30ealibc.so\u3084\u3001\u52d5\u7684\u30ea\u30f3\u30abld-linux.so\u3068\u3044\u3046\u306e\u306freadelf\u3084ldd\u3067\u8abf\u3079\u308b\u3068\u308f\u304b\u308b\u3088\u3046\u306b\u5927\u62b5\u306e\u30d7\u30ed\u30b0\u30e9\u30e0\u3084\u30e9\u30a4\u30d6\u30e9\u30ea\u304b\u3089\u30ea\u30f3\u30af\u3055\u308c\u3066\u4f7f\u7528\u3055\u308c\u308b\u304b\u3089\u3067\u3042\u308b\u3002\u3053\u308c\u306fC\u8a00\u8a9e\u3067\u66f8\u304b\u308c\u305f\u30d7\u30ed\u30b0\u30e9\u30e0\u306b\u9650\u3063\u305f\u8a71\u3067\u306f\u306a\u304f\u3001\u4f8b\u3048\u3070\u4eca\u56de\u30e1\u30f3\u30d0\u30fc\u304c\u4f5c\u6210\u3057\u305fRust\u3067\u66f8\u304b\u308c\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u8abf\u3079\u308b\u3068\u3001libc.so\u542b\u3081glibc\u306e\u6a19\u6e96\u30e9\u30a4\u30d6\u30e9\u30ea\u304c\u8907\u6570\u30ea\u30f3\u30af\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002 1 2 3 4 5 6 7 8 9 $ readelf -d librust_searchable_pke.so Dynamic section at offset 0xf8058 contains 29 entries: \u30bf\u30b0 \u30bf\u30a4\u30d7 \u540d\u524d/\u5024 0x0000000000000001 ( NEEDED ) \u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea: [ libgcc_s.so.1 ] 0x0000000000000001 ( NEEDED ) \u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea: [ libm.so.6 ] 0x0000000000000001 ( NEEDED ) \u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea: [ libc.so.6 ] 0x0000000000000001 ( NEEDED ) \u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea: [ ld-linux-x86-64.so.2 ] ~~~~~~~~~~~ \u5b9f\u969b\u306bltrace\u3092\u4f7f\u7528\u3057\u305f\u308a\u3001gdb\u3067\u30d6\u30ec\u30fc\u30af\u30dd\u30a4\u30f3\u30c8\u3092\u8cbc\u308b\u306a\u3069\u3057\u3066\u8abf\u3079\u308b\u3068\u3001\u30d5\u30a1\u30a4\u30eb\u306e\u64cd\u4f5c\u306b\u306flibc.so\u306eopen/close/read/write\u3068\u3044\u3063\u305f\u95a2\u6570\u304c\u547c\u3070\u308c\u3001\u30d2\u30fc\u30d7\u304b\u3089\u30e1\u30e2\u30ea\u306e\u5272\u308a\u5f53\u3066\u3068\u89e3\u653e\u306b\u306f\u6700\u7d42\u7684\u306bmalloc/free\u95a2\u6570\u304c\u547c\u3070\u308c\u308b\u3002\u4ed6\u306b\u3082Python,Ruby\u3068\u3044\u3063\u305f\u30a4\u30f3\u30bf\u30d7\u30ea\u30bf\u8a00\u8a9e\u3082C\u3067\u66f8\u304b\u308c\u3066\u3044\u308b\u3053\u3068\u304b\u3089\u540c\u69d8\u306blibc\u306e\u95a2\u6570\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u3002 \u3064\u307e\u308alibc\u306e\u6319\u52d5\u305d\u306e\u3082\u306e\u3092\u5909\u3048\u308c\u3070\u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u6319\u52d5\u3092\u5909\u3048\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3068\u8003\u3048\u3001\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u81ea\u4f5c\u3059\u308b\u3088\u308a\u306f\u624b\u3092\u3064\u3051\u3084\u3059\u3044\u3068\u611f\u3058\u3001\u3053\u306e\u3088\u3046\u306a\u8a66\u307f\u306b\u81f3\u3063\u305f\u3002\u3057\u304b\u3057\u30a2\u30bb\u30f3\u30d6\u30ea\u3067\u66f8\u304b\u308c\u305f\u30d7\u30ed\u30b0\u30e9\u30e0\u3084Go\u306a\u3069\u72ec\u81ea\u306e\u6a19\u6e96\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u5b9f\u88c5\u3057\u3066\u3044\u308b\u8a00\u8a9e\u3067\u66f8\u304b\u308c\u305f\u30d7\u30ed\u30b0\u30e9\u30e0\u306a\u3069\u306b\u306f\u3053\u306e\u624b\u6cd5\u306f\u4f7f\u3048\u306a\u3044\u3002 \u6319\u52d5\u306e\u5909\u66f4\u65b9\u6cd5\u306b\u3064\u3044\u3066 glibc\u306b\u5909\u66f4\u3092\u52a0\u3048\u3066\u72ec\u81ea\u306elibc.so\u3092\u4f5c\u6210\u3057\u3066\u3082\u3001\u65e2\u5b58\u306e\u5b9f\u884c\u30d5\u30a1\u30a4\u30eb\u306e\u30ea\u30f3\u30af\u5148\u3092\u5909\u66f4\u3059\u308b\u306b\u306f\u3001\u518d\u5ea6\u30ea\u30f3\u30af\u3059\u308b\u304b\u30b7\u30b9\u30c6\u30e0\u5185\u306elibc.so\u3092\u7f6e\u304d\u63db\u3048\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\u3057\u304b\u3057\u3001\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u304c\u5fc5\u305a\u3057\u3082\u5b58\u5728\u3059\u308b\u3068\u306f\u9650\u3089\u306a\u3044\u3057\u3001\u30b7\u30b9\u30c6\u30e0\u306b\u306f\u306a\u308b\u3079\u304f\u5909\u66f4\u3092\u52a0\u3048\u305f\u304f\u306a\u3044\u3002\u305d\u3053\u3067\u95a2\u6570\u306e\u30d5\u30c3\u30af\u3068\u3044\u3046\u624b\u6cd5\u3092\u7528\u3044\u308b\u3053\u3068\u306b\u3057\u305f\u3002\u4eca\u56de\u4f7f\u7528\u3057\u305f\u306e\u306f LD_PRELOAD \u3068\u3044\u3046\u74b0\u5883\u5909\u6570\u3067\u3001\u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u6307\u5b9a\u3059\u308b\u3068\u3001\u5b9f\u884c\u958b\u59cb\u6642\u306b\u52d5\u7684\u30ea\u30f3\u30ab\u304c\u6307\u5b9a\u3057\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u5b9f\u884c\u30d5\u30a1\u30a4\u30eb\u3067\u6307\u5b9a\u3055\u308c\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u3088\u308a\u5148\u306b\u30e1\u30e2\u30ea\u306b\u30ed\u30fc\u30c9\u3059\u308b\u3068\u3044\u3046\u3082\u306e\u3067\u3042\u308b\u3002\u547d\u4ee4\u306e\u5b9f\u884c\u6642\u306b\u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u95a2\u6570\u304c\u521d\u3081\u3066\u547c\u3070\u308c\u305f\u3068\u304d\u306b\u52d5\u7684\u30ea\u30f3\u30ab\u306b\u51e6\u7406\u304c\u79fb\u308a\u3001\u95a2\u6570\u3092\u63a2\u7d22\u3057\u3066\u30a2\u30c9\u30ec\u30b9\u3092\u89e3\u6c7a\u3059\u308b\u3068\u3044\u3046\u6d41\u308c\u304c\u3042\u308b\u304c\u3001\u305d\u306e\u6642\u306e\u95a2\u6570\u306e\u63a2\u7d22\u306e\u9806\u756a\u3092\u3053\u306eLD_PRELOAD\u306b\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u3067\u3001\u30d7\u30ed\u30b0\u30e9\u30e0\u306b\u30ea\u30f3\u30af\u3055\u308c\u3066\u3044\u308b\u30e9\u30a4\u30d6\u30e9\u30ea\u3088\u308a\u524d\u306b\u6301\u3063\u3066\u304f\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\u3064\u307e\u308aLD_PRELOAD\u306b\u672c\u6765\u547c\u3070\u308c\u308b\u306f\u305a\u306e\u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u95a2\u6570\u3092\u5b9f\u88c5\u3057\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u6307\u5b9a\u3059\u308b\u3068\u3001\u95a2\u6570\u306e\u51e6\u7406\u3092\u6a2a\u53d6\u308a\u3067\u304d\u308b\u3053\u3068\u306b\u306a\u308b(\u95a2\u6570\u3092 \u30d5\u30c3\u30af \u3059\u308b\u3068\u3044\u3046)\u3002\u5b9f\u969b\u306bLD_PRELOAD\u306f\u3053\u306e\u95a2\u6570\u306e\u30d5\u30c3\u30af\u306e\u7528\u9014\u3084\u3001\u30d7\u30ed\u30b0\u30e9\u30e0\u958b\u59cb\u6642\u3068\u7d42\u4e86\u6642\u306b\u7279\u5b9a\u306e\u51e6\u7406\u3092\u3055\u305b\u308b\u7528\u9014\u3067\u7528\u3044\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\u672c\u5b9f\u88c5\u3067\u306f\u3053\u306e\u624b\u6cd5\u3092\u7528\u3044\u3066\u65e2\u5b58\u306e\u30b3\u30de\u30f3\u30c9\u3092\u66f8\u304d\u63db\u3048\u305a\u306blibc.so\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u6271\u3046\u95a2\u6570\u306e\u6319\u52d5\u3092\u5909\u66f4\u3057\u305f\u3002 \u305f\u3060\u3057libc.so\u5185\u306e\u95a2\u6570\u3092\u65b0\u305f\u306b\u5b9a\u7fa9\u3057\u3066\u4f5c\u6210\u3057\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u3092preload\u3059\u308b\u3060\u3051\u3067\u306f\u3001\u305d\u306e\u95a2\u6570\u3092\u547c\u3073\u51fa\u3059libc.so\u5185\u306e\u95a2\u6570\u3092\u30d5\u30c3\u30af\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u306a\u3044\u3002\u4f8b\u3048\u3070\u3001write\u95a2\u6570\u3092\u5b9a\u7fa9\u3057\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u3092preload\u3057\u3066\u3082\u3001libc.so\u306efwrite\u95a2\u6570\u304c\u5b9f\u969b\u306b\u547c\u3073\u51fa\u3059\u306e\u306f\u81ea\u8eab\u306ewrite\u95a2\u6570\u3067\u3042\u3063\u3066\u30d5\u30c3\u30af\u3057\u305fwrite\u95a2\u6570\u3067\u306f\u306a\u3044\u3002\u3053\u308c\u306f\u540c\u3058\u30e9\u30a4\u30d6\u30e9\u30ea\u306b\u3042\u308b\u95a2\u6570\u306e\u30a2\u30c9\u30ec\u30b9\u306f\u76f8\u5bfe\u7684\u306a\u3082\u306e\u306a\u306e\u3067\u3001\u308f\u3056\u308f\u3056\u52d5\u7684\u30ea\u30f3\u30ab\u3092\u547c\u3076\u3053\u3068\u306f\u306a\u3044\u304b\u3089\u3067\u3042\u308b\u3002\u305f\u3060\u30d5\u30a1\u30a4\u30eb\u3092\u30aa\u30fc\u30d7\u30f3\u3059\u308b\u51e6\u7406\u3092\u30d5\u30c3\u30af\u3059\u308b\u305f\u3081\u306b\u3001creat\u3084fopen\u3068\u3044\u3063\u305f\u3059\u3079\u3066\u306e\u95a2\u6570\u306e\u51e6\u7406\u3092\u4e00\u3064\u4e00\u3064\u5b9a\u7fa9\u3059\u308b\u306e\u306f\u52b4\u529b\u3092\u8981\u3059\u308b\u3046\u3048\u898b\u9003\u3059\u53ef\u80fd\u6027\u3082\u3042\u308b\u3002\u305d\u3053\u3067\u4eca\u56de\u3068\u3063\u305f\u65b9\u91dd\u306fglibc\u5168\u4f53\u306e\u30bd\u30fc\u30b9\u3092\u6301\u3061\u51fa\u3057\u3066\u3001\u30d5\u30c3\u30af\u3057\u305f\u3044\u95a2\u6570\u304c\u6700\u7d42\u7684\u306b\u884c\u304d\u7740\u304f\u95a2\u6570(\u4f8b\u3048\u3070fopen\u306b\u5bfe\u3057\u3066open)\u306e\u307f\u3092\u5909\u66f4\u3057\u3066preload\u3059\u308b\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f5c\u6210\u3059\u308b\u3068\u3044\u3046\u3082\u306e\u3067\u3001\u304b\u306a\u308a\u7121\u99c4\u304c\u3042\u308b\u304clibc.so\u306e\u95a2\u6570\u306f\u3059\u3079\u3066\u63c3\u3046\u306e\u3067\u30d5\u30c3\u30af\u3092\u3057\u305d\u3053\u306a\u3046\u5fc3\u914d\u306f\u306a\u304f\u306a\u308b\u3002 \u5177\u4f53\u7684\u306a\u8a2d\u8a08\u306e\u65b9\u91dd \u57fa\u672c\u7684\u306b\u306f\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u6271\u3046\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3092\u547c\u3073\u51fa\u3059\u95a2\u6570(\u6b63\u5f0f\u3067\u306f\u306a\u3044\u304c\u3053\u3053\u3067\u306f\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u95a2\u6570\u3068\u3044\u3046\u3002\u5b9f\u969b\u306b\u30bd\u30fc\u30b9\u5185\u3067\u306f\u3053\u308c\u3089\u306e\u95a2\u6570\u306f\u30de\u30af\u30ed\u3092\u7528\u3044\u3066\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3092\u547c\u3073\u51fa\u3059)\u3092\u66f8\u304d\u63db\u3048\u308c\u3070\u3044\u3044\u3053\u3068\u306b\u306a\u308b\u3002Linux\u3067\u306f\u3053\u308c\u3089\u306e\u95a2\u6570\u306fglibc\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u5185\u306e sysdeps/unix/sysv/linux/ \u4ee5\u4e0b\u306b\u307e\u3068\u307e\u3063\u3066\u3044\u308b\u3002 \u5b9f\u969b\u306b\u3069\u306e\u95a2\u6570\u3092\u30d5\u30c3\u30af\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u304b\u306f\u3001\u7c21\u5358\u306a\u30b3\u30de\u30f3\u30c9\u3092ltrace\u3084strace\u3067\u30c8\u30ec\u30fc\u30b9\u3057\u306a\u304c\u3089\u5224\u5b9a\u3059\u308b\u3002\u4f8b\u3048\u3070\u4ee5\u4e0b\u306f\u4e00\u3064\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u5bfe\u3059\u308bcat\u3092ltrace\u3057\u305f\u7d50\u679c\u3067\u3042\u308b\u3002 1 2 3 4 5 6 7 8 9 10 11 12 $ ltrace cat file ################ \u5fc5\u8981\u306a\u90e8\u5206\u306e\u307f\u629c\u7c8b open ( \"file\" , 00 , 037777400000 ) = open ( \"file\" , O_RDONLY ) = 3 fstat ( 3 , 0x7ffd1d8874b0 ) = 0 posix_fadvise ( 3 , 0 , 0 , 2 ) = 0 aligned_alloc ( 4096 , 0x20000, 0 , 0x7f44742fe47a ) = 0x7f4474462000 read ( 3 , \"this is a source file\" , 131072 ) = 21 write ( 1 , \"this is a source file\" , 21this is a source file ) = 21 read ( 3 , \"\" , 131072 ) = 0 free ( 0x7f4474462000 ) = <void> close ( 3 ) = 0 ################ \u307e\u305afile\u3092read only\u3067open\u3057\u3001\u8fd4\u3063\u3066\u6765\u305f\u30d5\u30a1\u30a4\u30eb\u8b58\u5225\u5b50\u306b\u5bfe\u3057\u3066\u3001fstat,read\u3092\u5b9f\u884c\u3057\u3066\u3001\u6700\u5f8c\u306bclose\u3059\u308b\u3002\u3053\u306e\u5834\u5408\u3001\u30ea\u30e2\u30fc\u30c8\u306e\u30d5\u30a1\u30a4\u30eb\u3092read\u6a29\u9650\u3067open\u3059\u308b\u969b\u306f\u30d5\u30a1\u30a4\u30eb\u306e\u5185\u5bb9\u3092Drive\u306eAPI\u3092\u5229\u7528\u3057\u3066\u30ea\u30e2\u30fc\u30c8\u304b\u3089\u53d6\u5f97\u3057\u3066\u30ed\u30fc\u30ab\u30eb\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306b\u79fb\u3057\u305d\u306e\u30d5\u30a1\u30a4\u30eb\u8b58\u5225\u5b50\u3092\u8fd4\u305b\u3070\u826f\u3044\u3002\u305d\u306e\u5f8c\u306eread\u306f\u3053\u306e\u30ed\u30fc\u30ab\u30eb\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u5bfe\u3057\u3066\u884c\u3046\u306e\u3067\u3001\u30d5\u30c3\u30af\u306e\u5fc5\u8981\u306f\u306a\u3044\u3002 \u4ed6\u306e\u4f8b\u3068\u3057\u3066\u3001cp\u306eltrace\u306e\u7d50\u679c\u3092\u793a\u3059\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 $ ltrace cp file dup #################### \u5fc5\u8981\u306a\u90e8\u5206\u306e\u307f\u629c\u7c8b open ( \"dup\" , O_RDONLY | O_PATH | O_DIRECTORY, 027516111125 ) = -1 __errno_location () = 0x7f8fb847f698 fstatat ( AT_FDCWD, \"file\" , 0x7fffbd387960 ) = 0 open ( \"file\" , 00 , 00 ) = 3 fstat ( 3 , 0x7fffbd387b10 ) = 0 openat ( AT_FDCWD, \"dup\" , O_WRONLY | O_CREAT | O_EXCL, 0644 ) = 4 __errno_location () = 0x7f8fb847f698 ioctl ( 4 , 1074041865 , 0x3 ) = -1 fstat ( 4 , 0x7fffbd387a80 ) = 0 posix_fadvise ( 3 , 0 , 0 , 2 ) = 0 copy_file_range ( 3 , 0 , 4 , 0 ) = 21 copy_file_range ( 3 , 0 , 4 , 0 ) = 0 close ( 4 ) = 0 close ( 3 ) = 0 #################### \u307e\u305a\u30b3\u30d4\u30fc\u5148\u306e\u30d1\u30b9\u304c\u30d5\u30a1\u30a4\u30eb\u304b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304b\u5b58\u5728\u3059\u308b\u304b\u3069\u3046\u304b\u3092open\u3067\u5224\u5b9a\u3057\u3001\u30d5\u30a1\u30a4\u30eb\u3067\u3042\u308b\u5834\u5408\u306fwrite\u6a29\u9650\u3067\u305d\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u958b\u304f\u3002\u305d\u306e\u5f8c\u5185\u5bb9\u3092\u30b3\u30d4\u30fc\u3057\u3066close\u3059\u308b\u3002\u3053\u306e\u5834\u5408\u3001write\u6a29\u9650\u3067\u30c9\u30e9\u30a4\u30d6\u4e0a\u306e\u30d1\u30b9\u3092\u6307\u5b9a\u3057\u3066open\u3057\u305f\u5834\u5408\u3001\u30d5\u30a1\u30a4\u30eb\u304c\u30c9\u30e9\u30a4\u30d6\u4e0a\u306b\u306a\u3051\u308c\u3070\u4f5c\u6210\u3057\u3001\u30ed\u30fc\u30ab\u30eb\u306e\u30d5\u30a1\u30a4\u30eb\u3068\u3057\u3066\u958b\u304f\u3002\u66f4\u306b\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u3092close\u3059\u308b\u3068\u304d\u306f\u3001\u5909\u66f4\u3092\u30c9\u30e9\u30a4\u30d6\u306b\u4fdd\u5b58\u3059\u308b\u3088\u3046\u306b\u5909\u66f4\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002 \u4eca\u56deSommelier Drive\u304b\u3089\u63d0\u4f9b\u3055\u308c\u308bAPI\u306f\u4ee5\u4e0b\u3067\u3042\u308b\u3002 addFile \u30d1\u30b9\u540d\u3092\u6307\u5b9a\u3057\u3066\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b addDirectory \u30d1\u30b9\u540d\u3092\u6307\u5b9a\u3057\u3066\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3059\u308b getChildrenPathes \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u5b9a\u3057\u3066\u3001\u30a8\u30f3\u30c8\u30ea\u4e00\u89a7\u3092\u53d6\u5f97\u3059\u308b isExistFilepath \u30d1\u30b9\u306e\u6709\u7121\u3092\u53d6\u5f97\u3059\u308b modifyFile \u30d5\u30a1\u30a4\u30eb\u306e\u5185\u5bb9\u3092\u5909\u66f4\u3059\u308b openFilepath \u30d1\u30b9\u3092\u958b\u304d\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u3084\u30d5\u30a1\u30a4\u30eb\u306e\u5185\u5bb9\u3092\u53d6\u5f97\u3059\u308b\u3002 searchDescendantPathes \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u5b9a\u3057\u3066\u5b50\u5b6b\u306e\u4e00\u89a7\u3092\u53d6\u5f97\u3059\u308b \u3053\u308c\u3089\u306eAPI\u3092\u7528\u3044\u3066\u5b9f\u88c5\u3067\u304d\u308b\u7bc4\u56f2\u3067\u3001glibc\u306e\u95a2\u6570\u3092\u30d5\u30c3\u30af\u3059\u308b\u3002\u305f\u3060\u3057\u3053\u308c\u3089\u306eAPI\u306f\u73fe\u6bb5\u968e\u3067\u306f\u304b\u306a\u308a\u6642\u9593\u304c\u304b\u304b\u308b\u306e\u3067\u3001\u547c\u3073\u51fa\u3057\u3092\u6975\u529b\u6e1b\u3089\u3059\u5b9f\u88c5\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u3063\u305f\u3002 \u4ee5\u4e0b\u306b\u5909\u66f4\u3092\u52a0\u3048\u305f sysdeps/unix/sysv/linux/ \u306e\u95a2\u6570\u3092\u793a\u3059\u3002 open/openat \u30d5\u30c3\u30af\u306e\u5927\u90e8\u5206\u3092\u69cb\u6210\u3059\u308b\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u95a2\u6570\u3002\u4e0a\u306b\u8ff0\u3079\u305f\u3068\u304a\u308a\u3001\u5f15\u6570\u3067\u3042\u308b\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\u3068\u30d5\u30e9\u30b0\u3092\u5224\u5b9a\u3057\u3066\u3001\u30d1\u30b9\u540d\u304c\u30c9\u30e9\u30a4\u30d6\u306e\u3082\u306e\u3067\u3042\u3063\u305f\u5834\u5408\u306f\u3001\u30d5\u30e9\u30b0\u306e\u7d44\u307f\u5408\u308f\u305b\u306b\u5fdc\u3058\u3066\u30c9\u30e9\u30a4\u30d6\u4e0a\u306e\u30d1\u30b9\u306b\u5bfe\u3057\u3066\u7279\u5b9a\u306e\u51e6\u7406\u3092\u884c\u3046\u3088\u3046\u306b\u8a2d\u8a08\u3057\u305f\u3002\u307e\u305fopenat\u306f\u7b2c\u4e00\u5f15\u6570\u306b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u8b58\u5225\u5b50\u3092\u6307\u5b9a\u3059\u308b\u304c\u3001\u3053\u308c\u304c\u30c9\u30e9\u30a4\u30d6\u4e0a\u306e\u3082\u306e\u3067\u3042\u308b\u5834\u5408\u3082\u3001\u7279\u5225\u306a\u51e6\u7406\u304c\u5fc5\u8981\u306b\u306a\u308b\u3002\u4eca\u56defopen\u3084creat\u306a\u3069\u3067\u4f7f\u7528\u3055\u308c\u308bO_RDONLY,\u3000O_WRONLY,\u3000O_RDWR, O_CREAT, O_EXCL, O_TRUNC, O_APPEND, O_DIRECTORY\u306e8\u3064\u306e\u30d5\u30e9\u30b0\u306b\u5bfe\u5fdc\u3057\u305f\u3002 close/fsync O_WRONLY\u304bO_RDWR\u3092\u6307\u5b9a\u3057\u3066open\u3057\u305f\u30c9\u30e9\u30a4\u30d6\u4e0a\u306e\u30d5\u30a1\u30a4\u30eb\u306f\u3053\u308c\u3089\u306e\u95a2\u6570\u304c\u547c\u3070\u308c\u308b\u969b\u306b\u30ed\u30fc\u30ab\u30eb\u3067\u7de8\u96c6\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u5185\u5bb9\u3092\u30c9\u30e9\u30a4\u30d6\u306b\u4fdd\u5b58\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002 fsync\u306f\u30d5\u30a1\u30a4\u30eb\u306e\u5909\u66f4\u3092\u30c7\u30a3\u30b9\u30af\u306b\u53cd\u6620\u3059\u308b\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u95a2\u6570\u3067\u3042\u308b\u3002close\u95a2\u6570\u306b\u52a0\u3048\u3066\u3053\u306e\u95a2\u6570\u3092\u5909\u66f4\u3057\u305f\u306e\u306f\u3001nano\u30b3\u30de\u30f3\u30c9\u3067\u30ea\u30e2\u30fc\u30c8\u306e\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u7de8\u96c6\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u3067\u3042\u308b\u3002\u3053\u306e\u30b3\u30de\u30f3\u30c9\u306e\u6319\u52d5\u3092ltrace\u3067\u8abf\u3079\u305f\u3068\u3053\u308d\u3001Ctrl-S\u304c\u62bc\u3055\u308c\u308b\u305f\u3073\u306bfsync\u95a2\u6570\u3092\u547c\u3073\u51fa\u3059\u304c\u3001\u7d42\u4e86\u6642\u306bclose\u95a2\u6570\u3092\u547c\u3073\u51fa\u3055\u306a\u304b\u3063\u305f\u3002\u305d\u306e\u305f\u3081\u3001\u30c9\u30e9\u30a4\u30d6\u4e0a\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u5bfe\u3057\u3066fsync\u304c\u547c\u3070\u308c\u308b\u305f\u3073\u306b\u5909\u66f4\u3092\u53cd\u6620\u3059\u308b\u51e6\u7406\u304c\u5fc5\u8981\u306b\u306a\u3063\u305f\u3002 fstatat \u30d5\u30a1\u30a4\u30eb\u3084\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\u95a2\u6570\u3067\u3001\u672c\u74b0\u5883\u306e\u5b9f\u88c5\u3067\u306f\u5185\u90e8\u3067newfstatat\u3068\u3044\u3046\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3092\u547c\u3073\u51fa\u3059\u3002stat/fstat/lstat/statx\u3068\u3044\u3063\u305f\u95a2\u6570\u3082\u3001\u30d5\u30e9\u30b0\u3092\u6307\u5b9a\u3057\u3066\u3053\u306e\u95a2\u6570\u3092\u547c\u3073\u51fa\u3059\u306e\u3067\u3001\u5909\u66f4\u306f\u3053\u306e\u95a2\u6570\u306e\u307f\u3067\u3088\u3044(\u305f\u3060\u3057\u3001\u74b0\u5883\u306b\u3088\u3063\u3066\u306f\u3053\u308c\u3089\u306e\u95a2\u6570\u306f\u540c\u540d\u306e\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3092\u547c\u3073\u51fa\u3059\u306e\u3067\u3042\u304f\u307e\u3067\u672c\u74b0\u5883\u306e\u307f\u3067\u306e\u5b9f\u88c5\u3067\u3042\u308b)\u3002\u73fe\u30c9\u30e9\u30a4\u30d6\u306e\u5b9f\u88c5\u3067\u306f\u30d5\u30a1\u30a4\u30eb\u304c\u4fdd\u6301\u3059\u308b\u60c5\u5831\u306e\u7a2e\u985e\u306f\u3055\u307b\u3069\u591a\u304f\u306a\u3044\u306e\u3067\u3001\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u3068\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u306e\u307f\u53d6\u5f97\u3057\u3001\u4ed6\u306e\u60c5\u5831\u306f0\u3067\u57cb\u3081\u308b\u8a2d\u8a08\u306b\u3057\u305f\u3002 opendir/fdopendir/readdir/closedir \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30a8\u30f3\u30c8\u30ea\u4e00\u89a7\u3092\u8fd4\u3059\u4e00\u9023\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u95a2\u6570\u3067\u3042\u308a\u3001ls, find\u3068\u3044\u3063\u305f\u30b3\u30de\u30f3\u30c9\u3084\u30b7\u30a7\u30eb\u306e\u30d1\u30b9\u540d\u88dc\u5b8c\u6a5f\u80fd\u306a\u3069\u3067\u7528\u3044\u3089\u308c\u3066\u3044\u308b\u3002\u305d\u308c\u305e\u308copen/getdent/close\u3068\u3044\u3063\u305f\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u95a2\u6570\u3092\u547c\u3073\u51fa\u3059\u304c\u3001\u30a8\u30f3\u30c8\u30ea\u4e00\u89a7\u3092\u53d6\u5f97\u3059\u308b\u305f\u3081\u306b\u3053\u308c\u3089\u304c\u76f4\u63a5\u547c\u3070\u308c\u308b\u3053\u3068\u306f\u3081\u3063\u305f\u306b\u306a\u3044\u306e\u3067\u3001\u4e0a\u8a18\u306e\u95a2\u6570\u306e\u307f\u3092\u5909\u66f4\u3057\u305f\u3002 mkdir \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3059\u308b\u95a2\u6570\u3067\u3001\u30ea\u30e2\u30fc\u30c8\u306e\u30d1\u30b9\u304c\u6307\u5b9a\u3055\u308c\u305f\u3068\u304d\u306b\u5bfe\u5fdc\u3059\u308bAPI\u3092\u547c\u3073\u51fa\u3059\u3088\u3046\u306b\u5909\u66f4\u3059\u308c\u3070\u826f\u3044\u3002\u3057\u304b\u3057C\u306e\u30d5\u30a1\u30a4\u30eb\u304c\u898b\u5f53\u305f\u3089\u305a\u3001\u30d3\u30eb\u30c9\u3092\u305f\u3069\u3063\u305f\u3068\u3053\u308d\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u30a2\u30bb\u30f3\u30d6\u30ea\u3092\u751f\u6210\u3057\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u3044\u308b\u3088\u3046\u3060\u3063\u305f\u3002\u4e00\u90e8\u306e\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u95a2\u6570\u306f\u540c\u69d8\u306e\u65b9\u6cd5\u3067\u30b3\u30f3\u30d1\u30a4\u30eb\u3055\u308c\u3066\u3044\u308b\u3088\u3046\u3060\u3063\u305f\u304c\u3001\u305d\u308c\u3089\u306e\u95a2\u6570\u3092\u6307\u5b9a\u3059\u308b\u90e8\u5206\u304c\u898b\u5f53\u305f\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u3001C\u8a00\u8a9e\u3067\u8a18\u8ff0\u3057\u3066\u5f37\u5f15\u3067\u3042\u308b\u304c\u3082\u3068\u306e\u30b7\u30f3\u30dc\u30eb\u3092\u4e0a\u66f8\u304d\u3059\u308b\u3053\u3068\u3067\u5bfe\u5fdc\u3057\u305f\u3002 init_drive/fini_drive \u30c9\u30e9\u30a4\u30d6\u63a5\u7d9a\u306b\u5fc5\u8981\u306a\u30b5\u30fc\u30d0\u3068\u30e6\u30fc\u30b6\u306e\u60c5\u5831\u3092\u74b0\u5883\u5909\u6570\u304b\u3089\u53d6\u5f97\u3059\u308b\u672c\u5b9f\u88c5\u72ec\u81ea\u306e\u95a2\u6570\u3067\u3042\u308b\u3002\u305d\u308c\u305e\u308c\u4ee5\u4e0b\u306e\u3088\u3046\u306b __attribute__((constructor)) \u3068 __attribute__((destructor)) \u3067\u5ba3\u8a00\u3057\u3066\u3044\u308b\u3002 1 2 static void __attribute__ (( constructor )) init_drive ( void ); static void __attribute__ (( destructor )) fini_drive ( void ); \u3053\u306e\u5c5e\u6027\u3092\u6307\u5b9a\u3057\u3066\u5ba3\u8a00\u3057\u305f\u95a2\u6570\u306f\u3001\u30e9\u30a4\u30d6\u30e9\u30ea\u304c\u30e1\u30e2\u30ea\u306b\u30ed\u30fc\u30c9\u3055\u308c\u308b\u969b\u3068\u30d7\u30ed\u30b0\u30e9\u30e0\u304c\u7d42\u4e86\u3059\u308b\u969b\u306b\u305d\u308c\u305e\u308c\u81ea\u52d5\u7684\u306b\u547c\u3073\u51fa\u3055\u308c\u308b\u3002Sommelier Drive \u306eAPI\u3092\u547c\u3073\u51fa\u3059\u305f\u3073\u306b\u74b0\u5883\u5909\u6570\u304b\u3089\u60c5\u5831\u3092\u53d6\u5f97\u3057\u3066\u691c\u8a3c\u3059\u308b\u306e\u306f\u5197\u9577\u306b\u306a\u308b\u306e\u3067\u3001\u30ed\u30fc\u30c9\u6642\u306e\u307f\u8aad\u307f\u8fbc\u3093\u3067\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u30c7\u30fc\u30bf\u3092\u4fdd\u6301\u3059\u308b\u9818\u57df\u306b\u4fdd\u5b58\u3059\u308b\u3053\u3068\u306b\u3057\u305f\u3002\u307e\u305f init_drive \u95a2\u6570\u5185\u3067API\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3092 dlopen \u3067\u30ed\u30fc\u30c9\u3059\u308b\u3002\u901a\u5e38\u306f\u5916\u90e8\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3068\u306e\u30ea\u30f3\u30af\u306f\u3001\u30e9\u30a4\u30d6\u30e9\u30ea\u751f\u6210\u6642\u306b\u884c\u3046\u3082\u306e\u3060\u304c\u3001glibc\u306f\u30d3\u30eb\u30c9\u306b\u72ec\u81ea\u5b9f\u88c5\u4ee5\u5916\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u5fc5\u8981\u3068\u3057\u306a\u3044\u8a2d\u8a08\u3068\u306a\u3063\u3066\u3044\u3066Rust\u3067\u4f5c\u6210\u3057\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u3068\u30ea\u30f3\u30af\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u304b\u3063\u305f\u305f\u3081\u3001\u4ee3\u66ff\u7b56\u3068\u3057\u3066\u5b9f\u884c\u6642\u306b\u52d5\u7684\u306b\u30ea\u30f3\u30af\u3059\u308b\u624b\u6cd5\u3092\u3068\u3063\u305f\u3002 \u30d3\u30eb\u30c9\u306e\u65b9\u6cd5\u3068\u554f\u984c\u70b9 \u6df1\u523b\u306a\u554f\u984c\u3060\u304cmake\u306b\u3088\u308b\u30d3\u30eb\u30c9\u304c\u5931\u6557\u3059\u308b\u3002\u672c\u6765\u306e\u30d3\u30eb\u30c9\u306f\u5358\u7d14\u306b\u30d3\u30eb\u30c9\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u79fb\u52d5\u3057\u3066 <source path>/configure \u3068 make \u3067\u6e08\u3080\u306e\u306f\u305a\u3060\u304c\u3001\u5b9f\u88c5\u306b\u5909\u66f4\u3092\u52a0\u3048\u305f\u305f\u3081\u306b\u3053\u306e\u30d3\u30eb\u30c9\u65b9\u6cd5\u3067\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u306b\u3088\u308a\u6b62\u307e\u3063\u3066\u3057\u307e\u3046\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 for symbol in __GI___pthread_disable_asynccancel __GI___pthread_enable_asynccancel __pthread_disable_asynccancel __pthread_enable_asynccancel calloc free malloc realloc __stack_chk_fail __stack_chk_fail_local; do \\ echo \".globl $symbol\"; \\ echo \"$symbol:\"; \\ done | gcc -o /home/sitianos/Project/Drive/build/elf/librtld.mapT.o -g -Werror=undef -Wa,--noexecstack -c -x assembler - gcc -nostdlib -nostartfiles -r -o /home/sitianos/Project/Drive/build/elf/librtld.map.o /home/sitianos/Project/Drive/build/elf/librtld.mapT.o '-Wl,-(' /home/sitianos/Project/Drive/build/elf/dl-allobjs.os /home/sitianos/Project/Drive/build/libc_pic.a -lgcc '-Wl,-)' -Wl,-Map,/home/sitianos/Project/Drive/build/elf/librtld.mapT /usr/bin/ld: /home/sitianos/Project/Drive/build/libc_pic.a(getcwd.os): in function `__GI___getcwd': /home/sitianos/Project/Drive/glibc-drive/io/../sysdeps/unix/sysv/linux/getcwd.c:49: multiple definition of `__getcwd'; /home/sitianos/Project/Drive/build/elf/dl-allobjs.os:/home/sitianos/Project/Drive/glibc-drive/elf/../sysdeps/unix/sysv/linux/getcwd.c:49: first defined here /usr/bin/ld: /home/sitianos/Project/Drive/build/libc_pic.a(dl-error.os): in function `__GI__dl_signal_exception': /home/sitianos/Project/Drive/glibc-drive/elf/dl-error-skeleton.c:91: multiple definition of `_dl_signal_exception'; /home/sitianos/Project/Drive/build/elf/dl-allobjs.os:/home/sitianos/Project/Drive/glibc-drive/elf/dl-error-skeleton.c:91: first defined here /usr/bin/ld: /home/sitianos/Project/Drive/build/libc_pic.a(dl-error.os): in function `__GI__dl_signal_error': /home/sitianos/Project/Drive/glibc-drive/elf/dl-error-skeleton.c:109: multiple definition of `_dl_signal_error'; /home/sitianos/Project/Drive/build/elf/dl-allobjs.os:/home/sitianos/Project/Drive/glibc-drive/elf/dl-error-skeleton.c:109: first defined here /usr/bin/ld: /home/sitianos/Project/Drive/build/libc_pic.a(dl-error.os): in function `__GI__dl_catch_exception': /home/sitianos/Project/Drive/glibc-drive/elf/dl-error-skeleton.c:175: multiple definition of `_dl_catch_exception'; /home/sitianos/Project/Drive/build/elf/dl-allobjs.os:/home/sitianos/Project/Drive/glibc-drive/elf/dl-error-skeleton.c:175: first defined here /usr/bin/ld: /home/sitianos/Project/Drive/build/libc_pic.a(dl-error.os): in function `__GI__dl_catch_error': /home/sitianos/Project/Drive/glibc-drive/elf/dl-error-skeleton.c:225: multiple definition of `_dl_catch_error'; /home/sitianos/Project/Drive/build/elf/dl-allobjs.os:/home/sitianos/Project/Drive/glibc-drive/elf/dl-error-skeleton.c:225: first defined here collect2: error: ld returned 1 exit status \u8868\u793a\u306b\u3042\u308b\u3088\u3046\u306b\u95a2\u6570\u306e\u591a\u91cd\u5b9a\u7fa9\u306b\u3088\u308b\u30a8\u30e9\u30fc\u3067\u3042\u308b\u304c\u3001\u6307\u6458\u3055\u308c\u3066\u3044\u308b\u95a2\u6570\u306f\u5b9f\u88c5\u3092\u5909\u66f4\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u5185\u3067\u306f\u7528\u3044\u3066\u306a\u3044\u3002\u5b9f\u969b\u306b libc_pic.a \u3068 dl-allobjs.os \u5185\u306e\u30b7\u30f3\u30dc\u30eb\u3092\u78ba\u8a8d\u3057\u305f\u3068\u3053\u308d\u78ba\u304b\u306b\u540c\u3058\u95a2\u6570\u304c\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u305f\u304c\u3001\u30d5\u30a1\u30a4\u30eb\u306b\u5909\u66f4\u3092\u52a0\u3048\u308b\u3053\u3068\u3067\u305d\u306e\u3088\u3046\u306a\u72b6\u6cc1\u306b\u306a\u308b\u7406\u7531\u304c\u308f\u304b\u3089\u306a\u304b\u3063\u305f\u3002 dlopen \u3092\u4f7f\u7528\u3057\u305f\u3053\u3068\u304c\u539f\u56e0\u3068\u8003\u3048\u3066\u3053\u306e\u8a18\u8ff0\u3092\u6d88\u3057\u305f\u308a\u3001\u540c\u3058\u5b9a\u7fa9\u3092\u6307\u3057\u3066\u306e\u30a8\u30e9\u30fc\u3067\u3042\u308b\u3053\u3068\u304b\u3089 -fcommon \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u52a0\u3048\u305f\u308a\u306a\u3069\u8a66\u307f\u305f\u304c\u89e3\u6d88\u3057\u306a\u304b\u3063\u305f\u3002\u4e0a\u8a18\u306e\u30ec\u30b7\u30d4\u306f\u52d5\u7684\u30ea\u30f3\u30abld-linux.so\u3092\u4f5c\u6210\u3059\u308b\u4e00\u74b0\u306e\u3082\u306e\u3067\u3042\u308b\u304c\u3001\u76ee\u7684\u306elibc.so\u3092\u4f5c\u6210\u3059\u308b\u306b\u306fld-linux.so\u3078\u306e\u30ea\u30f3\u30af\u304c\u5fc5\u8981\u3067\u3042\u308b\u305f\u3081\u3001\u3053\u308c\u4ee5\u964d\u30d3\u30eb\u30c9\u306f\u9032\u307e\u306a\u3044\u3002ld-linux.so\u3092\u4f5c\u6210\u3059\u308b\u4e00\u9023\u306e\u30d3\u30eb\u30c9\u95a2\u9023\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u3093\u3067\u307f\u305f\u3082\u306e\u306e\u539f\u56e0\u306e\u7279\u5b9a\u306b\u306f\u81f3\u3089\u306a\u304b\u3063\u305f\u3002\u73fe\u6bb5\u968e\u3067\u306f\u304b\u306a\u308a\u5f37\u5f15\u3067\u3042\u308b\u3082\u306e\u306e\u4ee5\u4e0b\u306e\u65b9\u6cd5\u3067\u30d3\u30eb\u30c9\u3067\u304d\u308b\u3002 sysdeps/unix/sysv/linux/drive-common.h \u306e DRIVE_EXT \u30de\u30af\u30ed\u30920\u306b\u30bb\u30c3\u30c8\u3057\u3066\u3001 configure \u3068 make \u3067\u30d3\u30eb\u30c9\u3059\u308b\u3002 sysdeps/unix/sysv/linux/drive-common.h \u306e DRIVE_EXT \u30de\u30af\u30ed\u30921\u306b\u30bb\u30c3\u30c8\u3057\u3066\u3001 make -k \u3092\u5b9f\u884c\u3059\u308b\u3002 1\u306b\u3088\u308a\u5909\u66f4\u3092\u542b\u3081\u306a\u3044\u901a\u5e38\u901a\u308a\u306e\u30d3\u30eb\u30c9\u3092\u5b9f\u884c\u3057\u3066libc.so\u306b\u5fc5\u8981\u306a\u30d5\u30a1\u30a4\u30eb\u304c\u751f\u6210\u3059\u308b\u30022\u3067\u306fld.so\u4f5c\u6210\u4e0a\u306e\u30a8\u30e9\u30fc\u3092\u7121\u8996\u3057\u3066\u3001\u5909\u66f4\u3092\u52a0\u3048\u305f\u95a2\u6570\u3092\u542b\u3081\u305flibc.so\u3092\u4f5c\u6210\u3059\u308b\u3002\u4f9d\u5b58\u4e0a\u3067\u5fc5\u8981\u306a\u30d5\u30a1\u30a4\u30eb\u306f1\u3067\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001ld.so\u306e\u4f5c\u6210\u3067\u30a8\u30e9\u30fc\u306f\u51fa\u529b\u3055\u308c\u308b\u3082\u306e\u306e\u3001\u76ee\u7684\u306elibc.so\u306f\u751f\u6210\u3055\u308c\u308b\u3002 \u3053\u306e\u3088\u3046\u306b\u5f37\u5f15\u306a\u30d3\u30eb\u30c9\u65b9\u6cd5\u306a\u306e\u3067\u3001\u30d3\u30eb\u30c9\u5f8c\u306e\u30d0\u30a4\u30ca\u30ea\u3068\u3057\u3066Debian\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u4f5c\u6210\u3057\u305f\u3002 2\u3064\u76ee\u306e\u554f\u984c\u3068\u3057\u3066\u3001libc.so\u3092LD_PRELOAD\u306b\u6307\u5b9a\u3057\u3066\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u305f\u969b\u306b\u3001Segmentation Fault\u3067\u843d\u3061\u3066\u3057\u307e\u3046\u3068\u3044\u3046\u3082\u306e\u304c\u3042\u3063\u305f\u3002gdb\u3067\u8abf\u3079\u305f\u3068\u3053\u308d\u3001\u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u30ed\u30fc\u30c9\u3059\u308b\u969b\u306b\u30a2\u30af\u30bb\u30b9\u9055\u53cd\u304c\u751f\u3058\u3066\u3044\u305f\u3002\u540c\u69d8\u306e\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u305f\u4f8b\u3092\u63a2\u3057\u305f\u3068\u3053\u308d\u3001 CTF\u306e\u8a18\u4e8b \u304c\u898b\u3064\u304b\u308a\u3001\u3053\u308c\u306b\u3088\u308b\u3068libc.so\u306fld-linux.so\u306e\u69cb\u9020\u4f53\u3092\u53c2\u7167\u3057\u3066\u3044\u308b\u304c\u3001\u3053\u306e\u30e1\u30f3\u30d0\u306e\u914d\u7f6e\u304c\u30d0\u30fc\u30b8\u30e7\u30f3\u3054\u3068\u306b\u7570\u306a\u308b\u305f\u3081\u3001\u5b9f\u969b\u306b\u52d5\u3044\u3066\u3044\u308bld-linux.so\u3068\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u5408\u308f\u305b\u308b\u5fc5\u8981\u304c\u3042\u308b\u3068\u3044\u3046\u3002\u305d\u306e\u305f\u3081\u3001glibc\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u5b9f\u6a5f\u306e\u3082\u306e\u306b\u63c3\u3048\u3066\u518d\u30d3\u30eb\u30c9\u3057\u3066\u3001preload\u3057\u305f\u3068\u3053\u308d\u554f\u984c\u306a\u304f\u95a2\u6570\u306e\u30d5\u30c3\u30af\u304c\u6210\u529f\u3057\u305f\u3002\u3053\u306e\u5236\u7d04\u306f\u975e\u5e38\u306b\u554f\u984c\u306a\u306e\u3067\u3001\u30d5\u30c3\u30af\u306b\u5fc5\u8981\u306a\u95a2\u6570\u306e\u4f9d\u5b58\u3092\u8abf\u3079\u90e8\u5206\u7684\u306b\u30ea\u30f3\u30af\u3057\u3066\u3001\u52d5\u7684\u30ea\u30f3\u30ab\u3092\u5fc5\u8981\u3068\u3057\u306a\u3044\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u5236\u4f5c\u3057\u3088\u3046\u3068\u3057\u305f\u304c\u3001\u30d3\u30eb\u30c9\u95a2\u9023\u306e\u8a2d\u5b9a\u304c\u8907\u96d1\u3067\u3042\u3063\u305f\u306e\u3067\u3001\u3072\u3068\u307e\u305aglibc\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u63c3\u3048\u305fVM\u306a\u3069\u306e\u74b0\u5883\u3067\u52d5\u304b\u3059\u3053\u3068\u3067\u5bfe\u5fdc\u3057\u305f\u3002 \u6319\u52d5\u306e\u30c6\u30b9\u30c8 \u203b \u30c6\u30b9\u30c8\u306f\u5b9f\u6a5f\u3067\u884c\u3048\u308b\u304c\u601d\u308f\u306c\u30d0\u30b0\u3092\u751f\u3058\u308b\u53ef\u80fd\u6027\u304c\u3042\u308b\u305f\u3081\u4ee5\u4e0b\u306e\u74b0\u5883\u3092\u69cb\u7bc9\u3057\u305fVM\u4e0a\u3067\u884c\u3046\u3002 \u74b0\u5883 OS: Linux (Debian\u7cfb) Arch: amd64 Libraries: libc6 (= 2.35) (\u4e0a\u306b\u8ff0\u3079\u305f\u7406\u7531\u304b\u3089\u73fe\u72b6\u3067\u306f\u3053\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u307f) libssl3 (>= 3.0.0) \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb \u30b7\u30b9\u30c6\u30e0\u306eglibc\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u78ba\u8a8d\u3059\u308b 1 2 3 4 5 6 7 8 9 10 $ /usr/lib/x86_64-linux-gnu/libc.so.6 GNU C Library ( Debian GLIBC 2 .35-3 ) stable release version 2 .35. Copyright ( C ) 2022 Free Software Foundation, Inc. This is free software ; see the source for copying conditions. There is NO warranty ; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. Compiled by GNU CC version 11 .3.0. libc ABIs: UNIQUE IFUNC ABSOLUTE For bug reporting instructions, please see: <http://www.debian.org/Bugs/>. Debian\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3068\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u5b9f\u884c\u3059\u308b 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 $ curl -O https://github.com/Sommelier-db/sommelier-drive-glibc/raw/drive/sommelier-drive/sommelier-drive-glibc_1.1_amd64.deb $ dpkg-deb -c sommelier-drive-glibc_1.1_amd64.deb drwxr-xr-x root/root 0 2022 -11-09 04 :38 ./ drwxr-xr-x root/root 0 2022 -11-09 04 :39 ./usr/ drwxr-xr-x root/root 0 2022 -11-09 06 :42 ./usr/bin/ -rwxr-xr-x root/root 16264 2022 -11-09 06 :30 ./usr/bin/sommelier-register -rwxr--r-- root/root 1138 2022 -11-09 06 :42 ./usr/bin/sommelier-run drwxr-xr-x root/root 0 2022 -11-09 04 :47 ./usr/include/ -rw-r--r-- root/root 2372 2022 -11-09 04 :47 ./usr/include/sommelier_drive_client.h drwxr-xr-x root/root 0 2022 -11-09 04 :38 ./usr/lib/ drwxr-xr-x root/root 0 2022 -11-09 06 :42 ./usr/lib/x86_64-linux-gnu/ -rwxr-xr-x root/root 10318664 2022 -11-09 04 :47 ./usr/lib/x86_64-linux-gnu/libsommelier_drive_client.so -rwxr-xr-x root/root 12711832 2022 -11-09 06 :32 ./usr/lib/x86_64-linux-gnu/libsommelier_libc.so $ sudo dpkg -i sommelier-drive-glibc_1.1_amd64.deb \u30e6\u30fc\u30b6\u30fc\u306e\u767b\u9332 \u7acb\u3061\u4e0a\u3052\u305f\u30c9\u30e9\u30a4\u30d6\u306e\u30b5\u30fc\u30d0\u306b\u5bfe\u3057\u3066\u3001url\u3068\u30ea\u30fc\u30b8\u30e7\u30f3\u540d\u3068\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30d1\u30b9\u3092\u6307\u5b9a\u3057\u3066\u30e6\u30fc\u30b6\u3092\u767b\u9332\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30d5\u30a1\u30a4\u30eb\u304c\u751f\u6210\u3055\u308c\u308b\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 $ sommelier-register \"http://localhost:8000/api\" \"region\" \"/alice\" successfully registered. user id is 1 configuration is saved in drive_envs $ cat drive_envs # key to encrypt data print_data_sk () { cat << END_OF_FILE -----BEGIN PRIVATE KEY----- MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQDEvumJhkNvwPzx 1bB52SLrP6wS+DL+l+umOJ0rIsuuwWcbRS7cRejWwN7GYC0og6r0or ~~~~~~~~~~~~~~~~~~~~~~~~ j5WFyup4lgD0uwH9TLXsZj5s13fYs6HhyOBhJyDMbNvkz46Bi0U2kDQvAmiSAmCy ixu5XBCophbUe+H8uevbNQ== -----END PRIVATE KEY----- END_OF_FILE } # key to use for searchable encryption print_keyword_sk () { cat << END_OF_FILE {\"alphas\":[[8781683650687187445,1371472541923046913,15906317983419354644,7861644468431804003], ~~~~~~~~~~~~~~~~~~~~ ,169,67,239,123,187,54,92,20,230,126,253,242,134,179,34,38,135,162,88,13,158,42,195,234,189,122,158,196,206]} END_OF_FILE } # client user id export SOMMELIER_DRIVE_USER_ID = 1 # server to connect to export SOMMELIER_DRIVE_BASE_URL = http://localhost:8000/api # server region export SOMMELIER_DRIVE_REGION_NAME = region # remote home directory export SOMMELIER_DRIVE_HOME_DIR = /alice \u3053\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u30c9\u30e9\u30a4\u30d6\u3078\u306e\u63a5\u7d9a\u306b\u5fc5\u8981\u306a\u30b5\u30fc\u30d0\u306e\u60c5\u5831\u3068\u30012\u7a2e\u985e\u306e\u79d8\u5bc6\u9375\u3092\u542b\u3093\u3060\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306e\u60c5\u5831\u3092\u74b0\u5883\u5909\u6570\u306b\u8a2d\u5b9a\u3059\u308b\u8a18\u8ff0\u304c\u306a\u3055\u308c\u3066\u3044\u308b\u3002 \u30b3\u30de\u30f3\u30c9\u306e\u5b9f\u884c \u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u30e9\u30c3\u30d1\u30fc\u3068\u306a\u308b sommelier-run \u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u3042\u308b\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 #!/bin/sh # directory on which files on the remote drive are put export SOMMELIER_DRIVE_BASE_DIR = /tmp/drive rm -rf $SOMMELIER_DRIVE_BASE_DIR mkdir -p $SOMMELIER_DRIVE_BASE_DIR chmod 700 $SOMMELIER_DRIVE_BASE_DIR # whether to trace library calls export SOMMELIER_DRIVE_TRACE = 0 # load server info and user info . $PWD /drive_envs SOMMELIER_DRIVE_DATA_SK = $( mktemp -p $SOMMELIER_DRIVE_BASE_DIR ) print_data_sk > $SOMMELIER_DRIVE_DATA_SK export SOMMELIER_DRIVE_DATA_SK SOMMELIER_DRIVE_KEYWORD_SK = $( mktemp -p $SOMMELIER_DRIVE_BASE_DIR ) print_keyword_sk > $SOMMELIER_DRIVE_KEYWORD_SK export SOMMELIER_DRIVE_KEYWORD_SK # library path of Sommelier Drive API export SOMMELIER_DRIVE_LIBRARY_PATH = /usr/lib/x86_64-linux-gnu/libsommelier_drive_client.so # library to preload for function hooking export LD_PRELOAD = /usr/lib/x86_64-linux-gnu/libsommelier_libc.so # execute privided command exec $@ \u3053\u308c\u306b\u793a\u3059\u901a\u308a\u3001\u30e6\u30fc\u30b6\u767b\u9332\u6642\u306b\u4f5c\u6210\u3057\u305f\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3068\u3001Sommelier Drive\u306eAPI\u3092\u4fdd\u6301\u3059\u308b\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u74b0\u5883\u5909\u6570\u306b\u6307\u5b9a\u3057\u3001LD_PRELOAD\u306b\u4f5c\u6210\u3057\u305f\u95a2\u6570\u30d5\u30c3\u30af\u306e\u305f\u3081\u306elibc\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u6307\u5b9a\u3057\u3066\u4e0e\u3048\u3089\u308c\u305f\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3002 \u3053\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u7528\u3044\u3066\u3001\u30d5\u30a1\u30a4\u30eb\u3092\u6271\u3046\u30b3\u30de\u30f3\u30c9\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5b9f\u884c\u3057\u3066\u30c9\u30e9\u30a4\u30d6\u4e0a\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u64cd\u4f5c\u3059\u308b\u3002 1 $ sommelier-run command [ args ] \u5b9f\u969b\u306b\u52d5\u4f5c\u3059\u308b\u6a19\u6e96\u30b3\u30de\u30f3\u30c9\u3092\u3044\u304f\u3064\u304b\u7d39\u4ecb\u3059\u308b\u3002\u307e\u305a\u30d5\u30a1\u30a4\u30eb\u3068\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3059\u308b\u3002\u30c9\u30e9\u30a4\u30d6\u4e0a\u306e\u30d1\u30b9\u306f\u5148\u982d\u306b\"sommelier:\"\u3092\u3064\u3051\u3066\u6307\u5b9a\u3059\u308b\u3002 1 2 3 $ sommelier-run touch sommelier:/alice/file1 $ sommelier-run mkdir sommelier:/alice/dir1 \u3053\u308c\u3067\u5b9f\u969b\u306b\u30c9\u30e9\u30a4\u30d6\u4e0a\u306b\u30d5\u30a1\u30a4\u30eb\u3068\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u4f5c\u6210\u3055\u308c\u305f\u3002cp\u30b3\u30de\u30f3\u30c9\u306b\u3088\u308a\u3001\u30ed\u30fc\u30ab\u30eb-\u30ea\u30e2\u30fc\u30c8\u9593\u3001\u30ea\u30e2\u30fc\u30c8-\u30ea\u30e2\u30fc\u30c8\u9593\u3067\u30d5\u30a1\u30a4\u30eb\u3092\u8907\u88fd\u3067\u304d\u308b\u3053\u3068\u3082\u78ba\u8a8d\u3059\u308b\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 $ echo \"this is a local file\" > localfile $ sommelier-run cp localfile sommelier:/alice/file2 $ sommelier-run cat sommelier:/alice/file2 this is a local file $ sommelier-run cp sommelier:/alice/file2 sommelier:/alice/file3 $ sommelier-run cat sommelier:/alice/file3 this is a local file $ sommelier-run cp sommelier:/alice/file2 remotefile $ cat remotefile this is a local file \u6b21\u306bls\u30b3\u30de\u30f3\u30c9\u306b\u3088\u308a\u30ea\u30e2\u30fc\u30c8\u306b\u4f5c\u6210\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3068\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u78ba\u8a8d\u3059\u308b\u3002 1 2 3 4 5 6 $ sommelier-run ls -l sommelier:/alice/ total 0 drw------- 0 alice alice 0 Jan 1 1970 dir1 -rw------- 0 alice alice 0 Jan 1 1970 file1 -rw------- 0 alice alice 21 Jan 1 1970 file2 -rw------- 0 alice alice 21 Jan 1 1970 file3 \u30c9\u30e9\u30a4\u30d6\u8a2d\u8a08\u306e\u90fd\u5408\u306b\u3088\u308astat\u3067\u53d6\u5f97\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u306e\u60c5\u5831\u306b\u7a7a\u767d\u304c\u591a\u3044\u305f\u3081\u60c5\u5831\u306e\u8868\u793a\u306f\u3044\u3044\u52a0\u6e1b\u3060\u304c\u3001\u30a8\u30f3\u30c8\u30ea\u3068\u5c5e\u6027\u3001\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u306e\u8868\u793a\u304c\u3067\u304d\u3066\u3044\u308b\u3053\u3068\u306f\u78ba\u8a8d\u3067\u304d\u308b\u3002 1 $ sommelier-run nano sommelier:/alice/file3 \u6700\u5f8c\u306bnano\u30a8\u30c7\u30a3\u30bf\u3092\u8a66\u3059\u3002 1 $ sommelier-run nano sommelier:/alice/file3 \u30d5\u30a1\u30a4\u30eb\u306e\u7de8\u96c6\u306f\u6ede\u308a\u306a\u304f\u3067\u304d\u308b\u3082\u306e\u306e\u3001Ctrl-S\u3067\u5909\u66f4\u3092\u4fdd\u5b58\u3059\u308b\u306e\u306b\u306f\u304b\u306a\u308a\u6642\u9593\u3092\u8981\u3059\u308b\u3002 1 2 $ sommelier-run cat sommelier:/alice/file3 nano opened \u7d42\u308f\u308a\u306b \u4eca\u56de\u3001\u30ab\u30fc\u30cd\u30eb\u30ec\u30d9\u30eb\u3067\u5909\u66f4\u3092\u52a0\u3048\u308b\u4ee3\u308f\u308a\u306b\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u306e\u6319\u52d5\u3092LD_PRELOAD\u3068\u3044\u3046\u74b0\u5883\u5909\u6570\u3092\u7528\u3044\u3066\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3092\u547c\u3076\u95a2\u6570\u3092\u30d5\u30c3\u30af\u3059\u308b\u3068\u3044\u3046\u624b\u6cd5\u3067\u5909\u66f4\u3057\u305f\u304c\u3001\u3053\u306e\u4ed6\u306b\u3082\u95a2\u6570\u306e\u30d5\u30c3\u30af\u306e\u624b\u6cd5\u306f\u3042\u308b\u3088\u3046\u3060\u3002strace\u3084gdb\u3067\u4f7f\u7528\u3055\u308c\u3066\u3044\u308bptrace\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3092\u7528\u3044\u308b\u3082\u306e\u3082\u3042\u308c\u3070\u3001\u3053\u306e \u8a18\u4e8b \u3067\u7d39\u4ecb\u3055\u308c\u3066\u3044\u308b\u9ad8\u901f\u306b\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u30d5\u30c3\u30af\u3092\u5b9f\u73fe\u3059\u308b\u8208\u5473\u6df1\u3044\u624b\u6cd5\u3082\u5b58\u5728\u3059\u308b\u3002LD_PRELOAD\u3092\u30d5\u30c3\u30af\u306e\u7528\u9014\u3067\u7528\u3044\u308b\u306e\u306f\u3001\u30bd\u30b1\u30c3\u30c8\u901a\u4fe1\u306e\u30e9\u30c3\u30d1\u30fc\u3067\u3088\u304f\u76ee\u306b\u3059\u308b\u3002\u4f8b\u3048\u3070 proxychains \u3068\u3044\u3046\u30c4\u30fc\u30eb\u306fLD_PRELOAD\u306b\u3088\u308a\u901a\u4fe1\u306e\u95a2\u6570\u3092\u30d5\u30c3\u30af\u3057\u3066socks5\u30b5\u30fc\u30d0\u7d4c\u7531\u306b\u3059\u308b\u3002\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306b\u5bfe\u3059\u308b\u51e6\u7406\u3092\u66f8\u304d\u63db\u3048\u308b\u8a66\u307f\u306f\u4e00\u822c\u7684\u3067\u306a\u3044\u3088\u3046\u3060\u304c\u3001 fakeroot \u306a\u3069\u95a2\u6570\u30d5\u30c3\u30af\u306b\u3088\u308a\u985e\u4f3c\u306e\u3053\u3068\u3092\u884c\u3046\u30c4\u30fc\u30eb\u306f\u3042\u3063\u305f\u305f\u3081\u3001\u4eca\u56de\u6311\u6226\u3059\u308b\u306b\u81f3\u3063\u305f\u3002\u3059\u3067\u306b\u8ff0\u3079\u305f\u30d3\u30eb\u30c9\u4e0a\u306e\u554f\u984c\u306b\u52a0\u3048\u3001\u4e71\u96d1\u306a\u5b9f\u88c5\u306b\u306a\u308a\u8ab2\u984c\u3092\u6b8b\u3059\u7d50\u679c\u3068\u306a\u3063\u305f\u3082\u306e\u306e\u3001\u6700\u4f4e\u9650\u306e\u6a5f\u80fd\u306f\u5b9f\u73fe\u3067\u304d\u305f\u305f\u3081\u3001\u53d6\u308a\u7d44\u307f\u81ea\u4f53\u306b\u306f\u610f\u7fa9\u306f\u3042\u3063\u305f\u3082\u306e\u3068\u611f\u3058\u3066\u3044\u308b\u3002\u672c\u5b9f\u88c5\u306fSommelier Drive\u5b9f\u88c5\u306e\u5ef6\u9577\u3068\u3057\u3066API\u3092\u5229\u7528\u3059\u308b\u4e00\u3064\u306e\u65b9\u91dd\u3068\u3057\u3066\u500b\u4eba\u7684\u306b\u99b4\u67d3\u307f\u306e\u3042\u3063\u305fglibc\u3092\u5909\u66f4\u3059\u308b\u3068\u3044\u3046\u6848\u304b\u3089\u5b9f\u73fe\u3057\u305f\u3082\u306e\u3067\u3042\u308b\u3002\u6a5f\u80fd\u306e\u6539\u5584\u3068\u3044\u3046\u3088\u308a\u500b\u4eba\u5229\u7528\u306e\u958b\u767a\u306b\u8fd1\u3044\u3082\u306e\u3068\u306a\u3063\u305f\u304c\u3001\u666e\u6bb5\u8aad\u3080\u3060\u3051\u3067\u3042\u3063\u305f\u30b3\u30fc\u30c9\u306b\u624b\u3092\u52a0\u3048\u308b\u3053\u3068\u3067\u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9\u306b\u89e6\u308c\u308b\u3088\u3044\u7d4c\u9a13\u3068\u306a\u3063\u305f\u3002 \u53c2\u8003\u306b\u3057\u305f\u8a18\u4e8b\u3001\u30b5\u30a4\u30c8 [1] libc.so\u3092\u5dee\u3057\u66ff\u3048\u3066\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u52d5\u304b\u3059\uff08\u306e\u306f\u7121\u7406\u305d\u3046\uff09 [2] ptrace \u3088\u308a 100 \u500d\u901f\u3044\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u30d5\u30c3\u30af\u4f5c\u3063\u305f [3] proxychains [4] fakeroot","title":"glibc\u306e\u66f8\u304d\u63db\u3048\u306b\u3088\u308b\u30c9\u30e9\u30a4\u30d6\u4e0a\u306e\u30d5\u30a1\u30a4\u30eb\u3078\u306e\u30a2\u30af\u30bb\u30b9 [Japanese]"},{"location":"glibc/blog-ja/#glibc","text":"","title":"glibc\u306e\u66f8\u304d\u63db\u3048\u306b\u3088\u308b\u30c9\u30e9\u30a4\u30d6\u4e0a\u306e\u30d5\u30a1\u30a4\u30eb\u3078\u306e\u30a2\u30af\u30bb\u30b9"},{"location":"glibc/blog-ja/#author","text":"","title":"Author: \u897f\u4e95\u9065\u7d00"},{"location":"glibc/blog-ja/#_1","text":"\u3053\u3053\u3067\u306fSommelier Drive\u304c\u63d0\u4f9b\u3059\u308b\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u5074\u306eAPI\u3092\u5229\u7528\u3057\u3066\u3001Linux\u30de\u30b7\u30f3\u4e0a\u3067\u65e2\u5b58\u306e\u30b3\u30de\u30f3\u30c9\u3092\u7f6e\u304d\u63db\u3048\u308b\u3053\u3068\u306a\u304f\u901a\u5e38\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3068\u540c\u69d8\u306b\u30c9\u30e9\u30a4\u30d6\u4e0a\u306e\u30d5\u30a1\u30a4\u30eb\u3084\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6271\u3046\u3068\u3044\u3046\u8a66\u307f\u306b\u3064\u3044\u3066\u8ff0\u3079\u308b\u3002 Sommelier Drive\u304c\u63d0\u4f9b\u3059\u308b\u30c9\u30e9\u30a4\u30d6\u3092\u64cd\u4f5c\u3059\u308bAPI\u3092\u5229\u7528\u3059\u308b\u5b9f\u88c5\u306a\u306e\u3067\u3001\u53b3\u5bc6\u306b\u306fSommelier Drive\u3068\u306f\u5225\u7269\u3060\u304c\u5b9f\u88c5\u306e\u4e00\u8cab\u3068\u3057\u3066\u4f5c\u6210\u3057\u305f\u306e\u3067\u3001\u3053\u3053\u306b\u8a18\u8f09\u3055\u305b\u3066\u3044\u305f\u3060\u304f\u3002","title":"\u306f\u3058\u3081\u306b"},{"location":"glibc/blog-ja/#_2","text":"\u30ea\u30e2\u30fc\u30c8\u306b\u3042\u308b\u30c9\u30e9\u30a4\u30d6\u3092\u901a\u5e38\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u540c\u69d8\u306b\u6271\u3046\u3068\u3044\u3046\u4e3b\u65e8\u3067\u3001\u4eca\u56de\u306f\u30b7\u30f3\u30d7\u30eb\u306b\u30bf\u30fc\u30df\u30ca\u30eb\u4e0a\u3067\u6271\u3046ls\u3084cat\u3084touch\u3068\u3044\u3063\u305f\u30b3\u30de\u30f3\u30c9\u3092\u30ea\u30e2\u30fc\u30c8\u306e\u30d5\u30a1\u30a4\u30eb\u3084\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u5bfe\u3057\u3066\u3082\u884c\u3048\u308b\u3088\u3046\u306b\u3059\u308b\u3053\u3068\u3092\u76ee\u6307\u3057\u305f\u3002NFS\u306e\u3088\u3046\u306a\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u8d8a\u3057\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3092\u4e00\u3064\u4e00\u3064\u5b9a\u7fa9\u3059\u308b\u3053\u3068\u3067\u65b0\u3057\u3044\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u4f5c\u3063\u3066\u3001\u30ed\u30fc\u30ab\u30eb\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306b\u30de\u30a6\u30f3\u30c8\u3057\u3066\u4f7f\u3048\u308b\u3088\u3046\u306b\u3059\u308b\u306e\u304c\u901a\u5e38\u3060\u304c\u3001\u5b9f\u9a13\u306e\u6642\u9593\u306e\u90fd\u5408\u4e0a\u3001\u30ab\u30fc\u30cd\u30eb\u30ec\u30d9\u30eb\u3067\u306e\u5b9f\u88c5\u306f\u304b\u306a\u308a\u53b3\u3057\u3044\u3002\u305d\u3053\u3067\u3001\u6bd4\u8f03\u7684\u7740\u624b\u3057\u3084\u3059\u3044glibc\u306e\u66f8\u304d\u63db\u3048\u306b\u3088\u308b\u30e6\u30fc\u30b6\u30fc\u30ec\u30d9\u30eb\u3067\u306e\u7591\u4f3c\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u5b9f\u73fe\u3092\u8a66\u307f\u305f\u3002 \u306a\u305cglibc\u304b\u3068\u3044\u3046\u3068\u3001glibc\u306e\u6a19\u6e96\u30e9\u30a4\u30d6\u30e9\u30ealibc.so\u3084\u3001\u52d5\u7684\u30ea\u30f3\u30abld-linux.so\u3068\u3044\u3046\u306e\u306freadelf\u3084ldd\u3067\u8abf\u3079\u308b\u3068\u308f\u304b\u308b\u3088\u3046\u306b\u5927\u62b5\u306e\u30d7\u30ed\u30b0\u30e9\u30e0\u3084\u30e9\u30a4\u30d6\u30e9\u30ea\u304b\u3089\u30ea\u30f3\u30af\u3055\u308c\u3066\u4f7f\u7528\u3055\u308c\u308b\u304b\u3089\u3067\u3042\u308b\u3002\u3053\u308c\u306fC\u8a00\u8a9e\u3067\u66f8\u304b\u308c\u305f\u30d7\u30ed\u30b0\u30e9\u30e0\u306b\u9650\u3063\u305f\u8a71\u3067\u306f\u306a\u304f\u3001\u4f8b\u3048\u3070\u4eca\u56de\u30e1\u30f3\u30d0\u30fc\u304c\u4f5c\u6210\u3057\u305fRust\u3067\u66f8\u304b\u308c\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u8abf\u3079\u308b\u3068\u3001libc.so\u542b\u3081glibc\u306e\u6a19\u6e96\u30e9\u30a4\u30d6\u30e9\u30ea\u304c\u8907\u6570\u30ea\u30f3\u30af\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u304c\u308f\u304b\u308b\u3002 1 2 3 4 5 6 7 8 9 $ readelf -d librust_searchable_pke.so Dynamic section at offset 0xf8058 contains 29 entries: \u30bf\u30b0 \u30bf\u30a4\u30d7 \u540d\u524d/\u5024 0x0000000000000001 ( NEEDED ) \u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea: [ libgcc_s.so.1 ] 0x0000000000000001 ( NEEDED ) \u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea: [ libm.so.6 ] 0x0000000000000001 ( NEEDED ) \u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea: [ libc.so.6 ] 0x0000000000000001 ( NEEDED ) \u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea: [ ld-linux-x86-64.so.2 ] ~~~~~~~~~~~ \u5b9f\u969b\u306bltrace\u3092\u4f7f\u7528\u3057\u305f\u308a\u3001gdb\u3067\u30d6\u30ec\u30fc\u30af\u30dd\u30a4\u30f3\u30c8\u3092\u8cbc\u308b\u306a\u3069\u3057\u3066\u8abf\u3079\u308b\u3068\u3001\u30d5\u30a1\u30a4\u30eb\u306e\u64cd\u4f5c\u306b\u306flibc.so\u306eopen/close/read/write\u3068\u3044\u3063\u305f\u95a2\u6570\u304c\u547c\u3070\u308c\u3001\u30d2\u30fc\u30d7\u304b\u3089\u30e1\u30e2\u30ea\u306e\u5272\u308a\u5f53\u3066\u3068\u89e3\u653e\u306b\u306f\u6700\u7d42\u7684\u306bmalloc/free\u95a2\u6570\u304c\u547c\u3070\u308c\u308b\u3002\u4ed6\u306b\u3082Python,Ruby\u3068\u3044\u3063\u305f\u30a4\u30f3\u30bf\u30d7\u30ea\u30bf\u8a00\u8a9e\u3082C\u3067\u66f8\u304b\u308c\u3066\u3044\u308b\u3053\u3068\u304b\u3089\u540c\u69d8\u306blibc\u306e\u95a2\u6570\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u3002 \u3064\u307e\u308alibc\u306e\u6319\u52d5\u305d\u306e\u3082\u306e\u3092\u5909\u3048\u308c\u3070\u30d7\u30ed\u30b0\u30e9\u30e0\u306e\u6319\u52d5\u3092\u5909\u3048\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3068\u8003\u3048\u3001\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u81ea\u4f5c\u3059\u308b\u3088\u308a\u306f\u624b\u3092\u3064\u3051\u3084\u3059\u3044\u3068\u611f\u3058\u3001\u3053\u306e\u3088\u3046\u306a\u8a66\u307f\u306b\u81f3\u3063\u305f\u3002\u3057\u304b\u3057\u30a2\u30bb\u30f3\u30d6\u30ea\u3067\u66f8\u304b\u308c\u305f\u30d7\u30ed\u30b0\u30e9\u30e0\u3084Go\u306a\u3069\u72ec\u81ea\u306e\u6a19\u6e96\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u5b9f\u88c5\u3057\u3066\u3044\u308b\u8a00\u8a9e\u3067\u66f8\u304b\u308c\u305f\u30d7\u30ed\u30b0\u30e9\u30e0\u306a\u3069\u306b\u306f\u3053\u306e\u624b\u6cd5\u306f\u4f7f\u3048\u306a\u3044\u3002","title":"\u76ee\u7684"},{"location":"glibc/blog-ja/#_3","text":"glibc\u306b\u5909\u66f4\u3092\u52a0\u3048\u3066\u72ec\u81ea\u306elibc.so\u3092\u4f5c\u6210\u3057\u3066\u3082\u3001\u65e2\u5b58\u306e\u5b9f\u884c\u30d5\u30a1\u30a4\u30eb\u306e\u30ea\u30f3\u30af\u5148\u3092\u5909\u66f4\u3059\u308b\u306b\u306f\u3001\u518d\u5ea6\u30ea\u30f3\u30af\u3059\u308b\u304b\u30b7\u30b9\u30c6\u30e0\u5185\u306elibc.so\u3092\u7f6e\u304d\u63db\u3048\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002\u3057\u304b\u3057\u3001\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u304c\u5fc5\u305a\u3057\u3082\u5b58\u5728\u3059\u308b\u3068\u306f\u9650\u3089\u306a\u3044\u3057\u3001\u30b7\u30b9\u30c6\u30e0\u306b\u306f\u306a\u308b\u3079\u304f\u5909\u66f4\u3092\u52a0\u3048\u305f\u304f\u306a\u3044\u3002\u305d\u3053\u3067\u95a2\u6570\u306e\u30d5\u30c3\u30af\u3068\u3044\u3046\u624b\u6cd5\u3092\u7528\u3044\u308b\u3053\u3068\u306b\u3057\u305f\u3002\u4eca\u56de\u4f7f\u7528\u3057\u305f\u306e\u306f LD_PRELOAD \u3068\u3044\u3046\u74b0\u5883\u5909\u6570\u3067\u3001\u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u6307\u5b9a\u3059\u308b\u3068\u3001\u5b9f\u884c\u958b\u59cb\u6642\u306b\u52d5\u7684\u30ea\u30f3\u30ab\u304c\u6307\u5b9a\u3057\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u5b9f\u884c\u30d5\u30a1\u30a4\u30eb\u3067\u6307\u5b9a\u3055\u308c\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u3088\u308a\u5148\u306b\u30e1\u30e2\u30ea\u306b\u30ed\u30fc\u30c9\u3059\u308b\u3068\u3044\u3046\u3082\u306e\u3067\u3042\u308b\u3002\u547d\u4ee4\u306e\u5b9f\u884c\u6642\u306b\u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u95a2\u6570\u304c\u521d\u3081\u3066\u547c\u3070\u308c\u305f\u3068\u304d\u306b\u52d5\u7684\u30ea\u30f3\u30ab\u306b\u51e6\u7406\u304c\u79fb\u308a\u3001\u95a2\u6570\u3092\u63a2\u7d22\u3057\u3066\u30a2\u30c9\u30ec\u30b9\u3092\u89e3\u6c7a\u3059\u308b\u3068\u3044\u3046\u6d41\u308c\u304c\u3042\u308b\u304c\u3001\u305d\u306e\u6642\u306e\u95a2\u6570\u306e\u63a2\u7d22\u306e\u9806\u756a\u3092\u3053\u306eLD_PRELOAD\u306b\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u3067\u3001\u30d7\u30ed\u30b0\u30e9\u30e0\u306b\u30ea\u30f3\u30af\u3055\u308c\u3066\u3044\u308b\u30e9\u30a4\u30d6\u30e9\u30ea\u3088\u308a\u524d\u306b\u6301\u3063\u3066\u304f\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\u3064\u307e\u308aLD_PRELOAD\u306b\u672c\u6765\u547c\u3070\u308c\u308b\u306f\u305a\u306e\u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u95a2\u6570\u3092\u5b9f\u88c5\u3057\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u6307\u5b9a\u3059\u308b\u3068\u3001\u95a2\u6570\u306e\u51e6\u7406\u3092\u6a2a\u53d6\u308a\u3067\u304d\u308b\u3053\u3068\u306b\u306a\u308b(\u95a2\u6570\u3092 \u30d5\u30c3\u30af \u3059\u308b\u3068\u3044\u3046)\u3002\u5b9f\u969b\u306bLD_PRELOAD\u306f\u3053\u306e\u95a2\u6570\u306e\u30d5\u30c3\u30af\u306e\u7528\u9014\u3084\u3001\u30d7\u30ed\u30b0\u30e9\u30e0\u958b\u59cb\u6642\u3068\u7d42\u4e86\u6642\u306b\u7279\u5b9a\u306e\u51e6\u7406\u3092\u3055\u305b\u308b\u7528\u9014\u3067\u7528\u3044\u308b\u3053\u3068\u304c\u3067\u304d\u308b\u3002\u672c\u5b9f\u88c5\u3067\u306f\u3053\u306e\u624b\u6cd5\u3092\u7528\u3044\u3066\u65e2\u5b58\u306e\u30b3\u30de\u30f3\u30c9\u3092\u66f8\u304d\u63db\u3048\u305a\u306blibc.so\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u6271\u3046\u95a2\u6570\u306e\u6319\u52d5\u3092\u5909\u66f4\u3057\u305f\u3002 \u305f\u3060\u3057libc.so\u5185\u306e\u95a2\u6570\u3092\u65b0\u305f\u306b\u5b9a\u7fa9\u3057\u3066\u4f5c\u6210\u3057\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u3092preload\u3059\u308b\u3060\u3051\u3067\u306f\u3001\u305d\u306e\u95a2\u6570\u3092\u547c\u3073\u51fa\u3059libc.so\u5185\u306e\u95a2\u6570\u3092\u30d5\u30c3\u30af\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u306a\u3044\u3002\u4f8b\u3048\u3070\u3001write\u95a2\u6570\u3092\u5b9a\u7fa9\u3057\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u3092preload\u3057\u3066\u3082\u3001libc.so\u306efwrite\u95a2\u6570\u304c\u5b9f\u969b\u306b\u547c\u3073\u51fa\u3059\u306e\u306f\u81ea\u8eab\u306ewrite\u95a2\u6570\u3067\u3042\u3063\u3066\u30d5\u30c3\u30af\u3057\u305fwrite\u95a2\u6570\u3067\u306f\u306a\u3044\u3002\u3053\u308c\u306f\u540c\u3058\u30e9\u30a4\u30d6\u30e9\u30ea\u306b\u3042\u308b\u95a2\u6570\u306e\u30a2\u30c9\u30ec\u30b9\u306f\u76f8\u5bfe\u7684\u306a\u3082\u306e\u306a\u306e\u3067\u3001\u308f\u3056\u308f\u3056\u52d5\u7684\u30ea\u30f3\u30ab\u3092\u547c\u3076\u3053\u3068\u306f\u306a\u3044\u304b\u3089\u3067\u3042\u308b\u3002\u305f\u3060\u30d5\u30a1\u30a4\u30eb\u3092\u30aa\u30fc\u30d7\u30f3\u3059\u308b\u51e6\u7406\u3092\u30d5\u30c3\u30af\u3059\u308b\u305f\u3081\u306b\u3001creat\u3084fopen\u3068\u3044\u3063\u305f\u3059\u3079\u3066\u306e\u95a2\u6570\u306e\u51e6\u7406\u3092\u4e00\u3064\u4e00\u3064\u5b9a\u7fa9\u3059\u308b\u306e\u306f\u52b4\u529b\u3092\u8981\u3059\u308b\u3046\u3048\u898b\u9003\u3059\u53ef\u80fd\u6027\u3082\u3042\u308b\u3002\u305d\u3053\u3067\u4eca\u56de\u3068\u3063\u305f\u65b9\u91dd\u306fglibc\u5168\u4f53\u306e\u30bd\u30fc\u30b9\u3092\u6301\u3061\u51fa\u3057\u3066\u3001\u30d5\u30c3\u30af\u3057\u305f\u3044\u95a2\u6570\u304c\u6700\u7d42\u7684\u306b\u884c\u304d\u7740\u304f\u95a2\u6570(\u4f8b\u3048\u3070fopen\u306b\u5bfe\u3057\u3066open)\u306e\u307f\u3092\u5909\u66f4\u3057\u3066preload\u3059\u308b\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u4f5c\u6210\u3059\u308b\u3068\u3044\u3046\u3082\u306e\u3067\u3001\u304b\u306a\u308a\u7121\u99c4\u304c\u3042\u308b\u304clibc.so\u306e\u95a2\u6570\u306f\u3059\u3079\u3066\u63c3\u3046\u306e\u3067\u30d5\u30c3\u30af\u3092\u3057\u305d\u3053\u306a\u3046\u5fc3\u914d\u306f\u306a\u304f\u306a\u308b\u3002","title":"\u6319\u52d5\u306e\u5909\u66f4\u65b9\u6cd5\u306b\u3064\u3044\u3066"},{"location":"glibc/blog-ja/#_4","text":"\u57fa\u672c\u7684\u306b\u306f\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u3092\u6271\u3046\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3092\u547c\u3073\u51fa\u3059\u95a2\u6570(\u6b63\u5f0f\u3067\u306f\u306a\u3044\u304c\u3053\u3053\u3067\u306f\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u95a2\u6570\u3068\u3044\u3046\u3002\u5b9f\u969b\u306b\u30bd\u30fc\u30b9\u5185\u3067\u306f\u3053\u308c\u3089\u306e\u95a2\u6570\u306f\u30de\u30af\u30ed\u3092\u7528\u3044\u3066\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3092\u547c\u3073\u51fa\u3059)\u3092\u66f8\u304d\u63db\u3048\u308c\u3070\u3044\u3044\u3053\u3068\u306b\u306a\u308b\u3002Linux\u3067\u306f\u3053\u308c\u3089\u306e\u95a2\u6570\u306fglibc\u30bd\u30fc\u30b9\u30b3\u30fc\u30c9\u5185\u306e sysdeps/unix/sysv/linux/ \u4ee5\u4e0b\u306b\u307e\u3068\u307e\u3063\u3066\u3044\u308b\u3002 \u5b9f\u969b\u306b\u3069\u306e\u95a2\u6570\u3092\u30d5\u30c3\u30af\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u304b\u306f\u3001\u7c21\u5358\u306a\u30b3\u30de\u30f3\u30c9\u3092ltrace\u3084strace\u3067\u30c8\u30ec\u30fc\u30b9\u3057\u306a\u304c\u3089\u5224\u5b9a\u3059\u308b\u3002\u4f8b\u3048\u3070\u4ee5\u4e0b\u306f\u4e00\u3064\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u5bfe\u3059\u308bcat\u3092ltrace\u3057\u305f\u7d50\u679c\u3067\u3042\u308b\u3002 1 2 3 4 5 6 7 8 9 10 11 12 $ ltrace cat file ################ \u5fc5\u8981\u306a\u90e8\u5206\u306e\u307f\u629c\u7c8b open ( \"file\" , 00 , 037777400000 ) = open ( \"file\" , O_RDONLY ) = 3 fstat ( 3 , 0x7ffd1d8874b0 ) = 0 posix_fadvise ( 3 , 0 , 0 , 2 ) = 0 aligned_alloc ( 4096 , 0x20000, 0 , 0x7f44742fe47a ) = 0x7f4474462000 read ( 3 , \"this is a source file\" , 131072 ) = 21 write ( 1 , \"this is a source file\" , 21this is a source file ) = 21 read ( 3 , \"\" , 131072 ) = 0 free ( 0x7f4474462000 ) = <void> close ( 3 ) = 0 ################ \u307e\u305afile\u3092read only\u3067open\u3057\u3001\u8fd4\u3063\u3066\u6765\u305f\u30d5\u30a1\u30a4\u30eb\u8b58\u5225\u5b50\u306b\u5bfe\u3057\u3066\u3001fstat,read\u3092\u5b9f\u884c\u3057\u3066\u3001\u6700\u5f8c\u306bclose\u3059\u308b\u3002\u3053\u306e\u5834\u5408\u3001\u30ea\u30e2\u30fc\u30c8\u306e\u30d5\u30a1\u30a4\u30eb\u3092read\u6a29\u9650\u3067open\u3059\u308b\u969b\u306f\u30d5\u30a1\u30a4\u30eb\u306e\u5185\u5bb9\u3092Drive\u306eAPI\u3092\u5229\u7528\u3057\u3066\u30ea\u30e2\u30fc\u30c8\u304b\u3089\u53d6\u5f97\u3057\u3066\u30ed\u30fc\u30ab\u30eb\u306e\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306b\u79fb\u3057\u305d\u306e\u30d5\u30a1\u30a4\u30eb\u8b58\u5225\u5b50\u3092\u8fd4\u305b\u3070\u826f\u3044\u3002\u305d\u306e\u5f8c\u306eread\u306f\u3053\u306e\u30ed\u30fc\u30ab\u30eb\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u5bfe\u3057\u3066\u884c\u3046\u306e\u3067\u3001\u30d5\u30c3\u30af\u306e\u5fc5\u8981\u306f\u306a\u3044\u3002 \u4ed6\u306e\u4f8b\u3068\u3057\u3066\u3001cp\u306eltrace\u306e\u7d50\u679c\u3092\u793a\u3059\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 $ ltrace cp file dup #################### \u5fc5\u8981\u306a\u90e8\u5206\u306e\u307f\u629c\u7c8b open ( \"dup\" , O_RDONLY | O_PATH | O_DIRECTORY, 027516111125 ) = -1 __errno_location () = 0x7f8fb847f698 fstatat ( AT_FDCWD, \"file\" , 0x7fffbd387960 ) = 0 open ( \"file\" , 00 , 00 ) = 3 fstat ( 3 , 0x7fffbd387b10 ) = 0 openat ( AT_FDCWD, \"dup\" , O_WRONLY | O_CREAT | O_EXCL, 0644 ) = 4 __errno_location () = 0x7f8fb847f698 ioctl ( 4 , 1074041865 , 0x3 ) = -1 fstat ( 4 , 0x7fffbd387a80 ) = 0 posix_fadvise ( 3 , 0 , 0 , 2 ) = 0 copy_file_range ( 3 , 0 , 4 , 0 ) = 21 copy_file_range ( 3 , 0 , 4 , 0 ) = 0 close ( 4 ) = 0 close ( 3 ) = 0 #################### \u307e\u305a\u30b3\u30d4\u30fc\u5148\u306e\u30d1\u30b9\u304c\u30d5\u30a1\u30a4\u30eb\u304b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304b\u5b58\u5728\u3059\u308b\u304b\u3069\u3046\u304b\u3092open\u3067\u5224\u5b9a\u3057\u3001\u30d5\u30a1\u30a4\u30eb\u3067\u3042\u308b\u5834\u5408\u306fwrite\u6a29\u9650\u3067\u305d\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u958b\u304f\u3002\u305d\u306e\u5f8c\u5185\u5bb9\u3092\u30b3\u30d4\u30fc\u3057\u3066close\u3059\u308b\u3002\u3053\u306e\u5834\u5408\u3001write\u6a29\u9650\u3067\u30c9\u30e9\u30a4\u30d6\u4e0a\u306e\u30d1\u30b9\u3092\u6307\u5b9a\u3057\u3066open\u3057\u305f\u5834\u5408\u3001\u30d5\u30a1\u30a4\u30eb\u304c\u30c9\u30e9\u30a4\u30d6\u4e0a\u306b\u306a\u3051\u308c\u3070\u4f5c\u6210\u3057\u3001\u30ed\u30fc\u30ab\u30eb\u306e\u30d5\u30a1\u30a4\u30eb\u3068\u3057\u3066\u958b\u304f\u3002\u66f4\u306b\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u3092close\u3059\u308b\u3068\u304d\u306f\u3001\u5909\u66f4\u3092\u30c9\u30e9\u30a4\u30d6\u306b\u4fdd\u5b58\u3059\u308b\u3088\u3046\u306b\u5909\u66f4\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002 \u4eca\u56deSommelier Drive\u304b\u3089\u63d0\u4f9b\u3055\u308c\u308bAPI\u306f\u4ee5\u4e0b\u3067\u3042\u308b\u3002 addFile \u30d1\u30b9\u540d\u3092\u6307\u5b9a\u3057\u3066\u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\u3059\u308b addDirectory \u30d1\u30b9\u540d\u3092\u6307\u5b9a\u3057\u3066\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3059\u308b getChildrenPathes \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u5b9a\u3057\u3066\u3001\u30a8\u30f3\u30c8\u30ea\u4e00\u89a7\u3092\u53d6\u5f97\u3059\u308b isExistFilepath \u30d1\u30b9\u306e\u6709\u7121\u3092\u53d6\u5f97\u3059\u308b modifyFile \u30d5\u30a1\u30a4\u30eb\u306e\u5185\u5bb9\u3092\u5909\u66f4\u3059\u308b openFilepath \u30d1\u30b9\u3092\u958b\u304d\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u3084\u30d5\u30a1\u30a4\u30eb\u306e\u5185\u5bb9\u3092\u53d6\u5f97\u3059\u308b\u3002 searchDescendantPathes \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u6307\u5b9a\u3057\u3066\u5b50\u5b6b\u306e\u4e00\u89a7\u3092\u53d6\u5f97\u3059\u308b \u3053\u308c\u3089\u306eAPI\u3092\u7528\u3044\u3066\u5b9f\u88c5\u3067\u304d\u308b\u7bc4\u56f2\u3067\u3001glibc\u306e\u95a2\u6570\u3092\u30d5\u30c3\u30af\u3059\u308b\u3002\u305f\u3060\u3057\u3053\u308c\u3089\u306eAPI\u306f\u73fe\u6bb5\u968e\u3067\u306f\u304b\u306a\u308a\u6642\u9593\u304c\u304b\u304b\u308b\u306e\u3067\u3001\u547c\u3073\u51fa\u3057\u3092\u6975\u529b\u6e1b\u3089\u3059\u5b9f\u88c5\u306b\u3059\u308b\u5fc5\u8981\u304c\u3042\u3063\u305f\u3002 \u4ee5\u4e0b\u306b\u5909\u66f4\u3092\u52a0\u3048\u305f sysdeps/unix/sysv/linux/ \u306e\u95a2\u6570\u3092\u793a\u3059\u3002","title":"\u5177\u4f53\u7684\u306a\u8a2d\u8a08\u306e\u65b9\u91dd"},{"location":"glibc/blog-ja/#openopenat","text":"\u30d5\u30c3\u30af\u306e\u5927\u90e8\u5206\u3092\u69cb\u6210\u3059\u308b\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u95a2\u6570\u3002\u4e0a\u306b\u8ff0\u3079\u305f\u3068\u304a\u308a\u3001\u5f15\u6570\u3067\u3042\u308b\u30d5\u30a1\u30a4\u30eb\u306e\u30d1\u30b9\u3068\u30d5\u30e9\u30b0\u3092\u5224\u5b9a\u3057\u3066\u3001\u30d1\u30b9\u540d\u304c\u30c9\u30e9\u30a4\u30d6\u306e\u3082\u306e\u3067\u3042\u3063\u305f\u5834\u5408\u306f\u3001\u30d5\u30e9\u30b0\u306e\u7d44\u307f\u5408\u308f\u305b\u306b\u5fdc\u3058\u3066\u30c9\u30e9\u30a4\u30d6\u4e0a\u306e\u30d1\u30b9\u306b\u5bfe\u3057\u3066\u7279\u5b9a\u306e\u51e6\u7406\u3092\u884c\u3046\u3088\u3046\u306b\u8a2d\u8a08\u3057\u305f\u3002\u307e\u305fopenat\u306f\u7b2c\u4e00\u5f15\u6570\u306b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u8b58\u5225\u5b50\u3092\u6307\u5b9a\u3059\u308b\u304c\u3001\u3053\u308c\u304c\u30c9\u30e9\u30a4\u30d6\u4e0a\u306e\u3082\u306e\u3067\u3042\u308b\u5834\u5408\u3082\u3001\u7279\u5225\u306a\u51e6\u7406\u304c\u5fc5\u8981\u306b\u306a\u308b\u3002\u4eca\u56defopen\u3084creat\u306a\u3069\u3067\u4f7f\u7528\u3055\u308c\u308bO_RDONLY,\u3000O_WRONLY,\u3000O_RDWR, O_CREAT, O_EXCL, O_TRUNC, O_APPEND, O_DIRECTORY\u306e8\u3064\u306e\u30d5\u30e9\u30b0\u306b\u5bfe\u5fdc\u3057\u305f\u3002","title":"open/openat"},{"location":"glibc/blog-ja/#closefsync","text":"O_WRONLY\u304bO_RDWR\u3092\u6307\u5b9a\u3057\u3066open\u3057\u305f\u30c9\u30e9\u30a4\u30d6\u4e0a\u306e\u30d5\u30a1\u30a4\u30eb\u306f\u3053\u308c\u3089\u306e\u95a2\u6570\u304c\u547c\u3070\u308c\u308b\u969b\u306b\u30ed\u30fc\u30ab\u30eb\u3067\u7de8\u96c6\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u306e\u5185\u5bb9\u3092\u30c9\u30e9\u30a4\u30d6\u306b\u4fdd\u5b58\u3059\u308b\u5fc5\u8981\u304c\u3042\u308b\u3002 fsync\u306f\u30d5\u30a1\u30a4\u30eb\u306e\u5909\u66f4\u3092\u30c7\u30a3\u30b9\u30af\u306b\u53cd\u6620\u3059\u308b\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u95a2\u6570\u3067\u3042\u308b\u3002close\u95a2\u6570\u306b\u52a0\u3048\u3066\u3053\u306e\u95a2\u6570\u3092\u5909\u66f4\u3057\u305f\u306e\u306f\u3001nano\u30b3\u30de\u30f3\u30c9\u3067\u30ea\u30e2\u30fc\u30c8\u306e\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u7de8\u96c6\u3067\u304d\u308b\u3088\u3046\u306b\u3059\u308b\u305f\u3081\u3067\u3042\u308b\u3002\u3053\u306e\u30b3\u30de\u30f3\u30c9\u306e\u6319\u52d5\u3092ltrace\u3067\u8abf\u3079\u305f\u3068\u3053\u308d\u3001Ctrl-S\u304c\u62bc\u3055\u308c\u308b\u305f\u3073\u306bfsync\u95a2\u6570\u3092\u547c\u3073\u51fa\u3059\u304c\u3001\u7d42\u4e86\u6642\u306bclose\u95a2\u6570\u3092\u547c\u3073\u51fa\u3055\u306a\u304b\u3063\u305f\u3002\u305d\u306e\u305f\u3081\u3001\u30c9\u30e9\u30a4\u30d6\u4e0a\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u5bfe\u3057\u3066fsync\u304c\u547c\u3070\u308c\u308b\u305f\u3073\u306b\u5909\u66f4\u3092\u53cd\u6620\u3059\u308b\u51e6\u7406\u304c\u5fc5\u8981\u306b\u306a\u3063\u305f\u3002","title":"close/fsync"},{"location":"glibc/blog-ja/#fstatat","text":"\u30d5\u30a1\u30a4\u30eb\u3084\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\u95a2\u6570\u3067\u3001\u672c\u74b0\u5883\u306e\u5b9f\u88c5\u3067\u306f\u5185\u90e8\u3067newfstatat\u3068\u3044\u3046\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3092\u547c\u3073\u51fa\u3059\u3002stat/fstat/lstat/statx\u3068\u3044\u3063\u305f\u95a2\u6570\u3082\u3001\u30d5\u30e9\u30b0\u3092\u6307\u5b9a\u3057\u3066\u3053\u306e\u95a2\u6570\u3092\u547c\u3073\u51fa\u3059\u306e\u3067\u3001\u5909\u66f4\u306f\u3053\u306e\u95a2\u6570\u306e\u307f\u3067\u3088\u3044(\u305f\u3060\u3057\u3001\u74b0\u5883\u306b\u3088\u3063\u3066\u306f\u3053\u308c\u3089\u306e\u95a2\u6570\u306f\u540c\u540d\u306e\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3092\u547c\u3073\u51fa\u3059\u306e\u3067\u3042\u304f\u307e\u3067\u672c\u74b0\u5883\u306e\u307f\u3067\u306e\u5b9f\u88c5\u3067\u3042\u308b)\u3002\u73fe\u30c9\u30e9\u30a4\u30d6\u306e\u5b9f\u88c5\u3067\u306f\u30d5\u30a1\u30a4\u30eb\u304c\u4fdd\u6301\u3059\u308b\u60c5\u5831\u306e\u7a2e\u985e\u306f\u3055\u307b\u3069\u591a\u304f\u306a\u3044\u306e\u3067\u3001\u30d1\u30fc\u30df\u30c3\u30b7\u30e7\u30f3\u3068\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u306e\u307f\u53d6\u5f97\u3057\u3001\u4ed6\u306e\u60c5\u5831\u306f0\u3067\u57cb\u3081\u308b\u8a2d\u8a08\u306b\u3057\u305f\u3002","title":"fstatat"},{"location":"glibc/blog-ja/#opendirfdopendirreaddirclosedir","text":"\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30a8\u30f3\u30c8\u30ea\u4e00\u89a7\u3092\u8fd4\u3059\u4e00\u9023\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u95a2\u6570\u3067\u3042\u308a\u3001ls, find\u3068\u3044\u3063\u305f\u30b3\u30de\u30f3\u30c9\u3084\u30b7\u30a7\u30eb\u306e\u30d1\u30b9\u540d\u88dc\u5b8c\u6a5f\u80fd\u306a\u3069\u3067\u7528\u3044\u3089\u308c\u3066\u3044\u308b\u3002\u305d\u308c\u305e\u308copen/getdent/close\u3068\u3044\u3063\u305f\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u95a2\u6570\u3092\u547c\u3073\u51fa\u3059\u304c\u3001\u30a8\u30f3\u30c8\u30ea\u4e00\u89a7\u3092\u53d6\u5f97\u3059\u308b\u305f\u3081\u306b\u3053\u308c\u3089\u304c\u76f4\u63a5\u547c\u3070\u308c\u308b\u3053\u3068\u306f\u3081\u3063\u305f\u306b\u306a\u3044\u306e\u3067\u3001\u4e0a\u8a18\u306e\u95a2\u6570\u306e\u307f\u3092\u5909\u66f4\u3057\u305f\u3002","title":"opendir/fdopendir/readdir/closedir"},{"location":"glibc/blog-ja/#mkdir","text":"\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3059\u308b\u95a2\u6570\u3067\u3001\u30ea\u30e2\u30fc\u30c8\u306e\u30d1\u30b9\u304c\u6307\u5b9a\u3055\u308c\u305f\u3068\u304d\u306b\u5bfe\u5fdc\u3059\u308bAPI\u3092\u547c\u3073\u51fa\u3059\u3088\u3046\u306b\u5909\u66f4\u3059\u308c\u3070\u826f\u3044\u3002\u3057\u304b\u3057C\u306e\u30d5\u30a1\u30a4\u30eb\u304c\u898b\u5f53\u305f\u3089\u305a\u3001\u30d3\u30eb\u30c9\u3092\u305f\u3069\u3063\u305f\u3068\u3053\u308d\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u30a2\u30bb\u30f3\u30d6\u30ea\u3092\u751f\u6210\u3057\u30b3\u30f3\u30d1\u30a4\u30eb\u3057\u3066\u3044\u308b\u3088\u3046\u3060\u3063\u305f\u3002\u4e00\u90e8\u306e\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u95a2\u6570\u306f\u540c\u69d8\u306e\u65b9\u6cd5\u3067\u30b3\u30f3\u30d1\u30a4\u30eb\u3055\u308c\u3066\u3044\u308b\u3088\u3046\u3060\u3063\u305f\u304c\u3001\u305d\u308c\u3089\u306e\u95a2\u6570\u3092\u6307\u5b9a\u3059\u308b\u90e8\u5206\u304c\u898b\u5f53\u305f\u3089\u306a\u304b\u3063\u305f\u306e\u3067\u3001C\u8a00\u8a9e\u3067\u8a18\u8ff0\u3057\u3066\u5f37\u5f15\u3067\u3042\u308b\u304c\u3082\u3068\u306e\u30b7\u30f3\u30dc\u30eb\u3092\u4e0a\u66f8\u304d\u3059\u308b\u3053\u3068\u3067\u5bfe\u5fdc\u3057\u305f\u3002","title":"mkdir"},{"location":"glibc/blog-ja/#init_drivefini_drive","text":"\u30c9\u30e9\u30a4\u30d6\u63a5\u7d9a\u306b\u5fc5\u8981\u306a\u30b5\u30fc\u30d0\u3068\u30e6\u30fc\u30b6\u306e\u60c5\u5831\u3092\u74b0\u5883\u5909\u6570\u304b\u3089\u53d6\u5f97\u3059\u308b\u672c\u5b9f\u88c5\u72ec\u81ea\u306e\u95a2\u6570\u3067\u3042\u308b\u3002\u305d\u308c\u305e\u308c\u4ee5\u4e0b\u306e\u3088\u3046\u306b __attribute__((constructor)) \u3068 __attribute__((destructor)) \u3067\u5ba3\u8a00\u3057\u3066\u3044\u308b\u3002 1 2 static void __attribute__ (( constructor )) init_drive ( void ); static void __attribute__ (( destructor )) fini_drive ( void ); \u3053\u306e\u5c5e\u6027\u3092\u6307\u5b9a\u3057\u3066\u5ba3\u8a00\u3057\u305f\u95a2\u6570\u306f\u3001\u30e9\u30a4\u30d6\u30e9\u30ea\u304c\u30e1\u30e2\u30ea\u306b\u30ed\u30fc\u30c9\u3055\u308c\u308b\u969b\u3068\u30d7\u30ed\u30b0\u30e9\u30e0\u304c\u7d42\u4e86\u3059\u308b\u969b\u306b\u305d\u308c\u305e\u308c\u81ea\u52d5\u7684\u306b\u547c\u3073\u51fa\u3055\u308c\u308b\u3002Sommelier Drive \u306eAPI\u3092\u547c\u3073\u51fa\u3059\u305f\u3073\u306b\u74b0\u5883\u5909\u6570\u304b\u3089\u60c5\u5831\u3092\u53d6\u5f97\u3057\u3066\u691c\u8a3c\u3059\u308b\u306e\u306f\u5197\u9577\u306b\u306a\u308b\u306e\u3067\u3001\u30ed\u30fc\u30c9\u6642\u306e\u307f\u8aad\u307f\u8fbc\u3093\u3067\u30e9\u30a4\u30d6\u30e9\u30ea\u306e\u30c7\u30fc\u30bf\u3092\u4fdd\u6301\u3059\u308b\u9818\u57df\u306b\u4fdd\u5b58\u3059\u308b\u3053\u3068\u306b\u3057\u305f\u3002\u307e\u305f init_drive \u95a2\u6570\u5185\u3067API\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3092 dlopen \u3067\u30ed\u30fc\u30c9\u3059\u308b\u3002\u901a\u5e38\u306f\u5916\u90e8\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3068\u306e\u30ea\u30f3\u30af\u306f\u3001\u30e9\u30a4\u30d6\u30e9\u30ea\u751f\u6210\u6642\u306b\u884c\u3046\u3082\u306e\u3060\u304c\u3001glibc\u306f\u30d3\u30eb\u30c9\u306b\u72ec\u81ea\u5b9f\u88c5\u4ee5\u5916\u306e\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u5fc5\u8981\u3068\u3057\u306a\u3044\u8a2d\u8a08\u3068\u306a\u3063\u3066\u3044\u3066Rust\u3067\u4f5c\u6210\u3057\u305f\u30e9\u30a4\u30d6\u30e9\u30ea\u3068\u30ea\u30f3\u30af\u3059\u308b\u3053\u3068\u304c\u3067\u304d\u306a\u304b\u3063\u305f\u305f\u3081\u3001\u4ee3\u66ff\u7b56\u3068\u3057\u3066\u5b9f\u884c\u6642\u306b\u52d5\u7684\u306b\u30ea\u30f3\u30af\u3059\u308b\u624b\u6cd5\u3092\u3068\u3063\u305f\u3002","title":"init_drive/fini_drive"},{"location":"glibc/blog-ja/#_5","text":"\u6df1\u523b\u306a\u554f\u984c\u3060\u304cmake\u306b\u3088\u308b\u30d3\u30eb\u30c9\u304c\u5931\u6557\u3059\u308b\u3002\u672c\u6765\u306e\u30d3\u30eb\u30c9\u306f\u5358\u7d14\u306b\u30d3\u30eb\u30c9\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u79fb\u52d5\u3057\u3066 <source path>/configure \u3068 make \u3067\u6e08\u3080\u306e\u306f\u305a\u3060\u304c\u3001\u5b9f\u88c5\u306b\u5909\u66f4\u3092\u52a0\u3048\u305f\u305f\u3081\u306b\u3053\u306e\u30d3\u30eb\u30c9\u65b9\u6cd5\u3067\u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30a8\u30e9\u30fc\u306b\u3088\u308a\u6b62\u307e\u3063\u3066\u3057\u307e\u3046\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 for symbol in __GI___pthread_disable_asynccancel __GI___pthread_enable_asynccancel __pthread_disable_asynccancel __pthread_enable_asynccancel calloc free malloc realloc __stack_chk_fail __stack_chk_fail_local; do \\ echo \".globl $symbol\"; \\ echo \"$symbol:\"; \\ done | gcc -o /home/sitianos/Project/Drive/build/elf/librtld.mapT.o -g -Werror=undef -Wa,--noexecstack -c -x assembler - gcc -nostdlib -nostartfiles -r -o /home/sitianos/Project/Drive/build/elf/librtld.map.o /home/sitianos/Project/Drive/build/elf/librtld.mapT.o '-Wl,-(' /home/sitianos/Project/Drive/build/elf/dl-allobjs.os /home/sitianos/Project/Drive/build/libc_pic.a -lgcc '-Wl,-)' -Wl,-Map,/home/sitianos/Project/Drive/build/elf/librtld.mapT /usr/bin/ld: /home/sitianos/Project/Drive/build/libc_pic.a(getcwd.os): in function `__GI___getcwd': /home/sitianos/Project/Drive/glibc-drive/io/../sysdeps/unix/sysv/linux/getcwd.c:49: multiple definition of `__getcwd'; /home/sitianos/Project/Drive/build/elf/dl-allobjs.os:/home/sitianos/Project/Drive/glibc-drive/elf/../sysdeps/unix/sysv/linux/getcwd.c:49: first defined here /usr/bin/ld: /home/sitianos/Project/Drive/build/libc_pic.a(dl-error.os): in function `__GI__dl_signal_exception': /home/sitianos/Project/Drive/glibc-drive/elf/dl-error-skeleton.c:91: multiple definition of `_dl_signal_exception'; /home/sitianos/Project/Drive/build/elf/dl-allobjs.os:/home/sitianos/Project/Drive/glibc-drive/elf/dl-error-skeleton.c:91: first defined here /usr/bin/ld: /home/sitianos/Project/Drive/build/libc_pic.a(dl-error.os): in function `__GI__dl_signal_error': /home/sitianos/Project/Drive/glibc-drive/elf/dl-error-skeleton.c:109: multiple definition of `_dl_signal_error'; /home/sitianos/Project/Drive/build/elf/dl-allobjs.os:/home/sitianos/Project/Drive/glibc-drive/elf/dl-error-skeleton.c:109: first defined here /usr/bin/ld: /home/sitianos/Project/Drive/build/libc_pic.a(dl-error.os): in function `__GI__dl_catch_exception': /home/sitianos/Project/Drive/glibc-drive/elf/dl-error-skeleton.c:175: multiple definition of `_dl_catch_exception'; /home/sitianos/Project/Drive/build/elf/dl-allobjs.os:/home/sitianos/Project/Drive/glibc-drive/elf/dl-error-skeleton.c:175: first defined here /usr/bin/ld: /home/sitianos/Project/Drive/build/libc_pic.a(dl-error.os): in function `__GI__dl_catch_error': /home/sitianos/Project/Drive/glibc-drive/elf/dl-error-skeleton.c:225: multiple definition of `_dl_catch_error'; /home/sitianos/Project/Drive/build/elf/dl-allobjs.os:/home/sitianos/Project/Drive/glibc-drive/elf/dl-error-skeleton.c:225: first defined here collect2: error: ld returned 1 exit status \u8868\u793a\u306b\u3042\u308b\u3088\u3046\u306b\u95a2\u6570\u306e\u591a\u91cd\u5b9a\u7fa9\u306b\u3088\u308b\u30a8\u30e9\u30fc\u3067\u3042\u308b\u304c\u3001\u6307\u6458\u3055\u308c\u3066\u3044\u308b\u95a2\u6570\u306f\u5b9f\u88c5\u3092\u5909\u66f4\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u5185\u3067\u306f\u7528\u3044\u3066\u306a\u3044\u3002\u5b9f\u969b\u306b libc_pic.a \u3068 dl-allobjs.os \u5185\u306e\u30b7\u30f3\u30dc\u30eb\u3092\u78ba\u8a8d\u3057\u305f\u3068\u3053\u308d\u78ba\u304b\u306b\u540c\u3058\u95a2\u6570\u304c\u5b9a\u7fa9\u3055\u308c\u3066\u3044\u305f\u304c\u3001\u30d5\u30a1\u30a4\u30eb\u306b\u5909\u66f4\u3092\u52a0\u3048\u308b\u3053\u3068\u3067\u305d\u306e\u3088\u3046\u306a\u72b6\u6cc1\u306b\u306a\u308b\u7406\u7531\u304c\u308f\u304b\u3089\u306a\u304b\u3063\u305f\u3002 dlopen \u3092\u4f7f\u7528\u3057\u305f\u3053\u3068\u304c\u539f\u56e0\u3068\u8003\u3048\u3066\u3053\u306e\u8a18\u8ff0\u3092\u6d88\u3057\u305f\u308a\u3001\u540c\u3058\u5b9a\u7fa9\u3092\u6307\u3057\u3066\u306e\u30a8\u30e9\u30fc\u3067\u3042\u308b\u3053\u3068\u304b\u3089 -fcommon \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u52a0\u3048\u305f\u308a\u306a\u3069\u8a66\u307f\u305f\u304c\u89e3\u6d88\u3057\u306a\u304b\u3063\u305f\u3002\u4e0a\u8a18\u306e\u30ec\u30b7\u30d4\u306f\u52d5\u7684\u30ea\u30f3\u30abld-linux.so\u3092\u4f5c\u6210\u3059\u308b\u4e00\u74b0\u306e\u3082\u306e\u3067\u3042\u308b\u304c\u3001\u76ee\u7684\u306elibc.so\u3092\u4f5c\u6210\u3059\u308b\u306b\u306fld-linux.so\u3078\u306e\u30ea\u30f3\u30af\u304c\u5fc5\u8981\u3067\u3042\u308b\u305f\u3081\u3001\u3053\u308c\u4ee5\u964d\u30d3\u30eb\u30c9\u306f\u9032\u307e\u306a\u3044\u3002ld-linux.so\u3092\u4f5c\u6210\u3059\u308b\u4e00\u9023\u306e\u30d3\u30eb\u30c9\u95a2\u9023\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u3093\u3067\u307f\u305f\u3082\u306e\u306e\u539f\u56e0\u306e\u7279\u5b9a\u306b\u306f\u81f3\u3089\u306a\u304b\u3063\u305f\u3002\u73fe\u6bb5\u968e\u3067\u306f\u304b\u306a\u308a\u5f37\u5f15\u3067\u3042\u308b\u3082\u306e\u306e\u4ee5\u4e0b\u306e\u65b9\u6cd5\u3067\u30d3\u30eb\u30c9\u3067\u304d\u308b\u3002 sysdeps/unix/sysv/linux/drive-common.h \u306e DRIVE_EXT \u30de\u30af\u30ed\u30920\u306b\u30bb\u30c3\u30c8\u3057\u3066\u3001 configure \u3068 make \u3067\u30d3\u30eb\u30c9\u3059\u308b\u3002 sysdeps/unix/sysv/linux/drive-common.h \u306e DRIVE_EXT \u30de\u30af\u30ed\u30921\u306b\u30bb\u30c3\u30c8\u3057\u3066\u3001 make -k \u3092\u5b9f\u884c\u3059\u308b\u3002 1\u306b\u3088\u308a\u5909\u66f4\u3092\u542b\u3081\u306a\u3044\u901a\u5e38\u901a\u308a\u306e\u30d3\u30eb\u30c9\u3092\u5b9f\u884c\u3057\u3066libc.so\u306b\u5fc5\u8981\u306a\u30d5\u30a1\u30a4\u30eb\u304c\u751f\u6210\u3059\u308b\u30022\u3067\u306fld.so\u4f5c\u6210\u4e0a\u306e\u30a8\u30e9\u30fc\u3092\u7121\u8996\u3057\u3066\u3001\u5909\u66f4\u3092\u52a0\u3048\u305f\u95a2\u6570\u3092\u542b\u3081\u305flibc.so\u3092\u4f5c\u6210\u3059\u308b\u3002\u4f9d\u5b58\u4e0a\u3067\u5fc5\u8981\u306a\u30d5\u30a1\u30a4\u30eb\u306f1\u3067\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u306e\u3067\u3001ld.so\u306e\u4f5c\u6210\u3067\u30a8\u30e9\u30fc\u306f\u51fa\u529b\u3055\u308c\u308b\u3082\u306e\u306e\u3001\u76ee\u7684\u306elibc.so\u306f\u751f\u6210\u3055\u308c\u308b\u3002 \u3053\u306e\u3088\u3046\u306b\u5f37\u5f15\u306a\u30d3\u30eb\u30c9\u65b9\u6cd5\u306a\u306e\u3067\u3001\u30d3\u30eb\u30c9\u5f8c\u306e\u30d0\u30a4\u30ca\u30ea\u3068\u3057\u3066Debian\u30d1\u30c3\u30b1\u30fc\u30b8\u3092\u4f5c\u6210\u3057\u305f\u3002 2\u3064\u76ee\u306e\u554f\u984c\u3068\u3057\u3066\u3001libc.so\u3092LD_PRELOAD\u306b\u6307\u5b9a\u3057\u3066\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3057\u305f\u969b\u306b\u3001Segmentation Fault\u3067\u843d\u3061\u3066\u3057\u307e\u3046\u3068\u3044\u3046\u3082\u306e\u304c\u3042\u3063\u305f\u3002gdb\u3067\u8abf\u3079\u305f\u3068\u3053\u308d\u3001\u5171\u6709\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u30ed\u30fc\u30c9\u3059\u308b\u969b\u306b\u30a2\u30af\u30bb\u30b9\u9055\u53cd\u304c\u751f\u3058\u3066\u3044\u305f\u3002\u540c\u69d8\u306e\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u305f\u4f8b\u3092\u63a2\u3057\u305f\u3068\u3053\u308d\u3001 CTF\u306e\u8a18\u4e8b \u304c\u898b\u3064\u304b\u308a\u3001\u3053\u308c\u306b\u3088\u308b\u3068libc.so\u306fld-linux.so\u306e\u69cb\u9020\u4f53\u3092\u53c2\u7167\u3057\u3066\u3044\u308b\u304c\u3001\u3053\u306e\u30e1\u30f3\u30d0\u306e\u914d\u7f6e\u304c\u30d0\u30fc\u30b8\u30e7\u30f3\u3054\u3068\u306b\u7570\u306a\u308b\u305f\u3081\u3001\u5b9f\u969b\u306b\u52d5\u3044\u3066\u3044\u308bld-linux.so\u3068\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u5408\u308f\u305b\u308b\u5fc5\u8981\u304c\u3042\u308b\u3068\u3044\u3046\u3002\u305d\u306e\u305f\u3081\u3001glibc\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u5b9f\u6a5f\u306e\u3082\u306e\u306b\u63c3\u3048\u3066\u518d\u30d3\u30eb\u30c9\u3057\u3066\u3001preload\u3057\u305f\u3068\u3053\u308d\u554f\u984c\u306a\u304f\u95a2\u6570\u306e\u30d5\u30c3\u30af\u304c\u6210\u529f\u3057\u305f\u3002\u3053\u306e\u5236\u7d04\u306f\u975e\u5e38\u306b\u554f\u984c\u306a\u306e\u3067\u3001\u30d5\u30c3\u30af\u306b\u5fc5\u8981\u306a\u95a2\u6570\u306e\u4f9d\u5b58\u3092\u8abf\u3079\u90e8\u5206\u7684\u306b\u30ea\u30f3\u30af\u3057\u3066\u3001\u52d5\u7684\u30ea\u30f3\u30ab\u3092\u5fc5\u8981\u3068\u3057\u306a\u3044\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u5236\u4f5c\u3057\u3088\u3046\u3068\u3057\u305f\u304c\u3001\u30d3\u30eb\u30c9\u95a2\u9023\u306e\u8a2d\u5b9a\u304c\u8907\u96d1\u3067\u3042\u3063\u305f\u306e\u3067\u3001\u3072\u3068\u307e\u305aglibc\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u63c3\u3048\u305fVM\u306a\u3069\u306e\u74b0\u5883\u3067\u52d5\u304b\u3059\u3053\u3068\u3067\u5bfe\u5fdc\u3057\u305f\u3002","title":"\u30d3\u30eb\u30c9\u306e\u65b9\u6cd5\u3068\u554f\u984c\u70b9"},{"location":"glibc/blog-ja/#_6","text":"\u203b \u30c6\u30b9\u30c8\u306f\u5b9f\u6a5f\u3067\u884c\u3048\u308b\u304c\u601d\u308f\u306c\u30d0\u30b0\u3092\u751f\u3058\u308b\u53ef\u80fd\u6027\u304c\u3042\u308b\u305f\u3081\u4ee5\u4e0b\u306e\u74b0\u5883\u3092\u69cb\u7bc9\u3057\u305fVM\u4e0a\u3067\u884c\u3046\u3002","title":"\u6319\u52d5\u306e\u30c6\u30b9\u30c8"},{"location":"glibc/blog-ja/#_7","text":"OS: Linux (Debian\u7cfb) Arch: amd64 Libraries: libc6 (= 2.35) (\u4e0a\u306b\u8ff0\u3079\u305f\u7406\u7531\u304b\u3089\u73fe\u72b6\u3067\u306f\u3053\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u306e\u307f) libssl3 (>= 3.0.0)","title":"\u74b0\u5883"},{"location":"glibc/blog-ja/#_8","text":"\u30b7\u30b9\u30c6\u30e0\u306eglibc\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3092\u78ba\u8a8d\u3059\u308b 1 2 3 4 5 6 7 8 9 10 $ /usr/lib/x86_64-linux-gnu/libc.so.6 GNU C Library ( Debian GLIBC 2 .35-3 ) stable release version 2 .35. Copyright ( C ) 2022 Free Software Foundation, Inc. This is free software ; see the source for copying conditions. There is NO warranty ; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. Compiled by GNU CC version 11 .3.0. libc ABIs: UNIQUE IFUNC ABSOLUTE For bug reporting instructions, please see: <http://www.debian.org/Bugs/>. Debian\u30d1\u30c3\u30b1\u30fc\u30b8\u306e\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3068\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3092\u5b9f\u884c\u3059\u308b 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 $ curl -O https://github.com/Sommelier-db/sommelier-drive-glibc/raw/drive/sommelier-drive/sommelier-drive-glibc_1.1_amd64.deb $ dpkg-deb -c sommelier-drive-glibc_1.1_amd64.deb drwxr-xr-x root/root 0 2022 -11-09 04 :38 ./ drwxr-xr-x root/root 0 2022 -11-09 04 :39 ./usr/ drwxr-xr-x root/root 0 2022 -11-09 06 :42 ./usr/bin/ -rwxr-xr-x root/root 16264 2022 -11-09 06 :30 ./usr/bin/sommelier-register -rwxr--r-- root/root 1138 2022 -11-09 06 :42 ./usr/bin/sommelier-run drwxr-xr-x root/root 0 2022 -11-09 04 :47 ./usr/include/ -rw-r--r-- root/root 2372 2022 -11-09 04 :47 ./usr/include/sommelier_drive_client.h drwxr-xr-x root/root 0 2022 -11-09 04 :38 ./usr/lib/ drwxr-xr-x root/root 0 2022 -11-09 06 :42 ./usr/lib/x86_64-linux-gnu/ -rwxr-xr-x root/root 10318664 2022 -11-09 04 :47 ./usr/lib/x86_64-linux-gnu/libsommelier_drive_client.so -rwxr-xr-x root/root 12711832 2022 -11-09 06 :32 ./usr/lib/x86_64-linux-gnu/libsommelier_libc.so $ sudo dpkg -i sommelier-drive-glibc_1.1_amd64.deb","title":"\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb"},{"location":"glibc/blog-ja/#_9","text":"\u7acb\u3061\u4e0a\u3052\u305f\u30c9\u30e9\u30a4\u30d6\u306e\u30b5\u30fc\u30d0\u306b\u5bfe\u3057\u3066\u3001url\u3068\u30ea\u30fc\u30b8\u30e7\u30f3\u540d\u3068\u30db\u30fc\u30e0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30d1\u30b9\u3092\u6307\u5b9a\u3057\u3066\u30e6\u30fc\u30b6\u3092\u767b\u9332\u3059\u308b\u3068\u3001\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30d5\u30a1\u30a4\u30eb\u304c\u751f\u6210\u3055\u308c\u308b\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 $ sommelier-register \"http://localhost:8000/api\" \"region\" \"/alice\" successfully registered. user id is 1 configuration is saved in drive_envs $ cat drive_envs # key to encrypt data print_data_sk () { cat << END_OF_FILE -----BEGIN PRIVATE KEY----- MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQDEvumJhkNvwPzx 1bB52SLrP6wS+DL+l+umOJ0rIsuuwWcbRS7cRejWwN7GYC0og6r0or ~~~~~~~~~~~~~~~~~~~~~~~~ j5WFyup4lgD0uwH9TLXsZj5s13fYs6HhyOBhJyDMbNvkz46Bi0U2kDQvAmiSAmCy ixu5XBCophbUe+H8uevbNQ== -----END PRIVATE KEY----- END_OF_FILE } # key to use for searchable encryption print_keyword_sk () { cat << END_OF_FILE {\"alphas\":[[8781683650687187445,1371472541923046913,15906317983419354644,7861644468431804003], ~~~~~~~~~~~~~~~~~~~~ ,169,67,239,123,187,54,92,20,230,126,253,242,134,179,34,38,135,162,88,13,158,42,195,234,189,122,158,196,206]} END_OF_FILE } # client user id export SOMMELIER_DRIVE_USER_ID = 1 # server to connect to export SOMMELIER_DRIVE_BASE_URL = http://localhost:8000/api # server region export SOMMELIER_DRIVE_REGION_NAME = region # remote home directory export SOMMELIER_DRIVE_HOME_DIR = /alice \u3053\u306e\u30d5\u30a1\u30a4\u30eb\u306b\u30c9\u30e9\u30a4\u30d6\u3078\u306e\u63a5\u7d9a\u306b\u5fc5\u8981\u306a\u30b5\u30fc\u30d0\u306e\u60c5\u5831\u3068\u30012\u7a2e\u985e\u306e\u79d8\u5bc6\u9375\u3092\u542b\u3093\u3060\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306e\u60c5\u5831\u3092\u74b0\u5883\u5909\u6570\u306b\u8a2d\u5b9a\u3059\u308b\u8a18\u8ff0\u304c\u306a\u3055\u308c\u3066\u3044\u308b\u3002","title":"\u30e6\u30fc\u30b6\u30fc\u306e\u767b\u9332"},{"location":"glibc/blog-ja/#_10","text":"\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u30e9\u30c3\u30d1\u30fc\u3068\u306a\u308b sommelier-run \u306f\u4ee5\u4e0b\u306e\u3088\u3046\u306a\u30b9\u30af\u30ea\u30d7\u30c8\u3067\u3042\u308b\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 #!/bin/sh # directory on which files on the remote drive are put export SOMMELIER_DRIVE_BASE_DIR = /tmp/drive rm -rf $SOMMELIER_DRIVE_BASE_DIR mkdir -p $SOMMELIER_DRIVE_BASE_DIR chmod 700 $SOMMELIER_DRIVE_BASE_DIR # whether to trace library calls export SOMMELIER_DRIVE_TRACE = 0 # load server info and user info . $PWD /drive_envs SOMMELIER_DRIVE_DATA_SK = $( mktemp -p $SOMMELIER_DRIVE_BASE_DIR ) print_data_sk > $SOMMELIER_DRIVE_DATA_SK export SOMMELIER_DRIVE_DATA_SK SOMMELIER_DRIVE_KEYWORD_SK = $( mktemp -p $SOMMELIER_DRIVE_BASE_DIR ) print_keyword_sk > $SOMMELIER_DRIVE_KEYWORD_SK export SOMMELIER_DRIVE_KEYWORD_SK # library path of Sommelier Drive API export SOMMELIER_DRIVE_LIBRARY_PATH = /usr/lib/x86_64-linux-gnu/libsommelier_drive_client.so # library to preload for function hooking export LD_PRELOAD = /usr/lib/x86_64-linux-gnu/libsommelier_libc.so # execute privided command exec $@ \u3053\u308c\u306b\u793a\u3059\u901a\u308a\u3001\u30e6\u30fc\u30b6\u767b\u9332\u6642\u306b\u4f5c\u6210\u3057\u305f\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb\u3068\u3001Sommelier Drive\u306eAPI\u3092\u4fdd\u6301\u3059\u308b\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u74b0\u5883\u5909\u6570\u306b\u6307\u5b9a\u3057\u3001LD_PRELOAD\u306b\u4f5c\u6210\u3057\u305f\u95a2\u6570\u30d5\u30c3\u30af\u306e\u305f\u3081\u306elibc\u30e9\u30a4\u30d6\u30e9\u30ea\u3092\u6307\u5b9a\u3057\u3066\u4e0e\u3048\u3089\u308c\u305f\u30b3\u30de\u30f3\u30c9\u3092\u5b9f\u884c\u3059\u308b\u3002 \u3053\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u7528\u3044\u3066\u3001\u30d5\u30a1\u30a4\u30eb\u3092\u6271\u3046\u30b3\u30de\u30f3\u30c9\u3092\u4ee5\u4e0b\u306e\u3088\u3046\u306b\u5b9f\u884c\u3057\u3066\u30c9\u30e9\u30a4\u30d6\u4e0a\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u64cd\u4f5c\u3059\u308b\u3002 1 $ sommelier-run command [ args ] \u5b9f\u969b\u306b\u52d5\u4f5c\u3059\u308b\u6a19\u6e96\u30b3\u30de\u30f3\u30c9\u3092\u3044\u304f\u3064\u304b\u7d39\u4ecb\u3059\u308b\u3002\u307e\u305a\u30d5\u30a1\u30a4\u30eb\u3068\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\u3059\u308b\u3002\u30c9\u30e9\u30a4\u30d6\u4e0a\u306e\u30d1\u30b9\u306f\u5148\u982d\u306b\"sommelier:\"\u3092\u3064\u3051\u3066\u6307\u5b9a\u3059\u308b\u3002 1 2 3 $ sommelier-run touch sommelier:/alice/file1 $ sommelier-run mkdir sommelier:/alice/dir1 \u3053\u308c\u3067\u5b9f\u969b\u306b\u30c9\u30e9\u30a4\u30d6\u4e0a\u306b\u30d5\u30a1\u30a4\u30eb\u3068\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u304c\u4f5c\u6210\u3055\u308c\u305f\u3002cp\u30b3\u30de\u30f3\u30c9\u306b\u3088\u308a\u3001\u30ed\u30fc\u30ab\u30eb-\u30ea\u30e2\u30fc\u30c8\u9593\u3001\u30ea\u30e2\u30fc\u30c8-\u30ea\u30e2\u30fc\u30c8\u9593\u3067\u30d5\u30a1\u30a4\u30eb\u3092\u8907\u88fd\u3067\u304d\u308b\u3053\u3068\u3082\u78ba\u8a8d\u3059\u308b\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 $ echo \"this is a local file\" > localfile $ sommelier-run cp localfile sommelier:/alice/file2 $ sommelier-run cat sommelier:/alice/file2 this is a local file $ sommelier-run cp sommelier:/alice/file2 sommelier:/alice/file3 $ sommelier-run cat sommelier:/alice/file3 this is a local file $ sommelier-run cp sommelier:/alice/file2 remotefile $ cat remotefile this is a local file \u6b21\u306bls\u30b3\u30de\u30f3\u30c9\u306b\u3088\u308a\u30ea\u30e2\u30fc\u30c8\u306b\u4f5c\u6210\u3057\u305f\u30d5\u30a1\u30a4\u30eb\u3068\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u78ba\u8a8d\u3059\u308b\u3002 1 2 3 4 5 6 $ sommelier-run ls -l sommelier:/alice/ total 0 drw------- 0 alice alice 0 Jan 1 1970 dir1 -rw------- 0 alice alice 0 Jan 1 1970 file1 -rw------- 0 alice alice 21 Jan 1 1970 file2 -rw------- 0 alice alice 21 Jan 1 1970 file3 \u30c9\u30e9\u30a4\u30d6\u8a2d\u8a08\u306e\u90fd\u5408\u306b\u3088\u308astat\u3067\u53d6\u5f97\u3059\u308b\u30d5\u30a1\u30a4\u30eb\u306e\u60c5\u5831\u306b\u7a7a\u767d\u304c\u591a\u3044\u305f\u3081\u60c5\u5831\u306e\u8868\u793a\u306f\u3044\u3044\u52a0\u6e1b\u3060\u304c\u3001\u30a8\u30f3\u30c8\u30ea\u3068\u5c5e\u6027\u3001\u30d5\u30a1\u30a4\u30eb\u30b5\u30a4\u30ba\u306e\u8868\u793a\u304c\u3067\u304d\u3066\u3044\u308b\u3053\u3068\u306f\u78ba\u8a8d\u3067\u304d\u308b\u3002 1 $ sommelier-run nano sommelier:/alice/file3 \u6700\u5f8c\u306bnano\u30a8\u30c7\u30a3\u30bf\u3092\u8a66\u3059\u3002 1 $ sommelier-run nano sommelier:/alice/file3 \u30d5\u30a1\u30a4\u30eb\u306e\u7de8\u96c6\u306f\u6ede\u308a\u306a\u304f\u3067\u304d\u308b\u3082\u306e\u306e\u3001Ctrl-S\u3067\u5909\u66f4\u3092\u4fdd\u5b58\u3059\u308b\u306e\u306b\u306f\u304b\u306a\u308a\u6642\u9593\u3092\u8981\u3059\u308b\u3002 1 2 $ sommelier-run cat sommelier:/alice/file3 nano opened","title":"\u30b3\u30de\u30f3\u30c9\u306e\u5b9f\u884c"},{"location":"glibc/blog-ja/#_11","text":"\u4eca\u56de\u3001\u30ab\u30fc\u30cd\u30eb\u30ec\u30d9\u30eb\u3067\u5909\u66f4\u3092\u52a0\u3048\u308b\u4ee3\u308f\u308a\u306b\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u306e\u6319\u52d5\u3092LD_PRELOAD\u3068\u3044\u3046\u74b0\u5883\u5909\u6570\u3092\u7528\u3044\u3066\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3092\u547c\u3076\u95a2\u6570\u3092\u30d5\u30c3\u30af\u3059\u308b\u3068\u3044\u3046\u624b\u6cd5\u3067\u5909\u66f4\u3057\u305f\u304c\u3001\u3053\u306e\u4ed6\u306b\u3082\u95a2\u6570\u306e\u30d5\u30c3\u30af\u306e\u624b\u6cd5\u306f\u3042\u308b\u3088\u3046\u3060\u3002strace\u3084gdb\u3067\u4f7f\u7528\u3055\u308c\u3066\u3044\u308bptrace\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u3092\u7528\u3044\u308b\u3082\u306e\u3082\u3042\u308c\u3070\u3001\u3053\u306e \u8a18\u4e8b \u3067\u7d39\u4ecb\u3055\u308c\u3066\u3044\u308b\u9ad8\u901f\u306b\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u30d5\u30c3\u30af\u3092\u5b9f\u73fe\u3059\u308b\u8208\u5473\u6df1\u3044\u624b\u6cd5\u3082\u5b58\u5728\u3059\u308b\u3002LD_PRELOAD\u3092\u30d5\u30c3\u30af\u306e\u7528\u9014\u3067\u7528\u3044\u308b\u306e\u306f\u3001\u30bd\u30b1\u30c3\u30c8\u901a\u4fe1\u306e\u30e9\u30c3\u30d1\u30fc\u3067\u3088\u304f\u76ee\u306b\u3059\u308b\u3002\u4f8b\u3048\u3070 proxychains \u3068\u3044\u3046\u30c4\u30fc\u30eb\u306fLD_PRELOAD\u306b\u3088\u308a\u901a\u4fe1\u306e\u95a2\u6570\u3092\u30d5\u30c3\u30af\u3057\u3066socks5\u30b5\u30fc\u30d0\u7d4c\u7531\u306b\u3059\u308b\u3002\u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0\u306b\u5bfe\u3059\u308b\u51e6\u7406\u3092\u66f8\u304d\u63db\u3048\u308b\u8a66\u307f\u306f\u4e00\u822c\u7684\u3067\u306a\u3044\u3088\u3046\u3060\u304c\u3001 fakeroot \u306a\u3069\u95a2\u6570\u30d5\u30c3\u30af\u306b\u3088\u308a\u985e\u4f3c\u306e\u3053\u3068\u3092\u884c\u3046\u30c4\u30fc\u30eb\u306f\u3042\u3063\u305f\u305f\u3081\u3001\u4eca\u56de\u6311\u6226\u3059\u308b\u306b\u81f3\u3063\u305f\u3002\u3059\u3067\u306b\u8ff0\u3079\u305f\u30d3\u30eb\u30c9\u4e0a\u306e\u554f\u984c\u306b\u52a0\u3048\u3001\u4e71\u96d1\u306a\u5b9f\u88c5\u306b\u306a\u308a\u8ab2\u984c\u3092\u6b8b\u3059\u7d50\u679c\u3068\u306a\u3063\u305f\u3082\u306e\u306e\u3001\u6700\u4f4e\u9650\u306e\u6a5f\u80fd\u306f\u5b9f\u73fe\u3067\u304d\u305f\u305f\u3081\u3001\u53d6\u308a\u7d44\u307f\u81ea\u4f53\u306b\u306f\u610f\u7fa9\u306f\u3042\u3063\u305f\u3082\u306e\u3068\u611f\u3058\u3066\u3044\u308b\u3002\u672c\u5b9f\u88c5\u306fSommelier Drive\u5b9f\u88c5\u306e\u5ef6\u9577\u3068\u3057\u3066API\u3092\u5229\u7528\u3059\u308b\u4e00\u3064\u306e\u65b9\u91dd\u3068\u3057\u3066\u500b\u4eba\u7684\u306b\u99b4\u67d3\u307f\u306e\u3042\u3063\u305fglibc\u3092\u5909\u66f4\u3059\u308b\u3068\u3044\u3046\u6848\u304b\u3089\u5b9f\u73fe\u3057\u305f\u3082\u306e\u3067\u3042\u308b\u3002\u6a5f\u80fd\u306e\u6539\u5584\u3068\u3044\u3046\u3088\u308a\u500b\u4eba\u5229\u7528\u306e\u958b\u767a\u306b\u8fd1\u3044\u3082\u306e\u3068\u306a\u3063\u305f\u304c\u3001\u666e\u6bb5\u8aad\u3080\u3060\u3051\u3067\u3042\u3063\u305f\u30b3\u30fc\u30c9\u306b\u624b\u3092\u52a0\u3048\u308b\u3053\u3068\u3067\u30aa\u30fc\u30d7\u30f3\u30bd\u30fc\u30b9\u306b\u89e6\u308c\u308b\u3088\u3044\u7d4c\u9a13\u3068\u306a\u3063\u305f\u3002","title":"\u7d42\u308f\u308a\u306b"},{"location":"glibc/blog-ja/#_12","text":"[1] libc.so\u3092\u5dee\u3057\u66ff\u3048\u3066\u30d7\u30ed\u30b0\u30e9\u30e0\u3092\u52d5\u304b\u3059\uff08\u306e\u306f\u7121\u7406\u305d\u3046\uff09 [2] ptrace \u3088\u308a 100 \u500d\u901f\u3044\u30b7\u30b9\u30c6\u30e0\u30b3\u30fc\u30eb\u30d5\u30c3\u30af\u4f5c\u3063\u305f [3] proxychains [4] fakeroot","title":"\u53c2\u8003\u306b\u3057\u305f\u8a18\u4e8b\u3001\u30b5\u30a4\u30c8"},{"location":"glibc/blog/","text":"Access Sommelier Drive with shell commands Author: Nishii Haruki Introduction I aimed to access files and director in Sommelier Drive as well as ones in local file system. I tried to make it possible to create, read and edit them with simple commands run on a terminal such as \"cat\" and \"ls\" without re-compiling them. The simple way to realize this may be implementing original file system like NFS (Network File System) by defining behavior of system calls. However, it should be tough because there are too many system calls to define and testing original file system requires knowledge about how to emulate kernel. Another reason I didn\u2019t choose to build file system was because I couldn\u2019t take advantage of public-key search encryption with kernel level file system. When we search a file whose name we only know, or get all the entries in a directory, we may use commands such as \"find\" and these commands seek it recursively in the directory. But with public-key search encryption algorithm, we only have to generate a trapdoor corresponding to the search criteria, send it to the drive server, and then receive a set of data which matches the criteria. As far as I know, there is no such system call that searches files in an efficient way. Considering this advantage, I decided to create user level pseudo file system by extending glibc (GNU C Library). How to alter behavior of original glibc The reason I extended glibc was because most executables and libraries link libraries of glibc. While most parts of glibc are written in C or assembly language, programs which are written in not only C/C++ but also Rust, Python and several other languages depend heavily on glibc. These programs use malloc/free of libc.so for memory allocation, and open/close/read/write for manipulating files and directories. Therefore, if the behavior of libc.so is altered, the behavior of most programs is also altered without changes in programs themselves as a result, which is called function hooking. One of the techniques to hook functions is using LD_PRELOAD, which is an environment variable for the dynamic linker. If this environment variable is set to a library, functions defined in the library can hook functions originally called by a program. For more details about how it works, you can refer to a manual page of ld.so . I had to alter the source code of glibc so that it can manipulate remote files and directories, build it as my original libc.so and run commands with LD_PRELOAD set to this library. How to alter functions of glibc Then I'm going to explain the example of implementation of my original glibc. When a program opens a file for the purpose of reading, it calls a function of libc.so like open() and fopen() with the file path and flags. I had to alter the behavior of such function so that if the file path is in Sommelier Drive, the function fetches the contents of the file from remote server, copies it to local file system, and then returns a file descriptor of the local file. Another example is that when a program opens a file with creating and writing flags, the open function should check if the file path is remote one, and if so, create a file in the remote drive, and returns a file descriptor of the local file. When the program closes it by calling a function such as close() and fclose(), the function saves the contents of file in the remote drive. Other than these functions, there are several functions to hook in order to enable programs to manipulate files and directories in a remote drive. I investigated what function should be hooked by tracing the execution of programs with tracing tools such as gdb and ltrace. For more detail Sorry, but I have no time to write everything about this attempt. Please refer to Japanese version of this blog.","title":"A user level file system for Sommelier Drive"},{"location":"glibc/blog/#access-sommelier-drive-with-shell-commands","text":"","title":"Access Sommelier Drive with shell commands"},{"location":"glibc/blog/#author-nishii-haruki","text":"","title":"Author: Nishii Haruki"},{"location":"glibc/blog/#introduction","text":"I aimed to access files and director in Sommelier Drive as well as ones in local file system. I tried to make it possible to create, read and edit them with simple commands run on a terminal such as \"cat\" and \"ls\" without re-compiling them. The simple way to realize this may be implementing original file system like NFS (Network File System) by defining behavior of system calls. However, it should be tough because there are too many system calls to define and testing original file system requires knowledge about how to emulate kernel. Another reason I didn\u2019t choose to build file system was because I couldn\u2019t take advantage of public-key search encryption with kernel level file system. When we search a file whose name we only know, or get all the entries in a directory, we may use commands such as \"find\" and these commands seek it recursively in the directory. But with public-key search encryption algorithm, we only have to generate a trapdoor corresponding to the search criteria, send it to the drive server, and then receive a set of data which matches the criteria. As far as I know, there is no such system call that searches files in an efficient way. Considering this advantage, I decided to create user level pseudo file system by extending glibc (GNU C Library).","title":"Introduction"},{"location":"glibc/blog/#how-to-alter-behavior-of-original-glibc","text":"The reason I extended glibc was because most executables and libraries link libraries of glibc. While most parts of glibc are written in C or assembly language, programs which are written in not only C/C++ but also Rust, Python and several other languages depend heavily on glibc. These programs use malloc/free of libc.so for memory allocation, and open/close/read/write for manipulating files and directories. Therefore, if the behavior of libc.so is altered, the behavior of most programs is also altered without changes in programs themselves as a result, which is called function hooking. One of the techniques to hook functions is using LD_PRELOAD, which is an environment variable for the dynamic linker. If this environment variable is set to a library, functions defined in the library can hook functions originally called by a program. For more details about how it works, you can refer to a manual page of ld.so . I had to alter the source code of glibc so that it can manipulate remote files and directories, build it as my original libc.so and run commands with LD_PRELOAD set to this library.","title":"How to alter behavior of original glibc"},{"location":"glibc/blog/#how-to-alter-functions-of-glibc","text":"Then I'm going to explain the example of implementation of my original glibc. When a program opens a file for the purpose of reading, it calls a function of libc.so like open() and fopen() with the file path and flags. I had to alter the behavior of such function so that if the file path is in Sommelier Drive, the function fetches the contents of the file from remote server, copies it to local file system, and then returns a file descriptor of the local file. Another example is that when a program opens a file with creating and writing flags, the open function should check if the file path is remote one, and if so, create a file in the remote drive, and returns a file descriptor of the local file. When the program closes it by calling a function such as close() and fclose(), the function saves the contents of file in the remote drive. Other than these functions, there are several functions to hook in order to enable programs to manipulate files and directories in a remote drive. I investigated what function should be hooked by tracing the execution of programs with tracing tools such as gdb and ltrace.","title":"How to alter functions of glibc"},{"location":"glibc/blog/#for-more-detail","text":"Sorry, but I have no time to write everything about this attempt. Please refer to Japanese version of this blog.","title":"For more detail"}]}